<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lead Hunter</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f3ee;
  --surface: #ffffff;
  --surface2: #f0ede6;
  --border: #e2ddd4;
  --border2: #ccc7bc;
  --accent: #e85d26;
  --accent2: #c44d1a;
  --accent-light: rgba(232,93,38,0.1);
  --text: #1a1714;
  --text-mid: #5a5448;
  --text-dim: #9a9082;
  --green: #1a7a4a;
  --green-bg: #e8f5ee;
  --yellow: #b07800;
  --yellow-bg: #fef3e2;
  --red: #c0392b;
  --red-bg: #fdecea;
  --blue: #2563a8;
  --blue-bg: #e8f0fc;
  --shadow: 0 2px 12px rgba(0,0,0,0.07);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.10);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  min-height: 100vh;
}

/* LAYOUT */
.app { display: flex; min-height: 100vh; }

/* SIDEBAR */
.sidebar {
  width: 300px;
  flex-shrink: 0;
  background: var(--text);
  color: #fff;
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0; left: 0; bottom: 0;
  overflow-y: auto;
  z-index: 200;
}

.sidebar-logo {
  padding: 28px 24px 20px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.sidebar-logo .brand {
  font-size: 1.25rem;
  font-weight: 800;
  letter-spacing: -0.02em;
  color: #fff;
}
.sidebar-logo .brand span { color: var(--accent); }
.sidebar-logo .tagline {
  font-size: 0.72rem;
  color: rgba(255,255,255,0.4);
  margin-top: 3px;
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 0.04em;
}

.sidebar-nav {
  padding: 12px 0;
  flex: 1;
}
.nav-section-label {
  font-size: 0.6rem;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: rgba(255,255,255,0.3);
  padding: 12px 24px 6px;
  font-family: 'JetBrains Mono', monospace;
}
.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 9px 24px;
  cursor: pointer;
  transition: background 0.12s;
  font-size: 0.88rem;
  color: rgba(255,255,255,0.7);
  font-weight: 500;
  border: none;
  background: none;
  width: 100%;
  text-align: left;
}
.nav-item:hover { background: rgba(255,255,255,0.06); color: #fff; }
.nav-item.active { background: rgba(232,93,38,0.18); color: #fff; }
.nav-item.active .nav-icon { color: var(--accent); }
.nav-icon { font-size: 1rem; width: 18px; text-align: center; opacity: 0.9; }
.nav-badge {
  margin-left: auto;
  background: var(--accent);
  color: #fff;
  font-size: 0.6rem;
  font-family: 'JetBrains Mono', monospace;
  padding: 1px 6px;
  border-radius: 10px;
  font-weight: 700;
}

/* MAIN */
.main {
  margin-left: 300px;
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

.topbar {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 16px 36px;
  display: flex;
  align-items: center;
  gap: 16px;
  position: sticky;
  top: 0;
  z-index: 100;
}
.page-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text);
}
.page-subtitle {
  font-size: 0.75rem;
  color: var(--text-dim);
  margin-left: 2px;
}

.content { padding: 32px 36px; flex: 1; }

/* SEARCH BAR */
.search-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px 24px;
  margin-bottom: 28px;
  box-shadow: var(--shadow);
}
.search-box-label {
  font-size: 0.7rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-dim);
  margin-bottom: 10px;
}
.search-row {
  display: flex;
  gap: 12px;
  align-items: center;
}
.search-input {
  flex: 1;
  font-family: 'Outfit', sans-serif;
  font-size: 1rem;
  font-weight: 500;
  padding: 12px 16px;
  border: 2px solid var(--border);
  border-radius: 8px;
  background: var(--bg);
  color: var(--text);
  outline: none;
  transition: border-color 0.15s;
}
.search-input:focus { border-color: var(--accent); }
.search-input::placeholder { color: var(--text-dim); font-weight: 400; }
.search-btn {
  font-family: 'Outfit', sans-serif;
  font-size: 0.9rem;
  font-weight: 700;
  padding: 12px 28px;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.15s, transform 0.1s;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 8px;
}
.search-btn:hover { background: var(--accent2); transform: translateY(-1px); }
.search-btn:active { transform: none; }
.search-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

.search-tags {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 12px;
  align-items: center;
}
.search-tag-label { font-size: 0.72rem; color: var(--text-dim); }
.preset-tag {
  font-size: 0.75rem;
  padding: 4px 12px;
  border: 1px solid var(--border2);
  border-radius: 20px;
  background: var(--surface2);
  color: var(--text-mid);
  cursor: pointer;
  transition: all 0.12s;
  font-family: 'Outfit', sans-serif;
}
.preset-tag:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }

/* SOURCES GRID */
.sources-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}
.sources-title {
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-dim);
}
.sources-controls {
  display: flex;
  align-items: center;
  gap: 10px;
}
.sort-dropdown {
  font-family: 'Outfit', sans-serif;
  font-size: 0.7rem;
  font-weight: 600;
  padding: 5px 10px;
  background: var(--surface);
  border: 1px solid var(--border2);
  color: var(--text-mid);
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.12s;
}
.sort-dropdown:hover { border-color: var(--accent); color: var(--accent); }
.add-source-btn {
  font-family: 'Outfit', sans-serif;
  font-size: 0.78rem;
  font-weight: 600;
  padding: 6px 14px;
  background: var(--surface);
  border: 1px solid var(--border2);
  color: var(--text-mid);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.12s;
}
.add-source-btn:hover { border-color: var(--accent); color: var(--accent); }
.io-btn { font-family: 'Outfit', sans-serif; font-size: 0.78rem; font-weight: 600; padding: 6px 12px; background: var(--surface); border: 1px solid var(--border2); color: var(--text-dim); border-radius: 6px; cursor: pointer; transition: all 0.12s; display:flex; align-items:center; gap:5px; }
.io-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }

.sources-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 14px;
  margin-bottom: 32px;
}

@media (max-width: 768px) {
  .sources-grid {
    grid-template-columns: 1fr;
    gap: 12px;
  }
}

@media (max-width: 480px) {
  .source-card {
    margin: 0 -10px;
  }
  .content {
    padding: 20px 26px;
  }
}

.source-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  box-shadow: var(--shadow);
  transition: box-shadow 0.15s, border-color 0.15s;
}
.source-card:hover { box-shadow: var(--shadow-lg); border-color: var(--border2); }

.source-card-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 14px 16px 10px;
  position: relative;
}
.favorite-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  background: none;
  border: none;
  font-size: 1rem;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: all 0.12s;
  opacity: 0.4;
}
.favorite-btn:hover { opacity: 1; background: rgba(0,0,0,0.05); }
.favorite-btn.active { opacity: 1; color: #f59e0b; }
.login-status-lamp {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  position: absolute;
  top: 10px;
  right: 32px;
  box-shadow: 0 0 4px currentColor;
}
.login-status-lamp.logged-in {
  background: var(--green);
  color: var(--green);
}
.login-status-lamp.logged-out {
  background: var(--red);
  color: var(--red);
}
.login-status-lamp.not-applicable {
  background: var(--yellow);
  color: var(--yellow);
}
.source-icon {
  width: 34px; height: 34px;
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.1rem;
  flex-shrink: 0;
}
.source-info { flex: 1; min-width: 0; }
.source-name {
  font-weight: 700;
  font-size: 0.88rem;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.source-type-badge {
  font-size: 0.6rem;
  font-family: 'JetBrains Mono', monospace;
  padding: 1px 6px;
  border-radius: 3px;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-top: 2px;
  display: inline-block;
}
.badge-forum { background: #e8f0fc; color: #2563a8; }
.badge-social { background: #fde8f0; color: #a8254f; }
.badge-portal { background: #e8f5ee; color: #1a7a4a; }
.badge-ogloszenia { background: #fef3e2; color: #b07800; }
.badge-it { background: #f0e8fc; color: #6a25a8; }
.badge-biznes { background: #e8f5f5; color: #1a7a7a; }

.source-toggle {
  position: relative;
  width: 36px; height: 20px;
  flex-shrink: 0;
}
.source-toggle input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
  position: absolute; inset: 0;
  background: var(--border2);
  border-radius: 20px;
  cursor: pointer;
  transition: background 0.2s;
}
.toggle-slider::before {
  content: '';
  position: absolute;
  width: 14px; height: 14px;
  left: 3px; top: 3px;
  background: #fff;
  border-radius: 50%;
  transition: transform 0.2s;
}
input:checked + .toggle-slider { background: var(--accent); }
input:checked + .toggle-slider::before { transform: translateX(16px); }

.source-card-body {
  padding: 0 16px 14px;
  border-top: 1px solid var(--border);
  display: none;
}
.source-card-body.open { display: block; padding-top: 12px; }

.field-label {
  font-size: 0.65rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-dim);
  margin-bottom: 5px;
  margin-top: 10px;
}
.field-label:first-child { margin-top: 0; }

.field-input {
  width: 100%;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.72rem;
  padding: 7px 10px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg);
  color: var(--text);
  outline: none;
  transition: border-color 0.15s;
}
.field-input:focus { border-color: var(--accent); }
.field-input::placeholder { color: var(--text-dim); }

.keywords-input {
  font-family: 'Outfit', sans-serif;
  font-size: 0.78rem;
  min-height: 60px;
  resize: vertical;
}

.settings-toggle-btn {
  font-family: 'Outfit', sans-serif;
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--text-dim);
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
  display: flex;
  align-items: center;
  gap: 4px;
  transition: color 0.12s;
  width: 100%;
  padding: 8px 16px 4px;
}
.settings-toggle-btn:hover { color: var(--accent); }
.settings-toggle-btn .chevron { transition: transform 0.2s; display: inline-block; }
.settings-toggle-btn.open .chevron { transform: rotate(180deg); }

/* CHECKBOX */
.result-checkbox-wrap {
  flex-shrink: 0;
  width: 20px;
  display: flex;
  align-items: flex-start;
  padding-top: 3px;
}
.result-checkbox {
  width: 17px; height: 17px;
  accent-color: var(--accent);
  cursor: pointer;
  border-radius: 4px;
  flex-shrink: 0;
}
.result-item.selected {
  border-color: var(--accent);
  background: linear-gradient(135deg, #fff 0%, rgba(232,93,38,0.04) 100%);
  box-shadow: 0 0 0 2px rgba(232,93,38,0.15), var(--shadow);
}

/* BULK ACTION BAR */
.bulk-bar {
  position: sticky;
  bottom: 24px;
  left: 0; right: 0;
  margin: 16px 0 0;
  background: var(--text);
  color: #fff;
  border-radius: 12px;
  padding: 12px 20px;
  display: none;
  align-items: center;
  gap: 14px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.25);
  animation: barIn 0.2s ease;
  z-index: 50;
}
.bulk-bar.visible { display: flex; }
@keyframes barIn { from { opacity:0; transform: translateY(12px); } to { opacity:1; transform: none; } }
.bulk-bar-count {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem;
  color: rgba(255,255,255,0.6);
  white-space: nowrap;
}
.bulk-bar-count strong { color: var(--accent); font-size: 1rem; }
.bulk-btn {
  font-family: 'Outfit', sans-serif;
  font-size: 0.78rem;
  font-weight: 600;
  padding: 7px 16px;
  border-radius: 7px;
  cursor: pointer;
  transition: all 0.12s;
  border: 1px solid rgba(255,255,255,0.2);
  background: rgba(255,255,255,0.1);
  color: #fff;
  white-space: nowrap;
}
.bulk-btn:hover { background: rgba(255,255,255,0.18); }
.bulk-btn.accent { background: var(--accent); border-color: var(--accent); }
.bulk-btn.accent:hover { background: var(--accent2); }
.bulk-btn.danger { color: #ff8a7a; border-color: rgba(255,138,122,0.3); }
.bulk-btn.danger:hover { background: rgba(255,59,59,0.15); }
.bulk-bar-sep { width: 1px; height: 24px; background: rgba(255,255,255,0.12); }
.bulk-deselect {
  margin-left: auto;
  background: none; border: none;
  color: rgba(255,255,255,0.4);
  font-size: 1rem;
  cursor: pointer;
  padding: 2px 4px;
  line-height: 1;
  transition: color 0.12s;
}
.bulk-deselect:hover { color: #fff; }

/* select-all row */
.select-all-row {
  display: none;
  align-items: center;
  gap: 10px;
  padding: 6px 0 10px;
  font-size: 0.75rem;
  color: var(--text-dim);
}
.select-all-row.visible { display: flex; }
.select-all-cb { width: 15px; height: 15px; accent-color: var(--accent); cursor: pointer; }
.select-all-label { cursor: pointer; }

/* RESULTS */
.results-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 14px;
  margin-top: 8px;
}
.results-title {
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-dim);
}
.results-meta {
  font-size: 0.72rem;
  color: var(--text-dim);
  font-family: 'JetBrains Mono', monospace;
}

.result-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px 20px;
  margin-bottom: 10px;
  box-shadow: var(--shadow);
  transition: box-shadow 0.15s;
  display: flex;
  gap: 16px;
  align-items: flex-start;
  animation: slideIn 0.25s ease forwards;
}
@keyframes slideIn { from { opacity:0; transform: translateY(6px); } to { opacity:1; transform: none; } }
.result-item:hover { box-shadow: var(--shadow-lg); }

.result-source-icon {
  width: 38px; height: 38px;
  border-radius: 9px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem;
  flex-shrink: 0;
  margin-top: 2px;
}

.result-body { flex: 1; min-width: 0; }
.result-source-label {
  font-size: 0.65rem;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-bottom: 3px;
}
.result-title {
  font-weight: 700;
  font-size: 0.95rem;
  color: var(--text);
  margin-bottom: 5px;
  line-height: 1.35;
}
.result-title a { color: inherit; text-decoration: none; }
.result-title a:hover { color: var(--accent); }
.result-snippet {
  font-size: 0.82rem;
  color: var(--text-mid);
  line-height: 1.55;
  margin-bottom: 8px;
}
.result-snippet mark {
  background: rgba(232,93,38,0.15);
  color: var(--accent2);
  border-radius: 2px;
  padding: 0 2px;
  font-weight: 600;
}
.result-footer {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}
.result-date {
  font-size: 0.65rem;
  color: var(--text-dim);
  font-family: 'JetBrains Mono', monospace;
}
.result-keyword-tag {
  font-size: 0.62rem;
  padding: 2px 8px;
  background: var(--accent-light);
  color: var(--accent2);
  border-radius: 10px;
  font-weight: 600;
  border: 1px solid rgba(232,93,38,0.2);
}
.result-actions { margin-left: auto; display: flex; gap: 6px; }
.result-btn {
  font-family: 'Outfit', sans-serif;
  font-size: 0.68rem;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.12s;
  border: 1px solid var(--border2);
  background: var(--surface2);
  color: var(--text-mid);
}
.result-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
.result-btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
.result-btn.primary:hover { background: var(--accent2); border-color: var(--accent2); }

.relevance-bar {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-shrink: 0;
  margin-top: 4px;
}
.relevance-label { font-size: 0.62rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }
.relevance-track {
  width: 50px; height: 5px;
  background: var(--border);
  border-radius: 3px;
  overflow: hidden;
}
.relevance-fill {
  height: 100%;
  border-radius: 3px;
  background: linear-gradient(90deg, #f59e0b, var(--accent));
}

/* EMPTY STATE */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-dim);
}
.empty-state .icon { font-size: 3rem; margin-bottom: 14px; opacity: 0.4; }
.empty-state h3 { font-size: 1rem; font-weight: 700; color: var(--text-mid); margin-bottom: 6px; }
.empty-state p { font-size: 0.82rem; line-height: 1.6; }

/* PROGRESS */
.progress-bar {
  height: 3px;
  background: var(--border);
  border-radius: 2px;
  overflow: hidden;
  margin-bottom: 20px;
  display: none;
}
.progress-bar.active { display: block; }
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), #f59e0b);
  border-radius: 2px;
  animation: progressAnim 2s ease-in-out infinite;
}
@keyframes progressAnim {
  0% { width: 5%; margin-left: 0; }
  50% { width: 40%; margin-left: 30%; }
  100% { width: 5%; margin-left: 95%; }
}

/* MODAL / OVERLAY */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 500;
  display: none;
  align-items: center;
  justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--surface);
  border-radius: 14px;
  padding: 28px 32px;
  width: 480px;
  max-width: 95vw;
  box-shadow: var(--shadow-lg);
  animation: modalIn 0.2s ease;
}
@keyframes modalIn { from { opacity:0; transform: scale(0.96); } to { opacity:1; transform: none; } }
.modal-title { font-size: 1.1rem; font-weight: 800; margin-bottom: 4px; }
.modal-sub { font-size: 0.78rem; color: var(--text-dim); margin-bottom: 20px; }
.modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
.btn-cancel {
  font-family: 'Outfit', sans-serif;
  font-size: 0.85rem; font-weight: 600;
  padding: 9px 18px;
  border: 1px solid var(--border2);
  background: var(--surface2);
  color: var(--text-mid);
  border-radius: 7px; cursor: pointer;
  transition: all 0.12s;
}
.btn-cancel:hover { border-color: var(--text); color: var(--text); }
.btn-save {
  font-family: 'Outfit', sans-serif;
  font-size: 0.85rem; font-weight: 700;
  padding: 9px 22px;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 7px; cursor: pointer;
  transition: background 0.12s;
}
.btn-save:hover { background: var(--accent2); }

.form-row { margin-bottom: 14px; }
.form-label { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-dim); margin-bottom: 6px; display: block; }
.form-input {
  width: 100%;
  font-family: 'Outfit', sans-serif;
  font-size: 0.88rem;
  padding: 9px 12px;
  border: 1px solid var(--border);
  border-radius: 7px;
  background: var(--bg);
  color: var(--text);
  outline: none;
  transition: border-color 0.15s;
}
.form-input:focus { border-color: var(--accent); }
.form-select {
  width: 100%;
  font-family: 'Outfit', sans-serif;
  font-size: 0.88rem;
  padding: 9px 12px;
  border: 1px solid var(--border);
  border-radius: 7px;
  background: var(--bg);
  color: var(--text);
  outline: none;
  cursor: pointer;
}

/* SUBFORUM LIST */
.subforum-list { display: flex; flex-direction: column; gap: 6px; margin-bottom: 4px; }
.subforum-row {
  display: flex;
  gap: 6px;
  align-items: center;
  animation: slideIn 0.18s ease;
}
.subforum-row .field-input {
  flex: 1;
  margin: 0;
  font-size: 0.7rem;
  padding: 6px 9px;
}
.subforum-remove {
  flex-shrink: 0;
  width: 26px; height: 26px;
  border-radius: 5px;
  border: 1px solid var(--border2);
  background: var(--surface2);
  color: var(--text-dim);
  font-size: 0.85rem;
  line-height: 1;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.12s;
}
.subforum-remove:hover { background: var(--red-bg); border-color: rgba(192,57,43,0.3); color: var(--red); }
.subforum-add-btn {
  font-family: 'Outfit', sans-serif;
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--accent);
  background: var(--accent-light);
  border: 1px dashed rgba(232,93,38,0.35);
  border-radius: 5px;
  padding: 5px 10px;
  cursor: pointer;
  transition: all 0.12s;
  width: 100%;
  text-align: left;
  margin-top: 2px;
}
.subforum-add-btn:hover { background: rgba(232,93,38,0.15); border-color: var(--accent); }
.subforum-count {
  font-size: 0.6rem;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text-dim);
  margin-left: 4px;
}


::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

/* STATS STRIP */
.stats-strip {
  display: flex;
  gap: 0;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 28px;
  box-shadow: var(--shadow);
}
.stat-item {
  flex: 1;
  padding: 14px 18px;
  border-right: 1px solid var(--border);
  text-align: center;
}
.stat-item:last-child { border-right: none; }
.stat-val {
  font-family: 'JetBrains Mono', monospace;
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--text);
}
.stat-val.orange { color: var(--accent); }
.stat-lbl { font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 2px; }

/* SAVED */
.saved-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 0.62rem;
  padding: 2px 7px;
  background: var(--green-bg);
  color: var(--green);
  border-radius: 10px;
  font-weight: 600;
  border: 1px solid rgba(26,122,74,0.2);
}

/* SOURCES MANAGE VIEW TOGGLE */
.manage-topbar {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 18px; gap: 12px; flex-wrap: wrap;
}
.manage-topbar-left { display: flex; align-items: center; gap: 10px; }
.manage-topbar-right { 
  display: flex; align-items: center; gap: 10px; 
  flex-wrap: wrap;
}
.manage-count {
  font-size: 0.72rem; font-family: 'JetBrains Mono', monospace;
  color: var(--text-dim); background: var(--surface2);
  border: 1px solid var(--border); border-radius: 5px; padding: 3px 10px;
}

@media (max-width: 768px) {
  .manage-topbar {
    flex-direction: column;
    align-items: stretch;
  }
  .manage-topbar-left,
  .manage-topbar-right {
    justify-content: center;
    flex-wrap: wrap;
  }
  .manage-view-toggle {
    order: -1;
  }
}
.manage-view-toggle {
  display: flex; border: 1px solid var(--border2); border-radius: 6px; overflow: hidden;
}
.manage-view-btn {
  font-family: 'Outfit', sans-serif; font-size: 0.7rem; font-weight: 600;
  padding: 6px 13px; background: transparent; border: none;
  color: var(--text-dim); cursor: pointer; transition: all 0.12s;
  display: flex; align-items: center; gap: 5px;
  text-transform: uppercase; letter-spacing: 0.05em;
}
.manage-view-btn + .manage-view-btn { border-left: 1px solid var(--border2); }
.manage-view-btn:hover { color: var(--text); background: var(--surface2); }
.manage-view-btn.active { color: var(--accent); background: var(--accent-light); }

/* SOURCES LIST TABLE */
.sources-list-table {
  width: 100%; border-collapse: collapse;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; overflow: hidden; box-shadow: var(--shadow);
  font-size: 0.82rem;
}
.sources-table-wrapper {
  overflow-x: auto;
  max-width: 100%;
  -webkit-overflow-scrolling: touch;
}
.sources-list-table thead tr { background: var(--surface2); border-bottom: 1px solid var(--border); }
.sources-list-table th {
  text-align: left; padding: 8px 12px;
  font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.1em;
  color: var(--text-dim); font-weight: 600; white-space: nowrap;
  position: sticky; top: 0; background: var(--surface2); z-index: 10;
}
.sources-list-table tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; }
.sources-list-table tbody tr:last-child { border-bottom: none; }
.sources-list-table tbody tr:hover { background: var(--bg); }
.sources-list-table td { padding: 8px 12px; vertical-align: middle; font-size: 0.78rem; }

/* Responsive behavior */
@media (max-width: 1400px) {
  .sources-list-table th:nth-child(4),
  .sources-list-table td:nth-child(4) {
    display: none; /* Ukryj kolumnƒô s≈Ç√≥w kluczowych */
  }
}

@media (max-width: 1200px) {
  .sources-list-table th:nth-child(5),
  .sources-list-table td:nth-child(5) {
    display: none; /* Ukryj kolumnƒô silnika */
  }
  .sources-list-table th,
  .sources-list-table td {
    padding: 6px 8px;
    font-size: 0.75rem;
  }
}

@media (max-width: 1000px) {
  .sources-list-table th:nth-child(3),
  .sources-list-table td:nth-child(3) {
    display: none; /* Ukryj kolumnƒô podfora */
  }
}

@media (max-width: 800px) {
  .sources-list-table th,
  .sources-list-table td {
    padding: 4px 6px;
    font-size: 0.7rem;
  }
  .slt-name {
    font-size: 0.75rem;
  }
  .source-type-badge {
    font-size: 0.55rem;
    padding: 1px 4px;
  }
}

@media (max-width: 600px) {
  .sources-table-wrapper {
    margin: 0 -16px;
  }
  .sources-list-table {
    border-radius: 0;
  }
}
.slt-icon { width: 32px; height: 32px; border-radius: 7px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
.slt-name { font-weight: 700; color: var(--text); }
.slt-url-chip {
  font-size: 0.62rem; font-family: 'JetBrains Mono', monospace;
  color: var(--blue); background: var(--blue-bg); border-radius: 3px;
  padding: 2px 7px; display: inline-block;
  max-width: 240px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.slt-url-empty { font-size: 0.65rem; color: var(--text-dim); font-style: italic; }
.slt-url-more { font-size: 0.6rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; margin-left: 4px; }
.slt-keywords { font-size: 0.7rem; color: var(--text-mid); max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.slt-edit-btn {
  font-family: 'Outfit', sans-serif; font-size: 0.68rem; font-weight: 600;
  padding: 4px 11px; border: 1px solid var(--border2); border-radius: 5px;
  background: var(--surface2); color: var(--text-mid); cursor: pointer; transition: all 0.12s;
}
.slt-edit-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
.source-base-url {
  font-size: 0.6rem;
  font-family: 'JetBrains Mono', monospace;
  color: var(--blue);
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 3px;
  margin-top: 3px;
  opacity: 0.8;
  transition: opacity 0.12s;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 160px;
}
.source-base-url:hover { opacity: 1; text-decoration: underline; }

.slt-settings-inner { padding: 12px 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; max-width: 640px; }

/* CARD SUBFORUM CHIPS */
.card-subforums {
  display: flex; flex-direction: column; gap: 4px;
  padding: 6px 14px 10px;
  border-top: 1px solid var(--border);
}
.card-subforum-chip {
  font-size: 0.62rem; font-family: 'JetBrains Mono', monospace;
  color: var(--blue); background: var(--blue-bg); border-radius: 4px;
  padding: 3px 8px; text-decoration: none; overflow: hidden;
  text-overflow: ellipsis; white-space: nowrap;
  transition: background 0.12s, color 0.12s; display: block;
}
.card-subforum-chip:hover { background: #d0e4fb; color: #1a4fa8; }

/* ENGINE SELECT */
.engine-select {
  width: 100%; font-family: 'JetBrains Mono', monospace; font-size: 0.72rem;
  padding: 6px 9px; border: 1px solid var(--border); border-radius: 6px;
  background: var(--bg); color: var(--text); outline: none; cursor: pointer;
  transition: border-color 0.15s;
}
.engine-select:focus { border-color: var(--accent); }
.engine-badge {
  font-size: 0.58rem; font-family: 'JetBrains Mono', monospace;
  padding: 1px 6px; border-radius: 3px; text-transform: uppercase;
  letter-spacing: 0.05em; margin-left: 4px; vertical-align: middle;
  background: rgba(0,0,0,0.06); color: var(--text-dim);
}

/* LOGIN BUTTON */
.login-btn {
  display: flex; align-items: center; gap: 7px;
  font-family: 'Outfit', sans-serif; font-size: 0.75rem; font-weight: 600;
  padding: 6px 14px; border-radius: 7px; cursor: pointer;
  border: 1px solid var(--border2); background: var(--surface);
  color: var(--text-mid); transition: all 0.15s; white-space: nowrap;
}
.login-btn:hover { border-color: var(--accent); color: var(--accent); }
.login-lamp {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
  position: relative;
}
.login-lamp::after {
  content: ''; position: absolute; inset: -3px; border-radius: 50%;
  opacity: 0.35; animation: lpulse 2s ease-in-out infinite;
}
@keyframes lpulse { 0%,100%{transform:scale(1);opacity:0.35} 50%{transform:scale(1.7);opacity:0.1} }
.lamp-logged-out { background: var(--red); box-shadow: 0 0 6px var(--red); }
.lamp-logged-out::after { background: var(--red); }
.lamp-logged-in  { background: var(--green); box-shadow: 0 0 6px var(--green); }
.lamp-logged-in::after  { background: var(--green); }

/* LOGIN MODAL */
.login-modal { width: 400px; }
.login-user-row {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 14px; background: var(--green-bg);
  border: 1px solid rgba(26,122,74,0.2); border-radius: 8px; margin-bottom: 4px;
}
.login-avatar {
  width: 36px; height: 36px; border-radius: 50%;
  background: var(--green); color: #fff;
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 0.9rem; flex-shrink: 0;
}
.login-user-name { font-weight: 700; font-size: 0.88rem; color: var(--text); }
.login-user-email { font-size: 0.7rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }

/* SOURCE LOGIN BUTTON */
.src-login-btn {
  display: inline-flex; align-items: center; gap: 5px;
  font-family: 'Outfit', sans-serif; font-size: 0.65rem; font-weight: 600;
  padding: 3px 9px; border-radius: 5px; cursor: pointer;
  border: 1px solid var(--border2); background: var(--surface2);
  color: var(--text-dim); transition: all 0.12s; white-space: nowrap;
}
.src-login-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
.src-login-btn.logged-in { border-color: rgba(26,122,74,0.35); background: var(--green-bg); color: var(--green); }
.src-login-btn.logged-in:hover { border-color: var(--red); background: var(--red-bg); color: var(--red); }
.src-lamp { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.src-lamp.on  { background: var(--green); box-shadow: 0 0 4px var(--green); }
.src-lamp.off { background: var(--text-dim); }

/* CREDENTIALS PAGE */
.creds-table { width: 100%; border-collapse: collapse; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; box-shadow: var(--shadow); }
.creds-table thead tr { background: var(--surface2); border-bottom: 1px solid var(--border); }
.creds-table th { text-align: left; padding: 10px 14px; font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-dim); font-weight: 600; }
.creds-table tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; }
.creds-table tbody tr:last-child { border-bottom: none; }
.creds-table tbody tr:hover { background: var(--bg); }
.creds-table td { padding: 10px 14px; vertical-align: middle; font-size: 0.82rem; }
.creds-source-name { font-weight: 700; color: var(--text); }
.creds-login-val { font-family: 'JetBrains Mono', monospace; font-size: 0.72rem; color: var(--text-mid); }
.creds-pass-val { font-family: 'JetBrains Mono', monospace; font-size: 0.72rem; color: var(--text-dim); letter-spacing: 0.1em; }
.creds-empty { color: var(--text-dim); font-style: italic; font-size: 0.72rem; }
.creds-status { display: inline-flex; align-items: center; gap: 5px; font-size: 0.7rem; font-weight: 600; }
.creds-status.set { color: var(--green); }
.creds-status.unset { color: var(--text-dim); }
.creds-edit-btn { font-family: 'Outfit', sans-serif; font-size: 0.68rem; font-weight: 600; padding: 4px 10px; border: 1px solid var(--border2); border-radius: 5px; background: var(--surface2); color: var(--text-mid); cursor: pointer; transition: all 0.12s; }
.creds-edit-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
.creds-clear-btn { font-family: 'Outfit', sans-serif; font-size: 0.68rem; font-weight: 600; padding: 4px 10px; border: 1px solid transparent; border-radius: 5px; background: transparent; color: var(--text-dim); cursor: pointer; transition: all 0.12s; }
.creds-clear-btn:hover { border-color: rgba(192,57,43,0.3); color: var(--red); background: var(--red-bg); }
.creds-topbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px; }
.creds-notice { background: var(--yellow-bg); border: 1px solid rgba(176,120,0,0.25); border-radius: 8px; padding: 10px 14px; font-size: 0.75rem; color: var(--yellow); margin-bottom: 16px; display: flex; align-items: flex-start; gap: 8px; }
.creds-notice-icon { flex-shrink: 0; font-size: 0.9rem; margin-top: 1px; }
.creds-group-header td { background: var(--surface2); padding: 6px 14px; border-top: 2px solid var(--border2); border-bottom: 1px solid var(--border); }
.creds-group-header:first-child td { border-top: none; }
.creds-group-label { font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-dim); }
.creds-group-count { display: inline-flex; align-items: center; justify-content: center; margin-left: 7px; background: var(--border2); color: var(--text-dim); font-size: 0.6rem; font-weight: 700; min-width: 18px; height: 18px; padding: 0 5px; border-radius: 9px; }
.creds-group-header.status-set .creds-group-label { color: var(--green); }
.creds-group-header.status-unset .creds-group-label { color: var(--text-dim); }

/* SOURCE SEARCH MODAL */
.src-search-modal { width: 680px; max-height: 88vh; display: flex; flex-direction: column; }
.src-search-modal .modal-body { flex: 1; overflow-y: auto; padding-right: 4px; }
.query-builder { background: var(--surface2); border: 1px solid var(--border2); border-radius: 10px; padding: 14px 16px; font-size: 0.82rem; color: var(--text-mid); line-height: 2.2; display: flex; flex-wrap: wrap; align-items: center; gap: 6px; }
.query-keyword-input { font-family: 'Outfit', sans-serif; font-size: 0.82rem; font-weight: 600; padding: 4px 10px; border: 2px solid var(--accent); border-radius: 6px; background: var(--surface); color: var(--text); min-width: 180px; flex: 1; outline: none; }
.query-builder-actions { display: flex; gap: 8px; margin-top: 12px; }
.src-search-go-btn { font-family: 'Outfit', sans-serif; font-size: 0.78rem; font-weight: 700; padding: 8px 18px; background: var(--accent); border: none; color: #fff; border-radius: 7px; cursor: pointer; transition: opacity 0.12s; }
.src-search-go-btn:hover { opacity: 0.88; }
.src-search-copy-btn { font-family: 'Outfit', sans-serif; font-size: 0.78rem; font-weight: 600; padding: 8px 14px; background: var(--surface2); border: 1px solid var(--border2); color: var(--text-mid); border-radius: 7px; cursor: pointer; transition: all 0.12s; }
.src-search-copy-btn:hover { border-color: var(--accent); color: var(--accent); }
.src-search-divider { display: flex; align-items: center; gap: 10px; margin: 18px 0 10px; color: var(--text-dim); font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; }
.src-search-divider::before,.src-search-divider::after { content:''; flex:1; height:1px; background:var(--border); }
.src-paste-area { width:100%; min-height:90px; max-height:150px; resize:vertical; font-family:'JetBrains Mono',monospace; font-size:0.72rem; padding:10px 12px; border:1px solid var(--border2); border-radius:8px; background:var(--surface2); color:var(--text); box-sizing:border-box; line-height:1.6; }
.src-paste-area:focus { outline:none; border-color:var(--accent); }
.src-analyze-btn { font-family:'Outfit',sans-serif; font-size:0.75rem; font-weight:700; padding:7px 16px; background:var(--surface2); border:1px solid var(--border2); color:var(--text-mid); border-radius:7px; cursor:pointer; transition:all 0.12s; margin-top:8px; }
.src-analyze-btn:hover { border-color:var(--accent); color:var(--accent); }
.src-results-list { display:flex; flex-direction:column; gap:8px; margin-top:14px; }
.src-result-card { display:flex; align-items:flex-start; gap:12px; background:var(--surface2); border:1px solid var(--border); border-radius:9px; padding:11px 14px; transition:border-color 0.12s; }
.src-result-card:hover { border-color:var(--border2); }
.src-result-info { flex:1; min-width:0; }
.src-result-name { font-weight:700; font-size:0.85rem; color:var(--text); margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.src-result-url  { font-family:'JetBrains Mono',monospace; font-size:0.63rem; color:var(--accent); margin-bottom:5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.src-result-desc { font-size:0.74rem; color:var(--text-dim); line-height:1.5; }
.src-result-add  { flex-shrink:0; font-family:'Outfit',sans-serif; font-size:1rem; font-weight:700; width:30px; height:30px; border-radius:7px; border:2px solid var(--accent); background:var(--accent-light); color:var(--accent); cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.12s; margin-top:1px; }
.src-result-add:hover { background:var(--accent); color:#fff; }
.src-result-add.added { background:var(--green-bg); border-color:var(--green); color:var(--green); cursor:default; font-size:0.8rem; }
.search-source-btn { font-family:'Outfit',sans-serif; font-size:0.78rem; font-weight:600; padding:6px 12px; background:var(--surface); border:1px solid var(--border2); color:var(--text-dim); border-radius:6px; cursor:pointer; transition:all 0.12s; }
.search-source-btn:hover { border-color:var(--accent); color:var(--accent); background:var(--accent-light); }

/* KEYWORDS PAGE */
.kw-card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 16px; }
.kw-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); display: flex; flex-direction: column; }
.kw-card-header { display: flex; align-items: center; justify-content: space-between; padding: 13px 16px; border-bottom: 1px solid var(--border); gap: 10px; }
.kw-card-name { font-weight: 700; font-size: 0.9rem; color: var(--text); flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.kw-card-actions { display: flex; gap: 5px; flex-shrink: 0; }
.kw-card-body { padding: 12px 16px; display: flex; flex-direction: column; gap: 12px; }
.kw-section-label { font-size: 0.62rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-dim); margin-bottom: 7px; }
.kw-phrases { display: flex; flex-wrap: wrap; gap: 5px; }
.kw-phrase { display: inline-block; background: var(--accent-light); color: var(--accent); border: 1px solid rgba(232,93,38,0.2); border-radius: 20px; font-size: 0.7rem; font-weight: 600; padding: 3px 10px; }
.kw-phrase-more { background: var(--surface2); color: var(--text-dim); border-color: var(--border2); }
.kw-link-row { display: flex; align-items: center; gap: 8px; padding: 4px 0; }
.kw-link-name { font-size: 0.78rem; font-weight: 600; color: var(--text); flex: 1; }
.kw-link-sub { font-size: 0.62rem; font-family: 'JetBrains Mono', monospace; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 130px; }
.kw-no-links { font-size: 0.72rem; color: var(--text-dim); font-style: italic; }
/* KW MODAL */
.kw-modal { width: 560px; max-height: 85vh; display: flex; flex-direction: column; }
.kw-modal .modal-body { flex: 1; overflow-y: auto; padding: 0 4px; }
.kw-source-picker { max-height: 260px; overflow-y: auto; border: 1px solid var(--border2); border-radius: 8px; background: var(--surface2); }
.kw-source-row { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.1s; }
.kw-source-row:last-child { border-bottom: none; }
.kw-source-row:hover { background: var(--bg); }
.kw-source-row input[type=checkbox] { width: 15px; height: 15px; accent-color: var(--accent); cursor: pointer; flex-shrink: 0; }
.kw-src-name { font-size: 0.8rem; font-weight: 600; flex: 1; }
.kw-sub-select { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; padding: 3px 7px; border: 1px solid var(--border2); border-radius: 5px; background: var(--surface); color: var(--text-mid); max-width: 170px; }
.kw-phrases-textarea { width: 100%; min-height: 110px; resize: vertical; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; padding: 10px 12px; border: 1px solid var(--border2); border-radius: 8px; background: var(--surface2); color: var(--text); box-sizing: border-box; line-height: 1.6; }
.kw-phrases-textarea:focus { outline: none; border-color: var(--accent); }
.kw-hint { font-size: 0.65rem; color: var(--text-dim); margin-top: 4px; }
.add-kwset-btn { font-family: 'Outfit', sans-serif; font-size: 0.78rem; font-weight: 600; padding: 6px 14px; background: var(--surface); border: 1px solid var(--border2); color: var(--text-mid); border-radius: 6px; cursor: pointer; transition: all 0.12s; }
.add-kwset-btn:hover { border-color: var(--accent); color: var(--accent); }

/* ENGINES PAGE */
.engines-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px; }
.engine-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); }
.engine-card-header { display: flex; align-items: center; gap: 12px; padding: 14px 16px; border-bottom: 1px solid var(--border); }
.engine-card-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.engine-card-name { font-weight: 700; font-size: 0.88rem; flex: 1; }
.engine-card-count { font-size: 0.68rem; font-weight: 700; background: var(--border2); color: var(--text-dim); padding: 2px 8px; border-radius: 9px; }
.engine-source-list { padding: 6px 0; }
.engine-source-row { display: flex; align-items: center; gap: 10px; padding: 7px 16px; transition: background 0.1s; }
.engine-source-row:hover { background: var(--bg); }
.engine-source-icon { width: 26px; height: 26px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; flex-shrink: 0; }
.engine-source-name { flex: 1; font-size: 0.8rem; font-weight: 600; color: var(--text); }
.engine-source-url  { font-size: 0.62rem; font-family: 'JetBrains Mono', monospace; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; }
.engine-source-status { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.engine-source-status.on  { background: var(--green); box-shadow: 0 0 4px var(--green); }
.engine-source-status.off { background: var(--text-dim); }
.engine-empty { padding: 18px 16px; font-size: 0.75rem; color: var(--text-dim); font-style: italic; }
.clone-btn { font-family: 'Outfit', sans-serif; font-size: 0.65rem; font-weight: 600; padding: 3px 8px; border: 1px solid var(--border2); border-radius: 5px; background: transparent; color: var(--text-dim); cursor: pointer; transition: all 0.12s; white-space: nowrap; }
.clone-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }

/* SOURCE CRED MODAL */
.src-cred-modal { width: 420px; }
.src-cred-source-info { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--surface2); border-radius: 8px; margin-bottom: 16px; }
.src-cred-icon { width: 34px; height: 34px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; }
.src-cred-name { font-weight: 700; font-size: 0.9rem; }
.src-cred-url  { font-size: 0.65rem; font-family: 'JetBrains Mono', monospace; color: var(--text-dim); }
.pass-toggle-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-dim); font-size: 0.75rem; padding: 2px 4px; }
.pass-input-wrap { position: relative; }
.pass-input-wrap .form-input { padding-right: 40px; }
</style>

</head>
<body>

<div class="app">

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="brand">LEAD<span>‚óè</span>HUNTER</div>
    <div class="tagline">client discovery engine</div>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section-label">Nawigacja</div>
    <button class="nav-item active" onclick="showPage('search')">
      <span class="nav-icon">üîç</span> Szukaj klient√≥w
    </button>
    <button class="nav-item" onclick="showPage('saved')">
      <span class="nav-icon">üîñ</span> Zapisane leady
      <span class="nav-badge" id="saved-count">0</span>
    </button>
    <button class="nav-item" onclick="showPage('sources')">
      <span class="nav-icon">‚öôÔ∏è</span> ZarzƒÖdzaj ≈∫r√≥d≈Çami
    </button>
    <button class="nav-item" onclick="showPage('keywords')">
      <span class="nav-icon">üè∑Ô∏è</span> Frazy i s≈Çowa kluczowe
    </button>
    <button class="nav-item" onclick="showPage('engines')">
      <span class="nav-icon">üîé</span> Silniki wyszukiwa≈Ñ
    </button>
    <button class="nav-item" onclick="showPage('credentials')">
      <span class="nav-icon">üîê</span> Loginy do ≈∫r√≥de≈Ç
      <span class="nav-badge" id="creds-count" style="display:none">0</span>
    </button>

    <div class="nav-section-label" style="margin-top:8px">Szybkie zapytania</div>
    <button class="nav-item" onclick="quickSearch('szukam szkole≈Ñ')">
      <span class="nav-icon">üìö</span> Szkolenia
    </button>
    <button class="nav-item" onclick="quickSearch('szukam dostawcy artyku≈Ç√≥w biurowych')">
      <span class="nav-icon">üñäÔ∏è</span> Art. biurowe
    </button>
    <button class="nav-item" onclick="quickSearch('szukam programisty freelancer')">
      <span class="nav-icon">üíª</span> IT / Dev
    </button>
    <button class="nav-item" onclick="quickSearch('polecacie agencjƒô marketingowƒÖ')">
      <span class="nav-icon">üì£</span> Marketing
    </button>
    <button class="nav-item" onclick="quickSearch('szukam ksiegowej rachunkowo≈õƒá')">
      <span class="nav-icon">üìä</span> Ksiƒôgowo≈õƒá
    </button>
  </nav>
</aside>

<!-- MAIN -->
<main class="main">
  <div class="topbar">
    <div>
      <div class="page-title" id="page-title">Szukaj klient√≥w</div>
      <div class="page-subtitle" id="page-subtitle">Przeszukuj fora i serwisy spo≈Çeczno≈õciowe</div>
    </div>
    <button class="login-btn" id="login-btn" onclick="openLoginModal()">
      <div class="login-lamp lamp-logged-out" id="login-lamp"></div>
      <span id="login-btn-label">Zaloguj siƒô</span>
    </button>
  </div>

  <div class="content">

    <!-- PAGE: SEARCH -->
    <div id="page-search">
      <!-- Search box -->
      <div class="search-box">
        <div class="search-box-label">Czego szukajƒÖ Twoi klienci?</div>
        <div class="search-row">
          <input type="text" class="search-input" id="main-query"
            placeholder="np. szukam szkole≈Ñ z Excela, potrzebujƒô dostawcy papieru..."
            onkeydown="if(event.key==='Enter') doSearch()" />
          <button class="search-btn" onclick="doSearch()" id="search-btn">
            <span id="search-btn-icon">üîç</span> Szukaj
          </button>
        </div>
        <div class="search-tags">
          <span class="search-tag-label">Przyk≈Çady:</span>
          <span class="preset-tag" onclick="setQuery('szukam szkole≈Ñ z Excela')">Szkolenia Excel</span>
          <span class="preset-tag" onclick="setQuery('potrzebujƒô artyku≈Ç√≥w biurowych hurt')">Art. biurowe</span>
          <span class="preset-tag" onclick="setQuery('polecacie programistƒô PHP freelancer')">PHP dev</span>
          <span class="preset-tag" onclick="setQuery('szukam agencji SEO dla firmy')">Agencja SEO</span>
          <span class="preset-tag" onclick="setQuery('potrzebujƒô t≈Çumacza angielski')">T≈Çumacz</span>
          <span class="preset-tag" onclick="setQuery('szukam dostawcy kawy do biura')">Kawa do biura</span>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-strip" id="stats-strip" style="display:none">
        <div class="stat-item">
          <div class="stat-val orange" id="stat-results">0</div>
          <div class="stat-lbl">Wynik√≥w</div>
        </div>
        <div class="stat-item">
          <div class="stat-val" id="stat-sources">0</div>
          <div class="stat-lbl">≈πr√≥de≈Ç</div>
        </div>
        <div class="stat-item">
          <div class="stat-val" id="stat-hot">0</div>
          <div class="stat-lbl">Hot leads</div>
        </div>
        <div class="stat-item">
          <div class="stat-val" id="stat-saved">0</div>
          <div class="stat-lbl">Zapisanych</div>
        </div>
      </div>

      <!-- Progress -->
      <div class="progress-bar" id="progress-bar"><div class="progress-fill"></div></div>

      <!-- Sources quick toggle -->
      <div id="sources-container"></div>

      <!-- Results -->
      <div id="results-section" style="display:none">
        <div class="results-header">
          <div class="results-title" id="results-title">Wyniki</div>
          <div class="results-meta" id="results-meta"></div>
        </div>
        <div class="select-all-row" id="select-all-row">
          <input type="checkbox" class="select-all-cb" id="select-all-cb" onchange="toggleSelectAll(this.checked)">
          <label class="select-all-label" for="select-all-cb">Zaznacz wszystkie</label>
        </div>
        <div id="results-list"></div>
        <div class="bulk-bar" id="bulk-bar">
          <div class="bulk-bar-count">Zaznaczono: <strong id="bulk-count">0</strong></div>
          <div class="bulk-bar-sep"></div>
          <button class="bulk-btn accent" onclick="bulkSave()">üîñ Zapisz zaznaczone</button>
          <button class="bulk-btn" onclick="bulkCopy()">üìã Kopiuj linki</button>
          <button class="bulk-btn danger" onclick="bulkDeselect()">‚úï Odznacz</button>
          <button class="bulk-deselect" onclick="bulkDeselect()" title="Zamknij">‚úï</button>
        </div>
      </div>

      <div id="empty-state" class="empty-state">
        <div class="icon">üéØ</div>
        <h3>Gotowy do polowania na leady?</h3>
        <p>Wpisz zapytanie, w≈ÇƒÖcz interesujƒÖce ≈∫r√≥d≈Ça i kliknij Szukaj.<br>
        Narzƒôdzie przeszuka fora i serwisy spo≈Çeczno≈õciowe w poszukiwaniu<br>potencjalnych klient√≥w.</p>
      </div>
    </div>

    <!-- PAGE: SAVED -->
    <div id="page-saved" style="display:none">
      <div id="saved-list"></div>
      <div id="saved-empty" class="empty-state" style="display:none">
        <div class="icon">üîñ</div>
        <h3>Brak zapisanych lead√≥w</h3>
        <p>Wyszukaj klient√≥w i zapisuj obiecujƒÖce wyniki klikajƒÖc<br>przycisk "Zapisz lead".</p>
      </div>
    </div>

    <!-- PAGE: SOURCES MANAGEMENT -->
    <div id="page-sources" style="display:none">
      <div class="manage-topbar">
        <div class="manage-topbar-left">
          <div class="sources-title">Wszystkie ≈∫r√≥d≈Ça</div>
          <div class="manage-count" id="manage-count">15 ≈∫r√≥de≈Ç</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <div class="manage-view-toggle">
            <button class="manage-view-btn active" id="mgbtn-grid" onclick="setManageView('grid',this)">
              <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><rect x="0" y="0" width="5.5" height="5.5" rx="1" fill="currentColor"/><rect x="7.5" y="0" width="5.5" height="5.5" rx="1" fill="currentColor"/><rect x="0" y="7.5" width="5.5" height="5.5" rx="1" fill="currentColor"/><rect x="7.5" y="7.5" width="5.5" height="5.5" rx="1" fill="currentColor"/></svg>
              Kafelki
            </button>
            <button class="manage-view-btn" id="mgbtn-list" onclick="setManageView('list',this)">
              <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><rect x="0" y="1" width="13" height="2" rx="1" fill="currentColor"/><rect x="0" y="5.5" width="13" height="2" rx="1" fill="currentColor"/><rect x="0" y="10" width="13" height="2" rx="1" fill="currentColor"/></svg>
              Lista
            </button>
          </div>
          <button class="io-btn" onclick="exportSources()">
            <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><path d="M6.5 1v8M3 6.5l3.5 3.5 3.5-3.5M1 11h11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Eksport
          </button>
          <button class="io-btn" onclick="importSources()">
            <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><path d="M6.5 12V4M3 6.5L6.5 3 10 6.5M1 1h11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Import
          </button>
          <button class="search-source-btn" onclick="openSrcSearchModal()">üîç Szukaj ≈∫r√≥de≈Ç</button>
          <button class="add-source-btn" onclick="openAddModal()">+ Dodaj ≈∫r√≥d≈Ço</button>
        </div>
      </div>
      <div id="sources-manage-content"></div>
    </div>

    <!-- PAGE: KEYWORDS -->
    <div id="page-keywords" style="display:none">
      <div class="creds-topbar">
        <div><div class="sources-title">Frazy i s≈Çowa kluczowe</div></div>
        <button class="add-kwset-btn" onclick="openKwModal()">+ Dodaj zestaw</button>
      </div>
      <div id="keywords-content"></div>
    </div>

    <!-- PAGE: ENGINES -->
    <div id="page-engines" style="display:none">
      <div class="creds-topbar">
        <div><div class="sources-title">Silniki wyszukiwa≈Ñ</div></div>
      </div>
      <div id="engines-content"></div>
    </div>

    <!-- PAGE: CREDENTIALS -->
    <div id="page-credentials" style="display:none">
      <div class="creds-topbar">
        <div>
          <div class="sources-title">Loginy do ≈∫r√≥de≈Ç</div>
        </div>
        <div class="manage-view-toggle">
          <button class="manage-view-btn" id="cg-btn-status" onclick="setCredsGroup('status',this)">Wg statusu</button>
          <button class="manage-view-btn" id="cg-btn-name" onclick="setCredsGroup('name',this)">Wg nazwy</button>
        </div>
      </div>
      <div class="creds-notice" id="creds-notice">
        <span class="creds-notice-icon">üîí</span>
        <span>Has≈Ça sƒÖ przechowywane lokalnie w przeglƒÖdarce i powiƒÖzane z Twoim kontem u≈ºytkownika. Zaloguj siƒô do systemu, aby zarzƒÖdzaƒá swoimi loginami.</span>
      </div>
      <div id="creds-content"></div>
    </div>

  </div>
</main>
</div>

<!-- KEYWORDS MODAL -->
<div class="modal-overlay" id="kw-modal-overlay">
  <div class="modal kw-modal">
    <div class="modal-title" id="kw-modal-title">Dodaj zestaw fraz</div>
    <div class="modal-body">
      <div class="form-row">
        <label class="form-label">Nazwa zestawu</label>
        <input class="form-input" id="kw-modal-name" placeholder="np. Zapytania o szkolenia IT" />
      </div>
      <div class="form-row">
        <label class="form-label">Frazy i s≈Çowa kluczowe</label>
        <textarea class="kw-phrases-textarea" id="kw-modal-phrases" placeholder="szukam szkolenia z Excela&#10;kurs programowania&#10;potrzebujƒô nauczyciela&#10;(jedna fraza na liniƒô)"></textarea>
        <div class="kw-hint">Wpisz ka≈ºdƒÖ frazƒô w osobnej linii. Frazy bƒôdƒÖ u≈ºywane podczas wyszukiwania.</div>
      </div>
      <div class="form-row">
        <label class="form-label">PowiƒÖzane ≈∫r√≥d≈Ça i podlinki</label>
        <div class="kw-source-picker" id="kw-source-picker"></div>
        <div class="kw-hint">Zaznacz ≈∫r√≥d≈Ça i wybierz konkretny podlink lub zostaw ‚ÄûWszystkie".</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeKwModal()">Anuluj</button>
      <button class="btn-save" onclick="saveKwSet()">Zapisz</button>
    </div>
  </div>
</div>

<!-- SOURCE SEARCH MODAL -->
<div class="modal-overlay" id="src-search-modal-overlay">
  <div class="modal src-search-modal">
    <div class="modal-title">üîç Szukaj nowych ≈∫r√≥de≈Ç</div>
    <div class="modal-sub">Zbuduj zapytanie i wy≈õlij je do Google AI, a nastƒôpnie wklej wyniki tutaj</div>
    <div class="modal-body">
      <div class="form-row">
        <label class="form-label">Zapytanie do Google AI</label>
        <div class="query-builder">
          <span>szukam os√≥b poszukujƒÖcych</span>
          <input class="query-keyword-input" id="src-search-keyword" placeholder="np. szkole≈Ñ IT, agencji SEO, dostawcy..." onkeydown="if(event.key==='Enter')openGoogleAISearch()" />
          <span>wynik prezentuj w postaci nazwy ≈∫r√≥d≈Ça, linku i kr√≥tkiego opisu w jednym zdaniu oraz znaczka [+] po ka≈ºdym ≈∫r√≥dle.</span>
        </div>
        <div class="query-builder-actions">
          <button class="src-search-go-btn" onclick="openGoogleAISearch()">üåê Otw√≥rz Google AI</button>
          <button class="src-search-copy-btn" onclick="copySourceQuery()">üìã Skopiuj zapytanie</button>
        </div>
      </div>

      <div class="src-search-divider">Wklej wyniki Google AI</div>

      <div class="form-row">
        <textarea class="src-paste-area" id="src-paste-area" placeholder="Wklej tutaj odpowied≈∫ z Google AI...&#10;&#10;Przyk≈Çad:&#10;Elektroda.pl, https://elektroda.pl, Forum techniczne z aktywnƒÖ spo≈Çeczno≈õciƒÖ elektronicznƒÖ. [+]&#10;OLX Us≈Çugi, https://olx.pl/uslugi/, Serwis og≈Çosze≈Ñ z sekcjƒÖ us≈Çug dla firm i os√≥b prywatnych. [+]"></textarea>
        <button class="src-analyze-btn" onclick="analyzeSourceResults()">üîé Analizuj wyniki</button>
      </div>

      <div id="src-search-results" class="src-results-list"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeSrcSearchModal()">Zamknij</button>
    </div>
  </div>
</div>

<!-- ADD SOURCE MODAL -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <div class="modal-title">Dodaj nowe ≈∫r√≥d≈Ço</div>
    <div class="modal-sub">Skonfiguruj nowe miejsce przeszukiwania</div>
    <div class="form-row">
      <label class="form-label">Nazwa ≈∫r√≥d≈Ça</label>
      <input class="form-input" id="new-name" placeholder="np. Forum Moje Forum" />
    </div>
    <div class="form-row">
      <label class="form-label">Typ</label>
      <select class="form-select" id="new-type">
        <option value="forum">Forum</option>
        <option value="social">Social media</option>
        <option value="portal">Portal informacyjny</option>
        <option value="ogloszenia">Serwis og≈Çoszeniowy</option>
        <option value="it">Forum IT</option>
        <option value="biznes">Forum biznesowe</option>
      </select>
    </div>
    <div class="form-row">
      <label class="form-label">Silnik wyszukiwania</label>
      <select class="form-select" id="new-engine">
        <option value="internal">Wewnƒôtrzna wyszukiwarka</option>
        <option value="google">Google</option>
        <option value="google_site">Google (site:)</option>
        <option value="bing">Bing</option>
        <option value="duckduckgo">DuckDuckGo</option>
      </select>
    </div>
    <div class="form-row">
      <label class="form-label">G≈Ç√≥wny URL serwisu</label>
      <input class="form-input" id="new-baseurl" placeholder="https://forum.example.com" />
    </div>
    <div class="form-row">
      <label class="form-label">URL podforum / sekcji (opcjonalnie)</label>
      <input class="form-input" id="new-url" placeholder="https://forum.example.com/kategoria/" />
    </div>
    <div class="form-row">
      <label class="form-label">Ikona (emoji)</label>
      <input class="form-input" id="new-icon" placeholder="üåê" maxlength="2" style="width:80px" />
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal()">Anuluj</button>
      <button class="btn-save" onclick="saveNewSource()">Dodaj ≈∫r√≥d≈Ço</button>
    </div>
  </div>
</div>

<!-- LOGIN MODAL -->
<div class="modal-overlay" id="login-modal-overlay">
  <div class="modal login-modal">
    <div id="login-form-view">
      <div class="modal-title">Logowanie</div>
      <div class="modal-sub">Zaloguj siƒô aby korzystaƒá z pe≈Çnych mo≈ºliwo≈õci</div>
      <div class="form-row">
        <label class="form-label">Email</label>
        <input class="form-input" id="login-email" type="email" placeholder="jan@firma.pl" />
      </div>
      <div class="form-row">
        <label class="form-label">Has≈Ço</label>
        <input class="form-input" id="login-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          onkeydown="if(event.key==='Enter') doLogin()" />
      </div>
      <div id="login-error" style="display:none;color:var(--red);font-size:0.75rem;margin-top:-6px;margin-bottom:8px"></div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeLoginModal()">Anuluj</button>
        <button class="btn-save" onclick="doLogin()">Zaloguj</button>
      </div>
    </div>
    <div id="login-logged-view" style="display:none">
      <div class="modal-title">Konto</div>
      <div class="modal-sub" style="margin-bottom:16px">Jeste≈õ zalogowany</div>
      <div class="login-user-row">
        <div class="login-avatar" id="login-avatar">?</div>
        <div>
          <div class="login-user-name" id="login-user-name">‚Äî</div>
          <div class="login-user-email" id="login-user-email">‚Äî</div>
        </div>
      </div>
      <div class="modal-footer" style="margin-top:16px">
        <button class="btn-cancel" onclick="closeLoginModal()">Zamknij</button>
        <button class="btn-save" style="background:var(--red)" onclick="doLogout()">Wyloguj</button>
      </div>
    </div>
  </div>
</div>

<!-- SOURCE CREDENTIALS MODAL -->
<div class="modal-overlay" id="src-cred-modal-overlay">
  <div class="modal src-cred-modal">
    <div class="modal-title" id="src-cred-title">Logowanie do ≈∫r√≥d≈Ça</div>
    <div class="modal-sub" id="src-cred-sub">Podaj dane dostƒôpowe</div>
    <div class="src-cred-source-info" id="src-cred-info"></div>
    <div class="form-row">
      <label class="form-label">Login / Email</label>
      <input class="form-input" id="src-cred-login" type="text" placeholder="tw√≥j login lub email" />
    </div>
    <div class="form-row">
      <label class="form-label">Has≈Ço</label>
      <div class="pass-input-wrap">
        <input class="form-input" id="src-cred-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <button class="pass-toggle-btn" type="button" onclick="togglePassVis()" id="pass-toggle-btn">üëÅ</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeSrcCredModal()">Anuluj</button>
      <button class="btn-save" onclick="saveSrcCred()">Zapisz</button>
    </div>
  </div>
</div>

<script>
// =====================
// DATA
// =====================
let savedLeads = JSON.parse(localStorage.getItem('lh_saved') || '[]');

const ENGINES = [
  { value: 'internal', label: 'Wewnƒôtrzna wyszukiwarka' },
  { value: 'google',   label: 'Google' },
  { value: 'google_site', label: 'Google (site:)' },
  { value: 'bing',     label: 'Bing' },
  { value: 'duckduckgo', label: 'DuckDuckGo' },
];

const SOURCES = [
  { id: 1, name: 'Elektroda.pl', type: 'forum', icon: '‚ö°', color: '#e8f0fc', enabled: true,
    baseUrl: 'https://www.elektroda.pl', engine: 'internal',
    subforums: [''], keywords: 'szukam, polecacie, potrzebujƒô, pomo≈ºecie',
    desc: 'Forum techniczne i elektroniczne', favorite: false, dateAdded: '2024-01-15', loginRequired: true },
  { id: 2, name: '4programmers.net', type: 'it', icon: 'üë®‚Äçüíª', color: '#f0e8fc', enabled: true,
    baseUrl: 'https://4programmers.net', engine: 'internal',
    subforums: ['https://4programmers.net/Forum/Praca', 'https://4programmers.net/Forum/Oferty'],
    keywords: 'szukam, potrzebujƒô, pomoc, oferta',
    desc: 'Forum programistyczne', favorite: true, dateAdded: '2024-01-18', loginRequired: true },
  { id: 3, name: 'Forum.net.pl', type: 'forum', icon: 'üí¨', color: '#e8f0fc', enabled: true,
    baseUrl: 'https://forum.net.pl', engine: 'google_site',
    subforums: [''], keywords: 'szukam, potrzebujƒô, polecacie',
    desc: 'Forum og√≥lne', favorite: false, dateAdded: '2024-01-20', loginRequired: true },
  { id: 4, name: 'Bankier.pl Forum', type: 'biznes', icon: 'üè¶', color: '#e8f5f5', enabled: true,
    baseUrl: 'https://forum.bankier.pl', engine: 'internal',
    subforums: ['https://forum.bankier.pl/'], keywords: 'szukam dostawcy, polecacie firmƒô, potrzebujƒô us≈Çugi',
    desc: 'Forum finansowe i biznesowe', favorite: false, dateAdded: '2024-01-22', loginRequired: true },
  { id: 5, name: 'GoldenLine', type: 'social', icon: 'üü°', color: '#fde8f0', enabled: false,
    baseUrl: 'https://www.goldenline.pl', engine: 'internal',
    subforums: [''], keywords: 'szukam, hiring, rekrutacja, oferta',
    desc: 'Polska sieƒá profesjonalist√≥w', favorite: true, dateAdded: '2024-01-25', loginRequired: true },
  { id: 6, name: 'LinkedIn PL', type: 'social', icon: 'üíº', color: '#fde8f0', enabled: true,
    baseUrl: 'https://www.linkedin.com', engine: 'google',
    subforums: [''], keywords: 'looking for, szukam, need vendor, potrzebujƒô',
    desc: 'Sieƒá profesjonalist√≥w', favorite: false, dateAdded: '2024-01-28', loginRequired: true },
  { id: 7, name: 'Onet Wiadomo≈õci', type: 'portal', icon: 'üî¥', color: '#e8f5ee', enabled: false,
    baseUrl: 'https://www.onet.pl', engine: 'internal',
    subforums: ['https://wiadomosci.onet.pl/'], keywords: '',
    desc: 'Portal informacyjny Onet', favorite: false, dateAdded: '2024-02-01', loginRequired: false },
  { id: 8, name: 'WP.pl Finanse', type: 'portal', icon: 'üåê', color: '#e8f5ee', enabled: false,
    baseUrl: 'https://www.wp.pl', engine: 'internal',
    subforums: ['https://finanse.wp.pl/'], keywords: '',
    desc: 'Dzia≈Ç finansowy WP', favorite: false, dateAdded: '2024-02-05', loginRequired: false },
  { id: 9, name: 'OLX ‚Äì Us≈Çugi', type: 'ogloszenia', icon: 'üìã', color: '#fef3e2', enabled: true,
    baseUrl: 'https://www.olx.pl', engine: 'internal',
    subforums: ['https://www.olx.pl/uslugi/', 'https://www.olx.pl/elektronika/'],
    keywords: 'szukam, poszukujƒô, potrzebujƒô',
    desc: 'Og≈Çoszenia OLX ‚Äì dzia≈Ç us≈Çug', favorite: false, dateAdded: '2024-02-08', loginRequired: false },
  { id: 10, name: 'Oferteo.pl', type: 'ogloszenia', icon: 'üìù', color: '#fef3e2', enabled: true,
    baseUrl: 'https://oferteo.pl', engine: 'internal',
    subforums: ['https://oferteo.pl/'], keywords: '',
    desc: 'Platforma zlece≈Ñ i us≈Çug', favorite: true, dateAdded: '2024-02-10', loginRequired: false },
  { id: 11, name: 'Reddit r/Polska', type: 'social', icon: 'ü§ñ', color: '#fde8f0', enabled: true,
    baseUrl: 'https://www.reddit.com', engine: 'google_site',
    subforums: ['https://reddit.com/r/Polska/', 'https://reddit.com/r/PracaIT/'],
    keywords: 'szukam, potrzebujƒô, polecacie',
    desc: 'Reddit ‚Äì polska spo≈Çeczno≈õƒá', favorite: false, dateAdded: '2024-02-12', loginRequired: true },
  { id: 12, name: 'Wykop.pl', type: 'social', icon: 'üî∫', color: '#fde8f0', enabled: true,
    baseUrl: 'https://www.wykop.pl', engine: 'internal',
    subforums: [''], keywords: 'szukam, potrzebujƒô, polecacie',
    desc: 'Spo≈Çeczno≈õƒá Wykop.pl', favorite: false, dateAdded: '2024-02-15', loginRequired: true },
  { id: 13, name: 'Freelancer.pl', type: 'ogloszenia', icon: 'üéØ', color: '#fef3e2', enabled: true,
    baseUrl: 'https://freelancer.pl', engine: 'internal',
    subforums: ['https://freelancer.pl/zlecenia/'], keywords: 'szukam wykonawcy, potrzebujƒô, zlecƒô',
    desc: 'Platforma zlece≈Ñ dla freelancer√≥w', favorite: false, dateAdded: '2024-02-18', loginRequired: true },
  { id: 14, name: 'inEDU.pl Forum', type: 'forum', icon: 'üéì', color: '#e8f0fc', enabled: false,
    baseUrl: 'https://www.inedu.pl', engine: 'google',
    subforums: [''], keywords: 'szukam szkolenia, potrzebujƒô kursu',
    desc: 'Forum edukacyjne', favorite: false, dateAdded: '2024-02-20', loginRequired: true },
  { id: 15, name: 'Forum GazetaPrawna', type: 'biznes', icon: '‚öñÔ∏è', color: '#e8f5f5', enabled: false,
    baseUrl: 'https://forum.gazetaprawna.pl', engine: 'google_site',
    subforums: [''], keywords: 'szukam prawnika, potrzebujƒô porady, firma',
    desc: 'Forum biznesowe Gazeta Prawna', favorite: false, dateAdded: '2024-02-22', loginRequired: true },
];

let nextId = 16;

// =====================
// PAGES
// =====================
function showPage(page) {
  ['search','saved','sources','keywords','engines','credentials'].forEach(p => {
    document.getElementById(`page-${p}`).style.display = p === page ? 'block' : 'none';
  });
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  event.currentTarget.classList.add('active');
  const titles = {
    search: ['Szukaj klient√≥w', 'Przeszukuj fora i serwisy spo≈Çeczno≈õciowe'],
    saved: ['Zapisane leady', 'Twoja lista potencjalnych klient√≥w'],
    sources: ['ZarzƒÖdzaj ≈∫r√≥d≈Çami', 'Konfiguruj i edytuj ≈∫r√≥d≈Ça danych'],
    keywords: ['Frazy i s≈Çowa kluczowe', 'Zestawy fraz powiƒÖzane z wybranymi ≈∫r√≥d≈Çami'],
    engines: ['Silniki wyszukiwa≈Ñ', '≈πr√≥d≈Ça pogrupowane wed≈Çug metody wyszukiwania'],
    credentials: ['Loginy do ≈∫r√≥de≈Ç', 'ZarzƒÖdzaj danymi dostƒôpowymi do ka≈ºdego ≈∫r√≥d≈Ça']
  };
  document.getElementById('page-title').textContent = titles[page][0];
  document.getElementById('page-subtitle').textContent = titles[page][1];

  if (page === 'saved') renderSaved();
  if (page === 'sources') renderSourcesManage();
  if (page === 'keywords') renderKeywords();
  if (page === 'engines') renderEngines();
  if (page === 'credentials') renderCredentials();
}

// =====================
// SORTING & FAVORITES
// =====================
let currentSort = 'name-asc'; // name-asc, name-desc, date-asc, date-desc
let showFavoritesOnly = false;

function changeSorting(sortType) {
  currentSort = sortType;
  renderSources();
  if (document.getElementById('page-sources').style.display !== 'none') {
    renderSourcesManage();
  }
}

function toggleFavorite(sourceId) {
  const source = SOURCES.find(s => s.id === sourceId);
  if (source) {
    source.favorite = !source.favorite;
    renderSources();
    if (document.getElementById('page-sources').style.display !== 'none') {
      renderSourcesManage();
    }
  }
}

function getLoginStatus(source) {
  if (!source.loginRequired) {
    return 'not-applicable';
  }
  const cred = getSourceCred(source.id);
  return cred ? 'logged-in' : 'logged-out';
}

function getSortedSources() {
  let sources = [...SOURCES];
  
  // Sortowanie
  switch (currentSort) {
    case 'name-asc':
      sources.sort((a, b) => a.name.localeCompare(b.name));
      break;
    case 'name-desc':
      sources.sort((a, b) => b.name.localeCompare(a.name));
      break;
    case 'date-asc':
      sources.sort((a, b) => new Date(a.dateAdded) - new Date(b.dateAdded));
      break;
    case 'date-desc':
      sources.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
      break;
  }
  
  return sources;
}
// =====================
// RENDER SOURCES
// =====================
function typeBadge(t) {
  const map = { forum:'badge-forum', social:'badge-social', portal:'badge-portal', ogloszenia:'badge-ogloszenia', it:'badge-it', biznes:'badge-biznes' };
  const labels = { forum:'Forum', social:'Social', portal:'Portal', ogloszenia:'Og≈Çoszenia', it:'IT', biznes:'Biznes' };
  return `<span class="source-type-badge ${map[t]||'badge-forum'}">${labels[t]||t}</span>`;
}

function renderSources() {
  const sortedSources = getSortedSources();
  const enabled = sortedSources.filter(s => s.enabled);
  
  // Podziel na ulubione i pozosta≈Çe
  const favorites = enabled.filter(s => s.favorite);
  const others = enabled.filter(s => !s.favorite);
  
  // Znajd≈∫ lub utw√≥rz kontener dla ≈∫r√≥de≈Ç
  let sourcesContainer = document.getElementById('sources-container');
  if (!sourcesContainer) {
    sourcesContainer = document.createElement('div');
    sourcesContainer.id = 'sources-container';
    
    // Znajd≈∫ miejsce w page-search i dodaj przed results-section
    const pageSearch = document.getElementById('page-search');
    const resultsSection = document.getElementById('results-section');
    if (pageSearch && resultsSection) {
      pageSearch.insertBefore(sourcesContainer, resultsSection);
    } else if (pageSearch) {
      // Je≈õli nie ma results-section, dodaj przed empty-state
      const emptyState = document.getElementById('empty-state');
      if (emptyState) {
        pageSearch.insertBefore(sourcesContainer, emptyState);
      } else {
        pageSearch.appendChild(sourcesContainer);
      }
    }
  }
  
  let html = '';
  
  // Sekcja ulubionych
  if (favorites.length > 0) {
    html += `
      <div class="sources-header">
        <div class="sources-title">‚≠ê Ulubione ≈∫r√≥d≈Ça</div>
        <div class="sources-controls">
          <select class="sort-dropdown" onchange="changeSorting(this.value)">
            <option value="name-asc" ${currentSort === 'name-asc' ? 'selected' : ''}>Nazwa A-Z</option>
            <option value="name-desc" ${currentSort === 'name-desc' ? 'selected' : ''}>Nazwa Z-A</option>
            <option value="date-asc" ${currentSort === 'date-asc' ? 'selected' : ''}>Data dodania ‚Üë</option>
            <option value="date-desc" ${currentSort === 'date-desc' ? 'selected' : ''}>Data dodania ‚Üì</option>
          </select>
        </div>
      </div>
      <div class="sources-grid">
        ${favorites.map(s => sourceCardHTML(s)).join('')}
      </div>
    `;
  }
  
  // Sekcja pozosta≈Çych aktywnych
  if (others.length > 0) {
    html += `
      <div class="sources-header" ${favorites.length > 0 ? 'style="margin-top:32px"' : ''}>
        <div class="sources-title">Aktywne ≈∫r√≥d≈Ça</div>
        ${favorites.length === 0 ? `
        <div class="sources-controls">
          <select class="sort-dropdown" onchange="changeSorting(this.value)">
            <option value="name-asc" ${currentSort === 'name-asc' ? 'selected' : ''}>Nazwa A-Z</option>
            <option value="name-desc" ${currentSort === 'name-desc' ? 'selected' : ''}>Nazwa Z-A</option>
            <option value="date-asc" ${currentSort === 'date-asc' ? 'selected' : ''}>Data dodania ‚Üë</option>
            <option value="date-desc" ${currentSort === 'date-desc' ? 'selected' : ''}>Data dodania ‚Üì</option>
          </select>
        </div>` : ''}
      </div>
      <div class="sources-grid">
        ${others.map(s => sourceCardHTML(s)).join('')}
      </div>
    `;
  }
  
  // Je≈õli brak w≈ÇƒÖczonych ≈∫r√≥de≈Ç
  if (enabled.length === 0) {
    html = `
      <div class="sources-header">
        <div class="sources-title">Aktywne ≈∫r√≥d≈Ça</div>
        <div class="sources-controls">
          <select class="sort-dropdown" onchange="changeSorting(this.value)">
            <option value="name-asc" ${currentSort === 'name-asc' ? 'selected' : ''}>Nazwa A-Z</option>
            <option value="name-desc" ${currentSort === 'name-desc' ? 'selected' : ''}>Nazwa Z-A</option>
            <option value="date-asc" ${currentSort === 'date-asc' ? 'selected' : ''}>Data dodania ‚Üë</option>
            <option value="date-desc" ${currentSort === 'date-desc' ? 'selected' : ''}>Data dodania ‚Üì</option>
          </select>
        </div>
      </div>
      <div class="sources-grid">
        <div style="color:var(--text-dim);font-size:0.78rem;padding:12px 0">Brak w≈ÇƒÖczonych ≈∫r√≥de≈Ç. W≈ÇƒÖcz je w <a href="#" onclick="document.querySelectorAll('.nav-item')[2].click();return false;" style="color:var(--accent)">ZarzƒÖdzaj ≈∫r√≥d≈Çami</a>.</div>
      </div>
    `;
  }
  
  if (sourcesContainer) {
    sourcesContainer.innerHTML = html;
  }
}

function toggleSource(id, val) {
  const s = SOURCES.find(x => x.id === id);
  if (s) s.enabled = val;
  renderSources(); // refresh search page grid
}

function sourceCardHTML(s, fullSettings = false) {
  if (!s.subforums) s.subforums = s.subforum ? [s.subforum] : [''];
  const iconBg = s.color || '#e8f0fc';
  const filledCount = s.subforums.filter(u => u.trim()).length;
  const countLabel = filledCount > 0 ? `<span class="subforum-count">(${filledCount})</span>` : '';
  const loginStatus = getLoginStatus(s);
  const statusTitles = {
    'logged-in': 'Zalogowany',
    'logged-out': 'Niezalogowany',
    'not-applicable': 'Logowanie niewymagane'
  };

  const settingsPanel = fullSettings ? `
    <button class="settings-toggle-btn" id="stbtn-${s.id}" onclick="toggleSettings(${s.id})">
      <span class="chevron">‚ñæ</span> Ustawienia
    </button>
    <div class="source-card-body" id="sbody-${s.id}">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div class="field-label" style="margin:0">Dane logowania</div>
        ${srcLoginBtnHTML(s.id)}
      </div>
      <div class="field-label" style="margin-top:6px">Silnik wyszukiwania</div>
      <select class="engine-select" onchange="updateSource(${s.id},'engine',this.value)">
        ${ENGINES.map(e => `<option value="${e.value}" ${(s.engine||'internal')===e.value?'selected':''}>${e.label}</option>`).join('')}
      </select>
      <div class="field-label" style="margin-top:10px">Podfora / sekcje ${countLabel}</div>
      <div class="subforum-list" id="sflist-${s.id}">
        ${s.subforums.map((url, idx) => subforumRowHTML(s.id, idx, url)).join('')}
      </div>
      <button class="subforum-add-btn" onclick="addSubforum(${s.id})">+ Dodaj kolejny link</button>
      <div class="field-label" style="margin-top:10px">PowiƒÖzane zestawy fraz</div>
      <div style="margin-top:5px;display:flex;flex-wrap:wrap;gap:3px">${getSourceKwSetsHTML(s.id)}</div>
      <div class="field-label" style="margin-top:10px">S≈Çowa kluczowe aktywne (z zestaw√≥w)</div>
      <textarea class="field-input keywords-input" id="skw-${s.id}" placeholder="np. szukam, polecacie, potrzebujƒô..." oninput="updateSource(${s.id},'keywords',this.value)" title="ZarzƒÖdzaj frazami przez zak≈Çadkƒô Frazy i s≈Çowa kluczowe">${s.keywords||''}</textarea>
    </div>` : '';

  const toggleHTML = fullSettings ? `
      <label class="source-toggle">
        <input type="checkbox" ${s.enabled?'checked':''} onchange="toggleSource(${s.id}, this.checked)">
        <span class="toggle-slider"></span>
      </label>` : '';

  const subforumsDisplay = !fullSettings ? (() => {
    const filled = s.subforums.filter(u => u.trim());
    if (!filled.length) return '';
    return `<div class="card-subforums">${filled.map(u => `<a class="card-subforum-chip" href="${u}" target="_blank" onclick="event.stopPropagation()" title="${u}">‚Üó ${u.replace(/https?:\/\/(www\.)?/,'').replace(/\/$/,'')}</a>`).join('')}</div>`;
  })() : '';

  return `
  <div class="source-card" id="scard-${s.id}">
    <div class="source-card-header">
      <div class="source-icon" style="background:${iconBg}">${s.icon}</div>
      <div class="source-info">
        <div class="source-name">${s.name}</div>
        ${typeBadge(s.type)}
        ${s.baseUrl ? `<a class="source-base-url" href="${s.baseUrl}" target="_blank" onclick="event.stopPropagation()">üîó ${s.baseUrl.replace('https://','').replace('www.','')}</a>` : ''}
      </div>
      ${toggleHTML}
      <button class="favorite-btn${s.favorite ? ' active' : ''}" onclick="toggleFavorite(${s.id})" title="${s.favorite ? 'Usu≈Ñ z ulubionych' : 'Dodaj do ulubionych'}">
        ${s.favorite ? '‚≠ê' : '‚òÜ'}
      </button>
      ${fullSettings ? `<button class="clone-btn" onclick="cloneSource(${s.id})" title="Klonuj ≈∫r√≥d≈Ço">‚ßâ</button>` : ''}
      <div class="login-status-lamp ${loginStatus}" title="${statusTitles[loginStatus]}"></div>
    </div>
    ${subforumsDisplay}
    ${settingsPanel}
  </div>
  `;
}

function subforumRowHTML(sourceId, idx, url) {
  return `
    <div class="subforum-row" id="sfrow-${sourceId}-${idx}">
      <input class="field-input" value="${url}" placeholder="https://forum.example.com/kategoria/"
        oninput="updateSubforum(${sourceId}, ${idx}, this.value)" />
      <button class="subforum-remove" onclick="removeSubforum(${sourceId}, ${idx})" title="Usu≈Ñ">√ó</button>
    </div>
  `;
}

let manageView = 'grid';

function setManageView(v, btn) {
  manageView = v;
  document.querySelectorAll('.manage-view-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderSourcesManage();
}

function renderSourcesManage() {
  const container = document.getElementById('sources-manage-content');
  const sortedSources = getSortedSources();
  
  document.getElementById('manage-count').textContent = sortedSources.length + ' ≈∫r√≥de≈Ç';
  
  // Aktualizuj topbar
  const topbar = document.querySelector('.manage-topbar');
  if (topbar) {
    topbar.innerHTML = `
      <div class="manage-topbar-left">
        <div class="sources-title">Wszystkie ≈∫r√≥d≈Ça</div>
        <div class="manage-count" id="manage-count">${sortedSources.length} ≈∫r√≥de≈Ç</div>
      </div>
      <div class="manage-topbar-right">
        <select class="sort-dropdown" onchange="changeSorting(this.value)">
          <option value="name-asc" ${currentSort === 'name-asc' ? 'selected' : ''}>Nazwa A-Z</option>
          <option value="name-desc" ${currentSort === 'name-desc' ? 'selected' : ''}>Nazwa Z-A</option>
          <option value="date-asc" ${currentSort === 'date-asc' ? 'selected' : ''}>Data dodania ‚Üë</option>
          <option value="date-desc" ${currentSort === 'date-desc' ? 'selected' : ''}>Data dodania ‚Üì</option>
        </select>
        <div class="manage-view-toggle">
          <button class="manage-view-btn${manageView === 'grid' ? ' active' : ''}" id="mgbtn-grid" onclick="setManageView('grid',this)">
            <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><rect x="0" y="0" width="5.5" height="5.5" rx="1" fill="currentColor"/><rect x="7.5" y="0" width="5.5" height="5.5" rx="1" fill="currentColor"/><rect x="0" y="7.5" width="5.5" height="5.5" rx="1" fill="currentColor"/><rect x="7.5" y="7.5" width="5.5" height="5.5" rx="1" fill="currentColor"/></svg>
            Kafelki
          </button>
          <button class="manage-view-btn${manageView === 'list' ? ' active' : ''}" id="mgbtn-list" onclick="setManageView('list',this)">
            <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><rect x="0" y="1" width="13" height="2" rx="1" fill="currentColor"/><rect x="0" y="5.5" width="13" height="2" rx="1" fill="currentColor"/><rect x="0" y="10" width="13" height="2" rx="1" fill="currentColor"/></svg>
            Lista
          </button>
        </div>
        <button class="io-btn" onclick="exportSources()" title="Eksportuj ≈∫r√≥d≈Ça do pliku JSON">
          <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><path d="M6.5 1v8M3 6.5l3.5 3.5 3.5-3.5M1 11h11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Eksport
        </button>
        <button class="io-btn" onclick="importSources()" title="Importuj ≈∫r√≥d≈Ça z pliku JSON">
          <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><path d="M6.5 12V4M3 6.5L6.5 3 10 6.5M1 1h11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Import
        </button>
        <button class="search-source-btn" onclick="openSrcSearchModal()">üîç Szukaj ≈∫r√≥de≈Ç</button>
        <button class="add-source-btn" onclick="openAddModal()">+ Dodaj ≈∫r√≥d≈Ço</button>
      </div>`;
  }

  if (manageView === 'grid') {
    let html = '';
    
    // Podziel na aktywne i nieaktywne
    const active = sortedSources.filter(s => s.enabled);
    const inactive = sortedSources.filter(s => !s.enabled);
    
    // Sekcja aktywnych
    if (active.length > 0) {
      html += `
        <div class="sources-header" style="margin-bottom:16px">
          <div class="sources-title">‚úÖ Aktywne ≈∫r√≥d≈Ça (${active.length})</div>
        </div>
        <div class="sources-grid" style="margin-bottom:32px">
          ${active.map(s => sourceCardHTML(s, true)).join('')}
        </div>
      `;
    }
    
    // Sekcja nieaktywnych
    if (inactive.length > 0) {
      html += `
        <div class="sources-header" style="margin-bottom:16px">
          <div class="sources-title">‚è∏Ô∏è Nieaktywne ≈∫r√≥d≈Ça (${inactive.length})</div>
        </div>
        <div class="sources-grid">
          ${inactive.map(s => sourceCardHTML(s, true)).join('')}
        </div>
      `;
    }
    
    container.innerHTML = html;
  } else {
    const active   = sortedSources.filter(s => s.enabled);
    const inactive = sortedSources.filter(s => !s.enabled);
    let html = '';
    if (active.length > 0) {
      html += `<div class="sources-header" style="margin-bottom:16px"><div class="sources-title">‚úÖ Aktywne ≈∫r√≥d≈Ça (${active.length})</div></div>`;
      html += sourceListTableHTML(active);
      html += `<div style="margin-bottom:28px"></div>`;
    }
    if (inactive.length > 0) {
      html += `<div class="sources-header" style="margin-bottom:16px"><div class="sources-title">‚è∏Ô∏è Nieaktywne ≈∫r√≥d≈Ça (${inactive.length})</div></div>`;
      html += sourceListTableHTML(inactive);
    }
    container.innerHTML = html;
  }
}

function sourceListTableHTML(sources = null) {
  const sortedSources = sources || getSortedSources();
  const rows = sortedSources.map(s => {
    if (!s.subforums) s.subforums = s.subforum ? [s.subforum] : [''];
    const filled = s.subforums.filter(u => u.trim());
    const loginStatus = getLoginStatus(s);
    const statusTitles = {
      'logged-in': 'Zalogowany',
      'logged-out': 'Niezalogowany', 
      'not-applicable': 'Niewymagane'
    };
    
    let urlsHTML = '';
    if (filled.length === 0) {
      urlsHTML = `<span class="slt-url-empty">Brak URL</span>`;
    } else {
      urlsHTML = `<span class="slt-url-chip" title="${filled[0]}">${filled[0]}</span>`;
      if (filled.length > 1) urlsHTML += `<span class="slt-url-more">+${filled.length - 1} wiƒôcej</span>`;
    }
    const kwShort = s.keywords ? s.keywords : '‚Äî';
    const engineLabel = (ENGINES.find(e => e.value === (s.engine||'internal')) || ENGINES[0]).label;
    const enabledHTML = `<label class="source-toggle" style="display:inline-block">
      <input type="checkbox" ${s.enabled?'checked':''} onchange="toggleSource(${s.id},this.checked)">
      <span class="toggle-slider"></span>
    </label>`;
    
    const favoriteHTML = `<button class="favorite-btn${s.favorite ? ' active' : ''}" onclick="toggleFavorite(${s.id})" style="position:static;opacity:1;margin-right:4px;font-size:0.8rem" title="${s.favorite ? 'Usu≈Ñ z ulubionych' : 'Dodaj do ulubionych'}">
      ${s.favorite ? '‚≠ê' : '‚òÜ'}
    </button>`;
    
    const nameHTML = `
      <div style="display:flex;align-items:center;gap:4px;min-width:120px">
        ${favoriteHTML}
        <div>
          <div class="slt-name">${s.name}</div>
          ${typeBadge(s.type)}
          ${s.baseUrl ? `<br><a class="source-base-url" href="${s.baseUrl}" target="_blank">üîó ${s.baseUrl.replace('https://','').replace('www.','').substring(0,25)}</a>` : ''}
        </div>
      </div>
    `;
    
    return `
      <tr id="sltr-${s.id}">
        <td><div class="slt-icon" style="background:${s.color||'#e8f0fc'}">${s.icon}</div></td>
        <td>
          ${nameHTML}
        </td>
        <td><div style="display:flex;flex-direction:column;gap:3px">${urlsHTML}</div></td>
        <td><div class="slt-keywords" title="${s.keywords}">${kwShort}</div></td>
        <td><span class="engine-badge">${engineLabel}</span></td>
        <td>
          <div style="display:flex;align-items:center;gap:6px;min-width:80px">
            <div class="login-status-lamp ${loginStatus}" title="${statusTitles[loginStatus]}" style="position:static"></div>
            <div style="font-size:0.7rem">${srcLoginBtnHTML(s.id)}</div>
          </div>
        </td>
        <td style="text-align:center">${enabledHTML}</td>
        <td style="white-space:nowrap">
          <button class="slt-edit-btn" onclick="toggleListSettings(${s.id})" style="font-size:0.65rem;padding:3px 8px">‚öô</button>
          <button class="clone-btn" onclick="cloneSource(${s.id})" title="Klonuj ≈∫r√≥d≈Ço" style="margin-left:4px">‚ßâ</button>
        </td>
      </tr>
      <tr class="slt-settings-row" id="slts-${s.id}" style="display:none">
        <td colspan="8">
          <div class="slt-settings-inner">
            <div class="field-label">Silnik wyszukiwania</div>
            <select class="engine-select" onchange="updateSource(${s.id},'engine',this.value)">
              ${ENGINES.map(e => `<option value="${e.value}" ${(s.engine||'internal')===e.value?'selected':''}>${e.label}</option>`).join('')}
            </select>
            <div class="field-label" style="margin-top:10px">Podfora / sekcje</div>
            <div class="subforum-list" id="sflist-${s.id}">
              ${s.subforums.map((url, idx) => subforumRowHTML(s.id, idx, url)).join('')}
            </div>
            <button class="subforum-add-btn" onclick="addSubforum(${s.id})">+ Dodaj kolejny link</button>
            <div class="field-label" style="margin-top:10px">PowiƒÖzane zestawy fraz</div>
            <div style="margin-top:5px;display:flex;flex-wrap:wrap;gap:3px">${getSourceKwSetsHTML(s.id)}</div>
            <div class="field-label" style="margin-top:10px">S≈Çowa kluczowe aktywne (z zestaw√≥w)</div>
            <textarea class="field-input keywords-input" id="skw-${s.id}" placeholder="np. szukam, polecacie, potrzebujƒô..." oninput="updateSource(${s.id},'keywords',this.value)">${s.keywords||''}</textarea>
          </div>
        </td>
      </tr>
    `;
  }).join('');
  return `
    <div class="sources-table-wrapper">
    <table class="sources-list-table">
      <thead><tr>
        <th style="width:44px"></th>
        <th>≈πr√≥d≈Ço</th>
        <th>Podfora</th>
        <th>S≈Çowa kluczowe</th>
        <th>Silnik</th>
        <th>Logowanie</th>
        <th style="text-align:center">Aktywne</th>
        <th></th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
    </div>`;
}

function toggleListSettings(id) {
  const row = document.getElementById(`slts-${id}`);
  if (!row) return;
  const visible = row.style.display !== 'none';
  row.style.display = visible ? 'none' : 'table-row';
  // update button label
  const btn = document.querySelector(`#sltr-${id} .slt-edit-btn`);
  if (btn) btn.textContent = visible ? '‚öô Edytuj' : '‚úï Zamknij';
}


function toggleSettings(id) {
  const body = document.getElementById(`sbody-${id}`);
  const btn = document.getElementById(`stbtn-${id}`);
  const open = body.classList.toggle('open');
  btn.classList.toggle('open', open);
}

function updateSource(id, field, val) {
  const s = SOURCES.find(x => x.id === id);
  if (s) s[field] = val;
}

function updateSubforum(sourceId, idx, val) {
  const s = SOURCES.find(x => x.id === sourceId);
  if (!s) return;
  s.subforums[idx] = val;
  // update count label in both grids
  refreshSubforumCount(sourceId);
}

function addSubforum(sourceId) {
  const s = SOURCES.find(x => x.id === sourceId);
  if (!s) return;
  s.subforums.push('');
  const idx = s.subforums.length - 1;
  // append row to both grids (search page + manage page)
  ['sflist-' + sourceId].forEach(listId => {
    const list = document.getElementById(listId);
    if (list) {
      list.insertAdjacentHTML('beforeend', subforumRowHTML(sourceId, idx, ''));
      // focus the new input
      const inputs = list.querySelectorAll('.subforum-row input');
      if (inputs.length) inputs[inputs.length - 1].focus();
    }
  });
  refreshSubforumCount(sourceId);
}

function removeSubforum(sourceId, idx) {
  const s = SOURCES.find(x => x.id === sourceId);
  if (!s) return;
  if (s.subforums.length <= 1) {
    // just clear it instead of removing
    s.subforums[0] = '';
    const input = document.querySelector(`#sfrow-${sourceId}-0 input`);
    if (input) input.value = '';
    return;
  }
  s.subforums.splice(idx, 1);
  // re-render the list
  const list = document.getElementById(`sflist-${sourceId}`);
  if (list) list.innerHTML = s.subforums.map((url, i) => subforumRowHTML(sourceId, i, url)).join('');
  refreshSubforumCount(sourceId);
}

function refreshSubforumCount(sourceId) {
  const s = SOURCES.find(x => x.id === sourceId);
  if (!s) return;
  const filledCount = s.subforums.filter(u => u.trim()).length;
  // update the label in every open settings panel
  document.querySelectorAll(`#sbody-${sourceId} .subforum-count`).forEach(el => {
    el.textContent = filledCount > 0 ? `(${filledCount})` : '';
  });
}


// =====================
// SEARCH
// =====================
const MOCK_RESULTS = [
  { source: 'Wykop.pl', icon: 'üî∫', type: 'social', color: '#fde8f0',
    title: 'Szukam polecenia na szkolenie z Excela dla ca≈Çego dzia≈Çu',
    snippet: 'Hej, mamy w firmie 15 os√≥b kt√≥re <mark>potrzebujƒÖ szkole≈Ñ</mark> z Excela (poziom ≈õredniozaawansowany). Bud≈ºet ok. 500z≈Ç/os. Czy kto≈õ przechodzi≈Ç przez co≈õ podobnego i mo≈ºe poleciƒá sprawdzone centrum szkoleniowe?',
    url: 'https://wykop.pl/link/przyk≈Çad',
    date: '2024-02-15', relevance: 95, keyword: 'szkolenia' },
  { source: '4programmers.net', icon: 'üë®‚Äçüíª', type: 'it', color: '#f0e8fc',
    title: 'Potrzebujƒô kogo≈õ do wdro≈ºenia systemu CRM ‚Äì ma≈Ça firma',
    snippet: 'Prowadzƒô 10-osobowƒÖ firmƒô us≈ÇugowƒÖ i <mark>szukam</mark> kogo≈õ kto pomo≈ºe nam wdro≈ºyƒá i skonfigurowaƒá CRM (najchƒôtniej HubSpot lub Pipedrive). P≈Çatne zlecenie, mo≈ºliwa d≈Çugoterminowa wsp√≥≈Çpraca.',
    url: 'https://4programmers.net/Forum/przyk≈Çad',
    date: '2024-02-18', relevance: 88, keyword: 'CRM wdro≈ºenie' },
  { source: 'OLX ‚Äì Us≈Çugi', icon: 'üìã', type: 'ogloszenia', color: '#fef3e2',
    title: 'Poszukujƒô dostawcy materia≈Ç√≥w biurowych ‚Äì umowa d≈Çugoterminowa',
    snippet: 'Firma z Wroc≈Çawia <mark>poszukuje</mark> rzetelnego dostawcy <mark>artyku≈Ç√≥w biurowych</mark>. Miesiƒôczne zam√≥wienia ok. 2000-3000 PLN. Interesuje nas faktura VAT i dostawa pod biuro.',
    url: 'https://olx.pl/oferta/przyk≈Çad',
    date: '2024-02-20', relevance: 97, keyword: 'artyku≈Çy biurowe' },
  { source: 'Bankier.pl Forum', icon: 'üè¶', type: 'biznes', color: '#e8f5f5',
    title: 'Czy kto≈õ mo≈ºe poleciƒá agencjƒô SEO dla e-commerce?',
    snippet: 'Prowadzƒô sklep internetowy z elektronikƒÖ. <mark>Szukam</mark> agencji SEO kt√≥ra ma do≈õwiadczenie z e-commerce i rozumie specyfikƒô bran≈ºy. Bud≈ºet od 3000 PLN/miesiƒÖc, mile widziane case studies.',
    url: 'https://forum.bankier.pl/przyk≈Çad',
    date: '2024-02-19', relevance: 82, keyword: 'agencja SEO' },
  { source: 'Reddit r/Polska', icon: 'ü§ñ', type: 'social', color: '#fde8f0',
    title: 'Polecacie kogo≈õ do sta≈Çej obs≈Çugi ksiƒôgowej? Startup, B2B',
    snippet: 'Zak≈Çadam sp√≥≈Çkƒô z o.o. i <mark>szukam</mark> biura rachunkowego kt√≥re ogarnie startup ‚Äì faktury, ZUS, KPiR. Chodzi mi o kogo≈õ z do≈õwiadczeniem ze startupami, nie klasyczne biuro.',
    url: 'https://reddit.com/r/Polska/przyk≈Çad',
    date: '2024-02-21', relevance: 90, keyword: 'ksiƒôgowo≈õƒá' },
  { source: 'Freelancer.pl', icon: 'üéØ', type: 'ogloszenia', color: '#fef3e2',
    title: 'Zlecƒô t≈Çumaczenie dokumentacji technicznej EN‚ÜíPL',
    snippet: 'Mam ok. 80 stron dokumentacji technicznej z bran≈ºy mechanicznej. <mark>Szukam</mark> t≈Çumacza z do≈õwiadczeniem w t≈Çumaczeniach technicznych. Termin: 2 tygodnie. Pytajcie o szczeg√≥≈Çy.',
    url: 'https://freelancer.pl/zlecenia/przyk≈Çad',
    date: '2024-02-17', relevance: 78, keyword: 't≈Çumaczenie' },
  { source: 'LinkedIn PL', icon: 'üíº', type: 'social', color: '#fde8f0',
    title: 'Looking for a content marketing agency ‚Äì B2B tech',
    snippet: 'We are a Polish SaaS company <mark>looking for</mark> a content marketing agency experienced in B2B tech. We need blog posts, case studies and LinkedIn content. DM me if interested.',
    url: 'https://linkedin.com/posts/przyk≈Çad',
    date: '2024-02-22', relevance: 85, keyword: 'content marketing' },
  { source: 'Elektroda.pl', icon: '‚ö°', type: 'forum', color: '#e8f0fc',
    title: 'Szukam serwisu laptop√≥w dla firmy ‚Äì Pozna≈Ñ lub zdalnie',
    snippet: 'Mamy flotƒô ok. 30 laptop√≥w s≈Çu≈ºbowych. <mark>Potrzebujƒô</mark> solidnego partnera serwisowego kt√≥ry odbierze sprzƒôt, naprawi i odda w rozsƒÖdnym czasie. Pytanie czy kto≈õ ma sprawdzone miejsce?',
    url: 'https://elektroda.pl/rtvforum/topic/przyk≈Çad',
    date: '2024-02-16', relevance: 72, keyword: 'serwis laptop√≥w' },
];

let currentResults = [];
let searching = false;
let selectedIndices = new Set();

function toggleSelect(idx, checked) {
  if (checked) selectedIndices.add(idx);
  else selectedIndices.delete(idx);
  document.getElementById(`ri-${idx}`).classList.toggle('selected', checked);
  // update select-all state
  const total = currentResults.length;
  document.getElementById('select-all-cb').checked = selectedIndices.size === total;
  document.getElementById('select-all-cb').indeterminate = selectedIndices.size > 0 && selectedIndices.size < total;
  updateBulkBar();
}

function toggleSelectAll(checked) {
  currentResults.forEach((_, i) => {
    if (checked) selectedIndices.add(i);
    else selectedIndices.delete(i);
    const el = document.getElementById(`ri-${i}`);
    if (el) el.classList.toggle('selected', checked);
    const cb = document.querySelector(`.result-checkbox[data-idx="${i}"]`);
    if (cb) cb.checked = checked;
  });
  updateBulkBar();
}

function updateBulkBar() {
  const bar = document.getElementById('bulk-bar');
  const count = selectedIndices.size;
  document.getElementById('bulk-count').textContent = count;
  bar.classList.toggle('visible', count > 0);
}

function bulkDeselect() {
  toggleSelectAll(false);
  document.getElementById('select-all-cb').checked = false;
  document.getElementById('select-all-cb').indeterminate = false;
}

function bulkSave() {
  let saved = 0;
  selectedIndices.forEach(i => {
    const btn = document.getElementById(`save-btn-${i}`);
    if (btn && !btn.dataset.saved) {
      saveLead(i, btn);
      saved++;
    }
  });
  const bar = document.getElementById('bulk-bar');
  const orig = document.getElementById('bulk-count').textContent;
  document.getElementById('bulk-bar').innerHTML = `<span style="color:#7effc0;font-weight:600;font-size:0.85rem">‚úÖ Zapisano ${saved} lead${saved === 1 ? '' : '√≥w'}!</span>`;
  setTimeout(() => {
    bulkDeselect();
    // restore bar content
    bar.innerHTML = `
      <div class="bulk-bar-count">Zaznaczono: <strong id="bulk-count">0</strong></div>
      <div class="bulk-bar-sep"></div>
      <button class="bulk-btn accent" onclick="bulkSave()">üîñ Zapisz zaznaczone</button>
      <button class="bulk-btn" onclick="bulkCopy()">üìã Kopiuj linki</button>
      <button class="bulk-btn danger" onclick="bulkDeselect()">‚úï Odznacz</button>
      <button class="bulk-deselect" onclick="bulkDeselect()" title="Zamknij">‚úï</button>`;
  }, 1800);
}

function bulkCopy() {
  const links = [...selectedIndices].map(i => currentResults[i]?.url).filter(Boolean).join('\n');
  navigator.clipboard.writeText(links).catch(() => {});
  const btn = document.querySelector('.bulk-btn:nth-child(3)');
  const orig = 'üìã Kopiuj linki';
  if (btn) { btn.textContent = `‚úÖ Skopiowano ${selectedIndices.size}`; setTimeout(() => { btn.textContent = orig; }, 2000); }
}


function setQuery(q) {
  document.getElementById('main-query').value = q;
  document.getElementById('main-query').focus();
}

function quickSearch(q) {
  setQuery(q);
  // Switch to search page
  document.getElementById('page-saved').style.display = 'none';
  document.getElementById('page-sources').style.display = 'none';
  document.getElementById('page-search').style.display = 'block';
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  document.querySelector('.nav-item').classList.add('active');
  document.getElementById('page-title').textContent = 'Szukaj klient√≥w';
  document.getElementById('page-subtitle').textContent = 'Przeszukuj fora i serwisy spo≈Çeczno≈õciowe';
  doSearch();
}

function doSearch() {
  if (searching) return;
  const query = document.getElementById('main-query').value.trim();
  if (!query) { document.getElementById('main-query').focus(); return; }

  searching = true;
  const btn = document.getElementById('search-btn');
  const icon = document.getElementById('search-btn-icon');
  btn.disabled = true;
  icon.textContent = '‚è≥';

  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('results-section').style.display = 'none';
  document.getElementById('stats-strip').style.display = 'none';
  document.getElementById('progress-bar').classList.add('active');

  const activeCount = SOURCES.filter(s => s.enabled).length;
  const delay = 1200 + Math.random() * 800;

  setTimeout(() => {
    // Simulate filtered results based on query keywords
    const qLow = query.toLowerCase();
    const shuffled = [...MOCK_RESULTS].sort(() => Math.random() - 0.5);
    currentResults = shuffled.slice(0, 4 + Math.floor(Math.random() * 4));
    // Inject query keyword into snippets
    currentResults = currentResults.map((r,i) => ({
      ...r,
      relevance: Math.max(65, r.relevance - i * 3 + Math.floor(Math.random() * 10))
    })).sort((a,b) => b.relevance - a.relevance);

    searching = false;
    btn.disabled = false;
    icon.textContent = 'üîç';
    document.getElementById('progress-bar').classList.remove('active');

    renderResults(query, activeCount);
  }, delay);
}

function renderResults(query, sourceCount) {
  const list = document.getElementById('results-list');
  const hotCount = currentResults.filter(r => r.relevance >= 88).length;
  selectedIndices.clear();
  updateBulkBar();

  list.innerHTML = currentResults.map((r, i) => `
    <div class="result-item" style="animation-delay:${i*60}ms" id="ri-${i}">
      <div class="result-checkbox-wrap">
        <input type="checkbox" class="result-checkbox" data-idx="${i}" onchange="toggleSelect(${i}, this.checked)">
      </div>
      <div class="result-source-icon" style="background:${r.color}">${r.icon}</div>
      <div class="result-body">
        <div class="result-source-label">${r.source} ${typeBadge(r.type)}</div>
        <div class="result-title"><a href="${r.url}" target="_blank">${r.title}</a></div>
        <div class="result-snippet">${r.snippet}</div>
        <div class="result-footer">
          <span class="result-date">üìÖ ${r.date}</span>
          <span class="result-keyword-tag">üè∑ ${r.keyword}</span>
          <div class="relevance-bar">
            <span class="relevance-label">${r.relevance}%</span>
            <div class="relevance-track"><div class="relevance-fill" style="width:${r.relevance}%"></div></div>
          </div>
          <div class="result-actions">
            <button class="result-btn" onclick="copyLink('${r.url}', this)">üìã Kopiuj</button>
            <button class="result-btn primary" onclick="saveLead(${i}, this)" id="save-btn-${i}">üîñ Zapisz lead</button>
          </div>
        </div>
      </div>
    </div>
  `).join('');

  document.getElementById('select-all-row').classList.add('visible');
  document.getElementById('select-all-cb').checked = false;

  document.getElementById('stat-results').textContent = currentResults.length;
  document.getElementById('stat-sources').textContent = sourceCount;
  document.getElementById('stat-hot').textContent = hotCount;
  document.getElementById('stat-saved').textContent = savedLeads.length;
  document.getElementById('stats-strip').style.display = 'flex';

  document.getElementById('results-title').textContent = `Wyniki dla: "${query}"`;
  document.getElementById('results-meta').textContent = `${currentResults.length} wynik√≥w ¬∑ ${sourceCount} ≈∫r√≥de≈Ç`;
  document.getElementById('results-section').style.display = 'block';
}

function copyLink(url, btn) {
  navigator.clipboard.writeText(url).catch(() => {});
  btn.textContent = '‚úÖ Skopiowano';
  setTimeout(() => { btn.textContent = 'üìã Kopiuj'; }, 2000);
}

function saveLead(idx, btn) {
  if (btn.dataset.saved) return;
  const r = currentResults[idx];
  if (!r) return;
  const lead = { ...r, savedAt: new Date().toLocaleDateString('pl-PL'), id: Date.now() };
  savedLeads.unshift(lead);
  localStorage.setItem('lh_saved', JSON.stringify(savedLeads));
  btn.dataset.saved = '1';
  btn.innerHTML = '‚úÖ Zapisano';
  btn.style.background = '#e8f5ee';
  btn.style.color = '#1a7a4a';
  btn.style.borderColor = 'rgba(26,122,74,0.3)';
  document.getElementById('saved-count').textContent = savedLeads.length;
  document.getElementById('stat-saved').textContent = savedLeads.length;
}

// =====================
// SAVED LEADS
// =====================
function renderSaved() {
  const list = document.getElementById('saved-list');
  const empty = document.getElementById('saved-empty');
  if (!savedLeads.length) {
    list.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';
  list.innerHTML = `
    <div class="results-header">
      <div class="results-title">Zapisane leady</div>
      <div class="results-meta">${savedLeads.length} lead√≥w ¬∑ <button onclick="clearSaved()" style="background:none;border:none;cursor:pointer;color:var(--red);font-size:0.72rem;font-family:'Outfit',sans-serif">Wyczy≈õƒá wszystkie</button></div>
    </div>
    ${savedLeads.map((r, i) => `
    <div class="result-item" style="animation-delay:${i*40}ms">
      <div class="result-source-icon" style="background:${r.color||'#e8f0fc'}">${r.icon}</div>
      <div class="result-body">
        <div class="result-source-label">${r.source} ${typeBadge(r.type)} <span class="saved-badge">‚úÖ Zapisano ${r.savedAt}</span></div>
        <div class="result-title"><a href="${r.url}" target="_blank">${r.title}</a></div>
        <div class="result-snippet">${r.snippet}</div>
        <div class="result-footer">
          <span class="result-date">üìÖ ${r.date}</span>
          <span class="result-keyword-tag">üè∑ ${r.keyword}</span>
          <div class="result-actions">
            <button class="result-btn" onclick="copyLink('${r.url}', this)">üìã Kopiuj</button>
            <button class="result-btn" style="color:var(--red);border-color:rgba(192,57,43,0.3)" onclick="removeLead(${r.id}, this)">üóë Usu≈Ñ</button>
          </div>
        </div>
      </div>
    </div>
  `).join('')}`;
}

function removeLead(id, btn) {
  savedLeads = savedLeads.filter(l => l.id !== id);
  localStorage.setItem('lh_saved', JSON.stringify(savedLeads));
  document.getElementById('saved-count').textContent = savedLeads.length;
  renderSaved();
}

function clearSaved() {
  if (!confirm('UsunƒÖƒá wszystkie zapisane leady?')) return;
  savedLeads = [];
  localStorage.setItem('lh_saved', JSON.stringify(savedLeads));
  document.getElementById('saved-count').textContent = '0';
  renderSaved();
}

// =====================
// SOURCE SEARCH
// =====================
function openSrcSearchModal() {
  document.getElementById('src-search-results').innerHTML = '';
  document.getElementById('src-paste-area').value = '';
  document.getElementById('src-search-modal-overlay').classList.add('open');
  setTimeout(() => document.getElementById('src-search-keyword').focus(), 80);
}

function closeSrcSearchModal() {
  document.getElementById('src-search-modal-overlay').classList.remove('open');
}

function buildSourceQuery() {
  const kw = document.getElementById('src-search-keyword').value.trim() || '‚Ä¶';
  return `szukam os√≥b poszukujƒÖcych ${kw} wynik prezentuj w postaci nazwy ≈∫r√≥d≈Ça, linku i kr√≥tkiego opisu w jednym zdaniu oraz znaczka [+] po ka≈ºdym ≈∫r√≥dle.`;
}

function openGoogleAISearch() {
  const query = buildSourceQuery();
  const url = 'https://www.google.com/search?udm=50&q=' + encodeURIComponent(query);
  window.open(url, '_blank');
}

function copySourceQuery() {
  const query = buildSourceQuery();
  navigator.clipboard.writeText(query).then(() => {
    const btn = document.querySelector('.src-search-copy-btn');
    const orig = btn.textContent;
    btn.textContent = '‚úì Skopiowano!';
    setTimeout(() => btn.textContent = orig, 1800);
  });
}

function analyzeSourceResults() {
  const text = document.getElementById('src-paste-area').value.trim();
  if (!text) return;
  const container = document.getElementById('src-search-results');

  // Split on [+] ‚Äî each chunk is one source entry
  const chunks = text.split(/\[\+\]/gi).map(c => c.trim()).filter(Boolean);
  if (!chunks.length) {
    container.innerHTML = '<div style="font-size:0.78rem;color:var(--text-dim);padding:8px 0">Nie znaleziono wynik√≥w w formacie z [+]. Upewnij siƒô, ≈ºe wklei≈Çe≈õ odpowied≈∫ Google AI.</div>';
    return;
  }

  const parsed = [];
  chunks.forEach(chunk => {
    // Remove leading bullets/numbers/markdown
    chunk = chunk.replace(/^\s*[\*\-\d\.\)]+\s*/, '').replace(/\*\*/g, '').trim();
    const urlMatch = chunk.match(/https?:\/\/[^\s,;\)]+/);
    if (!urlMatch) return;
    const url = urlMatch[0].replace(/[.,;)]+$/, '');
    const urlIdx = chunk.indexOf(urlMatch[0]);
    const namePart = chunk.substring(0, urlIdx).replace(/[,\-:]+$/, '').trim();
    const descPart = chunk.substring(urlIdx + urlMatch[0].length).replace(/^[,\-:\s]+/, '').trim();
    if (!namePart && !descPart) return;
    parsed.push({
      name: (namePart || url.replace(/https?:\/\/(www\.)?/, '').split('/')[0]).substring(0, 80),
      url,
      desc: descPart.substring(0, 220)
    });
  });

  if (!parsed.length) {
    container.innerHTML = '<div style="font-size:0.78rem;color:var(--text-dim);padding:8px 0">Nie uda≈Ço siƒô wyodrƒôbniƒá ≈∫r√≥de≈Ç. Sprawd≈∫ format wklejonego tekstu.</div>';
    return;
  }

  container.innerHTML = parsed.map((r, i) => `
    <div class="src-result-card" id="src-res-${i}">
      <div class="src-result-info">
        <div class="src-result-name">${r.name}</div>
        <div class="src-result-url">${r.url}</div>
        ${r.desc ? `<div class="src-result-desc">${r.desc}</div>` : ''}
      </div>
      <button class="src-result-add" id="src-add-btn-${i}" onclick="addSourceFromSearch(${i},'${encodeURIComponent(r.name)}','${encodeURIComponent(r.url)}')" title="Dodaj ≈∫r√≥d≈Ço">+</button>
    </div>`).join('');

  // Store parsed for later use
  window._srcSearchParsed = parsed;
}

function addSourceFromSearch(idx, encodedName, encodedUrl) {
  const name = decodeURIComponent(encodedName);
  const url  = decodeURIComponent(encodedUrl);
  const btn  = document.getElementById(`src-add-btn-${idx}`);

  // Mark as added
  btn.textContent = '‚úì';
  btn.classList.add('added');
  btn.disabled = true;

  // Pre-fill add source modal
  closeSrcSearchModal();
  document.getElementById('new-name').value = name;
  document.getElementById('new-baseurl').value = url;
  document.getElementById('new-url').value = '';
  document.getElementById('new-icon').value = 'üåê';
  document.getElementById('new-engine').value = 'google_site';
  document.getElementById('modal-overlay').classList.add('open');
  setTimeout(() => document.getElementById('new-name').select(), 80);
}

document.getElementById('src-search-modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeSrcSearchModal();
});

// =====================
// ADD SOURCE MODAL
// =====================
function openAddModal() {
  document.getElementById('modal-overlay').classList.add('open');
  document.getElementById('new-name').focus();
}
function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
}
function saveNewSource() {
  const name = document.getElementById('new-name').value.trim();
  if (!name) { document.getElementById('new-name').focus(); return; }
  const type = document.getElementById('new-type').value;
  const engine = document.getElementById('new-engine').value;
  const baseUrl = document.getElementById('new-baseurl').value.trim();
  const url = document.getElementById('new-url').value.trim();
  const icon = document.getElementById('new-icon').value.trim() || 'üåê';
  const colorMap = { forum:'#e8f0fc', social:'#fde8f0', portal:'#e8f5ee', ogloszenia:'#fef3e2', it:'#f0e8fc', biznes:'#e8f5f5' };
  const newId = nextId++;
  
  // Nowe ≈∫r√≥d≈Ço z pe≈ÇnƒÖ konfiguracjƒÖ
  SOURCES.push({ 
    id: newId, 
    name, 
    type, 
    icon, 
    color: colorMap[type], 
    enabled: true, 
    baseUrl, 
    engine, 
    subforums: url ? [url] : [''], 
    keywords: '', 
    desc: '', 
    favorite: false,
    dateAdded: new Date().toISOString().split('T')[0],
    loginRequired: true // domy≈õlnie wymagane logowanie
  });
  
  closeModal();
  document.getElementById('new-name').value = '';
  document.getElementById('new-baseurl').value = '';
  document.getElementById('new-url').value = '';
  document.getElementById('new-icon').value = '';
  document.getElementById('new-engine').value = 'internal';
  renderSources();
  renderSourcesManage();

  // Navigate to search page and highlight the new card
  ['search','saved','sources'].forEach(p => {
    document.getElementById(`page-${p}`).style.display = p === 'search' ? 'block' : 'none';
  });
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  document.querySelector('.nav-item').classList.add('active');
  document.getElementById('page-title').textContent = 'Szukaj klient√≥w';
  document.getElementById('page-subtitle').textContent = 'Przeszukuj fora i serwisy spo≈Çeczno≈õciowe';

  // Scroll to and flash the new card
  setTimeout(() => {
    // ≈πr√≥d≈Ço jest dodawane jako ulubione je≈õli favorite=false, wiƒôc bƒôdzie w sekcji "Pozosta≈Çe ≈∫r√≥d≈Ça"
    const card = document.getElementById(`scard-${newId}`);
    if (!card) return;
    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    card.style.transition = 'box-shadow 0.3s, outline 0.3s';
    card.style.outline = '2px solid var(--accent)';
    card.style.boxShadow = '0 0 0 4px rgba(232,93,38,0.2)';
    setTimeout(() => {
      card.style.outline = '';
      card.style.boxShadow = '';
    }, 2000);
  }, 120);
}

function cloneSource(id) {
  const s = SOURCES.find(x => x.id === id);
  if (!s) return;
  const newId = nextId++;
  const clone = {
    ...s,
    id: newId,
    name: s.name + ' (kopia)',
    favorite: false,
    dateAdded: new Date().toISOString().split('T')[0],
    subforums: s.subforums ? [...s.subforums] : [''],
  };
  SOURCES.push(clone);
  renderSources();
  renderSourcesManage();
  setTimeout(() => {
    const card = document.getElementById(`scard-${newId}`);
    if (!card) return;
    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    card.style.outline = '2px solid var(--accent)';
    card.style.boxShadow = '0 0 0 4px rgba(232,93,38,0.2)';
    setTimeout(() => { card.style.outline = ''; card.style.boxShadow = ''; }, 2000);
  }, 120);
}

// =====================
// IMPORT / EXPORT
// =====================
function exportSources() {
  const data = {
    version: 1,
    exportedAt: new Date().toISOString(),
    sources: SOURCES
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = `klienthunter-sources-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importSources() {
  const input = document.createElement('input');
  input.type   = 'file';
  input.accept = '.json';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      let imported;
      try {
        const parsed = JSON.parse(ev.target.result);
        imported = Array.isArray(parsed) ? parsed : (parsed.sources || []);
        if (!Array.isArray(imported) || imported.length === 0) throw new Error('Brak ≈∫r√≥de≈Ç');
        imported.forEach(s => { if (typeof s.id === 'undefined' || typeof s.name === 'undefined') throw new Error('Nieprawid≈Çowy format'); });
      } catch (err) {
        alert('B≈ÇƒÖd importu: ' + err.message + '\nUpewnij siƒô, ≈ºe plik pochodzi z eksportu KlientHunter.');
        return;
      }
      const mode = confirm(
        `Znaleziono ${imported.length} ≈∫r√≥de≈Ç.\n\nOK ‚Üí Do≈ÇƒÖcz do istniejƒÖcych (zalecane)\nAnuluj ‚Üí ZastƒÖp wszystkie`
      );
      if (mode) {
        // Do≈ÇƒÖcz ‚Äî generuj nowe ID, aby uniknƒÖƒá konflikt√≥w
        imported.forEach(s => {
          const newId = nextId++;
          SOURCES.push({ ...s, id: newId, dateAdded: s.dateAdded || new Date().toISOString().split('T')[0] });
        });
      } else {
        // ZastƒÖp
        SOURCES.length = 0;
        imported.forEach(s => SOURCES.push({ ...s }));
        nextId = Math.max(...SOURCES.map(s => s.id), 0) + 1;
      }
      renderSources();
      renderSourcesManage();
    };
    reader.readAsText(file);
  };
  input.click();
}

document.getElementById('kw-modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeKwModal();
});
document.getElementById('modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
document.getElementById('login-modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeLoginModal();
});
document.getElementById('src-cred-modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeSrcCredModal();
});

// =====================
// SOURCE CREDENTIALS
// =====================
function getCredsKey() {
  // Per-user storage key
  const uid = currentUser ? currentUser.email : '__guest__';
  return `lh_creds_${uid}`;
}

function loadCreds() {
  return JSON.parse(localStorage.getItem(getCredsKey()) || '{}');
}

function saveCreds(creds) {
  localStorage.setItem(getCredsKey(), JSON.stringify(creds));
}

function getSourceCred(sourceId) {
  const creds = loadCreds();
  return creds[sourceId] || null;
}

function srcLoginBtnHTML(sourceId) {
  const cred = getSourceCred(sourceId);
  if (cred) {
    return `<button class="src-login-btn logged-in" onclick="openSrcCredModal(${sourceId})" title="Zalogowany jako: ${cred.login}\nKliknij aby zmieniƒá lub usunƒÖƒá">
      <div class="src-lamp on"></div> ${cred.login}
    </button>`;
  }
  return `<button class="src-login-btn" onclick="openSrcCredModal(${sourceId})">
    <div class="src-lamp off"></div> Dodaj login
  </button>`;
}

let srcCredEditingId = null;

function openSrcCredModal(sourceId) {
  if (!currentUser) {
    alert('Zaloguj siƒô do systemu, aby zarzƒÖdzaƒá loginami do ≈∫r√≥de≈Ç.');
    return;
  }
  srcCredEditingId = sourceId;
  const s = SOURCES.find(x => x.id === sourceId);
  const cred = getSourceCred(sourceId);

  document.getElementById('src-cred-info').innerHTML = `
    <div class="src-cred-icon" style="background:${s.color||'#e8f0fc'}">${s.icon}</div>
    <div>
      <div class="src-cred-name">${s.name}</div>
      <div class="src-cred-url">${s.baseUrl || ''}</div>
    </div>`;
  document.getElementById('src-cred-login').value = cred ? cred.login : '';
  document.getElementById('src-cred-pass').value  = cred ? cred.pass  : '';
  document.getElementById('src-cred-pass').type = 'password';
  document.getElementById('pass-toggle-btn').textContent = 'üëÅ';
  document.getElementById('src-cred-modal-overlay').classList.add('open');
  setTimeout(() => document.getElementById('src-cred-login').focus(), 100);
}

function closeSrcCredModal() {
  document.getElementById('src-cred-modal-overlay').classList.remove('open');
  srcCredEditingId = null;
}

function togglePassVis() {
  const inp = document.getElementById('src-cred-pass');
  const btn = document.getElementById('pass-toggle-btn');
  if (inp.type === 'password') { inp.type = 'text'; btn.textContent = 'üôà'; }
  else { inp.type = 'password'; btn.textContent = 'üëÅ'; }
}

function updateCredsBadge() {
  if (!currentUser) {
    document.getElementById('creds-count').style.display = 'none';
    return;
  }
  const count = Object.keys(loadCreds()).length;
  const badge = document.getElementById('creds-count');
  badge.textContent = count;
  badge.style.display = count > 0 ? 'inline-flex' : 'none';
}

function saveSrcCred() {
  const login = document.getElementById('src-cred-login').value.trim();
  const pass  = document.getElementById('src-cred-pass').value;
  if (!login) { document.getElementById('src-cred-login').focus(); return; }
  const creds = loadCreds();
  creds[srcCredEditingId] = { login, pass };
  saveCreds(creds);
  closeSrcCredModal();
  updateCredsBadge();
  // refresh all views
  if (document.getElementById('page-sources').style.display !== 'none') renderSourcesManage();
  if (document.getElementById('page-credentials').style.display !== 'none') renderCredentials();
}

function clearSrcCred(sourceId) {
  if (!confirm('UsunƒÖƒá dane logowania dla tego ≈∫r√≥d≈Ça?')) return;
  const creds = loadCreds();
  delete creds[sourceId];
  saveCreds(creds);
  updateCredsBadge();
  renderCredentials();
  if (document.getElementById('page-sources').style.display !== 'none') renderSourcesManage();
}

let credsGroupBy = 'status';

function setCredsGroup(mode, btn) {
  if (credsGroupBy === mode) {
    credsGroupBy = 'none';
    btn.classList.remove('active');
  } else {
    credsGroupBy = mode;
    document.querySelectorAll('#cg-btn-status,#cg-btn-name').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }
  renderCredentials();
}

function renderCredentials() {
  const container = document.getElementById('creds-content');
  const notice = document.getElementById('creds-notice');

  if (!currentUser) {
    notice.style.display = 'flex';
    container.innerHTML = `<div class="empty-state"><div class="icon">üîê</div><h3>Wymagane logowanie</h3><p>Zaloguj siƒô do systemu (przycisk w prawym g√≥rnym rogu),<br>aby zarzƒÖdzaƒá loginami do poszczeg√≥lnych ≈∫r√≥de≈Ç.</p></div>`;
    return;
  }

  notice.style.display = 'none';
  ['status','name'].forEach(m => {
    const b = document.getElementById('cg-btn-'+m);
    if (b) b.classList.toggle('active', credsGroupBy === m);
  });
  const creds = loadCreds();
  const initials = currentUser.name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);

  function makeRow(s) {
    const cred = creds[s.id];
    const maskedPass = cred && cred.pass ? '‚Ä¢'.repeat(Math.min(cred.pass.length, 10)) : '';
    return `
      <tr>
        <td><div class="slt-icon" style="background:${s.color||'#e8f0fc'}">${s.icon}</div></td>
        <td>
          <div class="creds-source-name">${s.name}</div>
          ${s.baseUrl ? `<a class="source-base-url" href="${s.baseUrl}" target="_blank">üîó ${s.baseUrl.replace('https://','').replace('www.','')}</a>` : ''}
        </td>
        <td>${cred ? `<span class="creds-login-val">${cred.login}</span>` : '<span class="creds-empty">‚Äî</span>'}</td>
        <td>${cred && cred.pass ? `<span class="creds-pass-val">${maskedPass}</span>` : '<span class="creds-empty">‚Äî</span>'}</td>
        <td>
          ${cred
            ? `<span class="creds-status set">‚óè Skonfigurowane</span>`
            : `<span class="creds-status unset">‚óã Brak</span>`}
        </td>
        <td style="white-space:nowrap">
          <button class="creds-edit-btn" onclick="openSrcCredModal(${s.id})">${cred ? '‚úè Zmie≈Ñ' : '+ Dodaj'}</button>
          ${cred ? `<button class="creds-clear-btn" onclick="clearSrcCred(${s.id})">üóë</button>` : ''}
        </td>
      </tr>`;
  }

  function makeGroupHeader(label, count, extraClass) {
    return `<tr class="creds-group-header${extraClass ? ' '+extraClass : ''}"><td colspan="6"><span class="creds-group-label">${label}</span><span class="creds-group-count">${count}</span></td></tr>`;
  }

  let rows = '';
  if (credsGroupBy === 'status') {
    const loggedIn  = SOURCES.filter(s => creds[s.id]);
    const loggedOut = SOURCES.filter(s => !creds[s.id]);
    if (loggedIn.length) {
      rows += makeGroupHeader('Zalogowane', loggedIn.length, 'status-set');
      rows += loggedIn.map(makeRow).join('');
    }
    if (loggedOut.length) {
      rows += makeGroupHeader('Niezalogowane', loggedOut.length, 'status-unset');
      rows += loggedOut.map(makeRow).join('');
    }
  } else if (credsGroupBy === 'name') {
    const nameMap = {};
    SOURCES.forEach(s => {
      if (!nameMap[s.name]) nameMap[s.name] = [];
      nameMap[s.name].push(s);
    });
    Object.entries(nameMap).sort((a,b) => a[0].localeCompare(b[0], 'pl')).forEach(([name, sources]) => {
      rows += makeGroupHeader(name, sources.length);
      rows += sources.map(makeRow).join('');
    });
  } else {
    rows = SOURCES.map(makeRow).join('');
  }

  container.innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
      <div class="login-avatar" style="width:30px;height:30px;font-size:0.75rem">${initials}</div>
      <div>
        <div style="font-weight:700;font-size:0.85rem">${currentUser.name}</div>
        <div style="font-size:0.65rem;font-family:'JetBrains Mono',monospace;color:var(--text-dim)">${currentUser.email}</div>
      </div>
    </div>
    <table class="creds-table">
      <thead><tr>
        <th style="width:44px"></th>
        <th>≈πr√≥d≈Ço</th>
        <th>Login</th>
        <th>Has≈Ço</th>
        <th>Status</th>
        <th>Akcje</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

// =====================
// KEYWORDS
// =====================
function getDefaultKeywordSets() {
  return [
    {
      id: 10001, name: 'Frazy og√≥lne',
      phrases: ['szukam', 'potrzebujƒô', 'polecacie', 'poszukujƒô', 'pomo≈ºecie'],
      links: [
        { sourceId: 1,  subforum: '' },
        { sourceId: 3,  subforum: '' },
        { sourceId: 9,  subforum: 'https://www.olx.pl/uslugi/' },
        { sourceId: 11, subforum: 'https://reddit.com/r/Polska/' },
        { sourceId: 12, subforum: '' },
      ]
    },
    {
      id: 10002, name: 'Frazy IT i programowanie',
      phrases: ['szukam', 'potrzebujƒô', 'pomoc', 'oferta', 'zlecƒô', 'szukam wykonawcy'],
      links: [
        { sourceId: 2,  subforum: 'https://4programmers.net/Forum/Praca' },
        { sourceId: 2,  subforum: 'https://4programmers.net/Forum/Oferty' },
        { sourceId: 11, subforum: 'https://reddit.com/r/PracaIT/' },
        { sourceId: 13, subforum: 'https://freelancer.pl/zlecenia/' },
      ]
    },
    {
      id: 10003, name: 'Frazy biznesowe',
      phrases: ['szukam dostawcy', 'polecacie firmƒô', 'potrzebujƒô us≈Çugi', 'firma'],
      links: [
        { sourceId: 4, subforum: 'https://forum.bankier.pl/' },
      ]
    },
    {
      id: 10004, name: 'Frazy prawne',
      phrases: ['szukam prawnika', 'potrzebujƒô porady', 'pomoc prawna'],
      links: [
        { sourceId: 15, subforum: '' },
      ]
    },
    {
      id: 10005, name: 'Frazy rekrutacja i praca',
      phrases: ['szukam', 'hiring', 'rekrutacja', 'oferta', 'looking for', 'need vendor'],
      links: [
        { sourceId: 5, subforum: '' },
        { sourceId: 6, subforum: '' },
      ]
    },
    {
      id: 10006, name: 'Frazy edukacja i szkolenia',
      phrases: ['szukam szkolenia', 'potrzebujƒô kursu', 'szukam kursu'],
      links: [
        { sourceId: 14, subforum: '' },
      ]
    },
  ];
}

let KEYWORD_SETS = (() => {
  const stored = localStorage.getItem('lh_kw_sets');
  if (stored) return JSON.parse(stored);
  const defaults = getDefaultKeywordSets();
  localStorage.setItem('lh_kw_sets', JSON.stringify(defaults));
  return defaults;
})();
let editingKwId = null;

function saveKeywordSets() {
  localStorage.setItem('lh_kw_sets', JSON.stringify(KEYWORD_SETS));
}

function syncKeywordSetsToSources() {
  SOURCES.forEach(src => {
    const linked = KEYWORD_SETS.filter(ks => ks.links.some(l => l.sourceId === src.id));
    if (!linked.length) return;
    const merged = [...new Set(linked.flatMap(ks => ks.phrases))];
    src.keywords = merged.join(', ');
  });
}

function getSourceKwSetsHTML(sourceId) {
  const linked = KEYWORD_SETS.filter(ks => ks.links.some(l => l.sourceId === sourceId));
  if (!linked.length)
    return `<span style="font-size:0.7rem;color:var(--text-dim);font-style:italic">Brak ‚Äî dodaj w zak≈Çadce Frazy i s≈Çowa kluczowe</span>`;
  return linked.map(ks => `<span class="kw-phrase" style="margin-right:3px;margin-bottom:3px">${ks.name}</span>`).join('');
}

syncKeywordSetsToSources();

function renderKeywords() {
  const container = document.getElementById('keywords-content');
  if (!KEYWORD_SETS.length) {
    container.innerHTML = `<div class="empty-state"><div class="icon">üè∑Ô∏è</div><h3>Brak zestaw√≥w fraz</h3><p>Kliknij ‚Äû+ Dodaj zestaw" aby stworzyƒá pierwszy zestaw s≈Ç√≥w kluczowych.</p></div>`;
    return;
  }
  const cards = KEYWORD_SETS.map(set => {
    const shown = set.phrases.slice(0, 6).map(p => `<span class="kw-phrase">${p}</span>`).join('');
    const more  = set.phrases.length > 6 ? `<span class="kw-phrase kw-phrase-more">+${set.phrases.length - 6} wiƒôcej</span>` : '';
    const linkedRows = set.links.map(l => {
      const src = SOURCES.find(s => s.id === l.sourceId);
      if (!src) return '';
      const sub = l.subforum
        ? l.subforum.replace(/https?:\/\/(www\.)?/,'').replace(/\/$/,'').split('/').slice(-2).join('/')
        : 'Wszystkie podlinki';
      return `<div class="kw-link-row">
        <div class="slt-icon" style="background:${src.color||'#e8f0fc'};width:20px;height:20px;font-size:0.65rem;flex-shrink:0">${src.icon}</div>
        <span class="kw-link-name">${src.name}</span>
        <span class="kw-link-sub" title="${l.subforum||''}">${sub}</span>
      </div>`;
    }).join('');
    return `
      <div class="kw-card">
        <div class="kw-card-header">
          <span class="kw-card-name" title="${set.name}">${set.name}</span>
          <div class="kw-card-actions">
            <button class="creds-edit-btn" onclick="openKwModal(${set.id})">‚úè Edytuj</button>
            <button class="creds-clear-btn" onclick="deleteKwSet(${set.id})">üóë</button>
          </div>
        </div>
        <div class="kw-card-body">
          <div>
            <div class="kw-section-label">Frazy (${set.phrases.length})</div>
            <div class="kw-phrases">${shown}${more}</div>
          </div>
          ${set.links.length
            ? `<div><div class="kw-section-label">PowiƒÖzane ≈∫r√≥d≈Ça (${set.links.length})</div>${linkedRows}</div>`
            : '<div class="kw-no-links">Brak powiƒÖzanych ≈∫r√≥de≈Ç</div>'}
        </div>
      </div>`;
  }).join('');
  container.innerHTML = `<div class="kw-card-grid">${cards}</div>`;
}

function openKwModal(id = null) {
  editingKwId = id || null;
  const set = id ? KEYWORD_SETS.find(s => s.id === id) : null;
  document.getElementById('kw-modal-title').textContent = set ? 'Edytuj zestaw fraz' : 'Dodaj zestaw fraz';
  document.getElementById('kw-modal-name').value = set ? set.name : '';
  document.getElementById('kw-modal-phrases').value = set ? set.phrases.join('\n') : '';
  const linksMap = {};
  if (set) set.links.forEach(l => { linksMap[l.sourceId] = l.subforum; });
  const rows = SOURCES.map(s => {
    const checked = s.id in linksMap;
    if (!s.subforums) s.subforums = s.subforum ? [s.subforum] : [''];
    const subs = s.subforums.filter(u => u.trim());
    const opts = ['', ...subs].map(u =>
      `<option value="${u}" ${linksMap[s.id] === u ? 'selected' : ''}>${u ? u.replace(/https?:\/\/(www\.)?/,'').replace(/\/$/,'') : 'Wszystkie podlinki'}</option>`
    ).join('');
    const sel = subs.length
      ? `<select class="kw-sub-select" id="kwsub-${s.id}" style="${checked ? '' : 'display:none'}">${opts}</select>`
      : '';
    return `<label class="kw-source-row">
      <input type="checkbox" class="kw-src-cb" data-id="${s.id}" ${checked ? 'checked' : ''} onchange="toggleKwSource(${s.id})">
      <div class="slt-icon" style="background:${s.color||'#e8f0fc'};width:22px;height:22px;font-size:0.7rem;flex-shrink:0">${s.icon}</div>
      <span class="kw-src-name">${s.name}</span>
      ${sel}
    </label>`;
  }).join('');
  document.getElementById('kw-source-picker').innerHTML = rows;
  document.getElementById('kw-modal-overlay').classList.add('open');
  setTimeout(() => document.getElementById('kw-modal-name').focus(), 80);
}

function toggleKwSource(sourceId) {
  const cb  = document.querySelector(`.kw-src-cb[data-id="${sourceId}"]`);
  const sel = document.getElementById(`kwsub-${sourceId}`);
  if (sel) sel.style.display = cb.checked ? '' : 'none';
}

function saveKwSet() {
  const name = document.getElementById('kw-modal-name').value.trim();
  if (!name) { document.getElementById('kw-modal-name').focus(); return; }
  const phrases = document.getElementById('kw-modal-phrases').value
    .split('\n').map(p => p.trim()).filter(Boolean);
  const links = [];
  document.querySelectorAll('.kw-src-cb:checked').forEach(cb => {
    const sourceId = parseInt(cb.dataset.id);
    const sel = document.getElementById(`kwsub-${sourceId}`);
    links.push({ sourceId, subforum: sel ? sel.value : '' });
  });
  if (editingKwId) {
    const set = KEYWORD_SETS.find(s => s.id === editingKwId);
    if (set) { set.name = name; set.phrases = phrases; set.links = links; }
  } else {
    KEYWORD_SETS.push({ id: Date.now(), name, phrases, links });
  }
  saveKeywordSets();
  syncKeywordSetsToSources();
  closeKwModal();
  renderKeywords();
  if (document.getElementById('page-sources').style.display !== 'none') renderSourcesManage();
}

function deleteKwSet(id) {
  if (!confirm('UsunƒÖƒá ten zestaw fraz?')) return;
  KEYWORD_SETS = KEYWORD_SETS.filter(s => s.id !== id);
  saveKeywordSets();
  syncKeywordSetsToSources();
  renderKeywords();
  if (document.getElementById('page-sources').style.display !== 'none') renderSourcesManage();
}

function closeKwModal() {
  document.getElementById('kw-modal-overlay').classList.remove('open');
}

// =====================
// ENGINES
// =====================
const ENGINE_META = {
  internal:    { label: 'Wewnƒôtrzna wyszukiwarka', color: '#6c63ff' },
  google:      { label: 'Google',                  color: '#4285F4' },
  google_site: { label: 'Google (site:)',           color: '#34A853' },
  bing:        { label: 'Bing',                    color: '#008272' },
  duckduckgo:  { label: 'DuckDuckGo',              color: '#DE5833' },
};

function renderEngines() {
  const container = document.getElementById('engines-content');
  const order = ['internal','google','google_site','bing','duckduckgo'];

  const cards = order.map(key => {
    const meta = ENGINE_META[key] || { label: key, color: '#999' };
    const sources = SOURCES.filter(s => (s.engine || 'internal') === key);
    if (!sources.length) return '';

    const rows = sources.map(s => {
      const domain = s.baseUrl ? s.baseUrl.replace('https://','').replace('http://','').replace('www.','').split('/')[0] : '';
      return `
        <div class="engine-source-row">
          <div class="engine-source-icon" style="background:${s.color||'#e8f0fc'}">${s.icon}</div>
          <div style="flex:1;min-width:0">
            <div class="engine-source-name">${s.name}</div>
            ${domain ? `<div class="engine-source-url" title="${s.baseUrl}">${domain}</div>` : ''}
          </div>
          <div class="engine-source-status ${s.enabled ? 'on' : 'off'}" title="${s.enabled ? 'Aktywne' : 'Nieaktywne'}"></div>
        </div>`;
    }).join('');

    return `
      <div class="engine-card">
        <div class="engine-card-header">
          <div class="engine-card-dot" style="background:${meta.color};box-shadow:0 0 6px ${meta.color}88"></div>
          <div class="engine-card-name">${meta.label}</div>
          <div class="engine-card-count">${sources.length} ≈∫r√≥de≈Ç</div>
        </div>
        <div class="engine-source-list">${rows}</div>
      </div>`;
  }).join('');

  container.innerHTML = cards
    ? `<div class="engines-grid">${cards}</div>`
    : `<div class="empty-state"><div class="icon">üîé</div><h3>Brak ≈∫r√≥de≈Ç</h3></div>`;
}

// =====================
// LOGIN
// =====================
let currentUser = JSON.parse(localStorage.getItem('lh_user') || 'null');

function updateLoginUI() {
  const lamp = document.getElementById('login-lamp');
  const label = document.getElementById('login-btn-label');
  if (currentUser) {
    lamp.className = 'login-lamp lamp-logged-in';
    label.textContent = currentUser.name.split(' ')[0];
  } else {
    lamp.className = 'login-lamp lamp-logged-out';
    label.textContent = 'Zaloguj siƒô';
  }
}

function openLoginModal() {
  const overlay = document.getElementById('login-modal-overlay');
  overlay.classList.add('open');
  if (currentUser) {
    document.getElementById('login-form-view').style.display = 'none';
    document.getElementById('login-logged-view').style.display = 'block';
    const initials = currentUser.name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
    document.getElementById('login-avatar').textContent = initials;
    document.getElementById('login-user-name').textContent = currentUser.name;
    document.getElementById('login-user-email').textContent = currentUser.email;
  } else {
    document.getElementById('login-form-view').style.display = 'block';
    document.getElementById('login-logged-view').style.display = 'none';
    setTimeout(() => document.getElementById('login-email').focus(), 100);
  }
}

function closeLoginModal() {
  document.getElementById('login-modal-overlay').classList.remove('open');
  document.getElementById('login-error').style.display = 'none';
}

function doLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass  = document.getElementById('login-password').value;
  const err   = document.getElementById('login-error');
  if (!email || !pass) { err.textContent = 'Uzupe≈Çnij email i has≈Ço.'; err.style.display='block'; return; }
  if (pass.length < 4) { err.textContent = 'Has≈Ço jest za kr√≥tkie.'; err.style.display='block'; return; }
  // Demo: accept any valid-looking credentials
  const name = email.split('@')[0].replace(/[._]/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
  currentUser = { name, email };
  localStorage.setItem('lh_user', JSON.stringify(currentUser));
  updateLoginUI();
  updateCredsBadge();
  closeLoginModal();
}

function doLogout() {
  currentUser = null;
  localStorage.removeItem('lh_user');
  updateLoginUI();
  updateCredsBadge();
  closeLoginModal();
}

// =====================
// INIT
// =====================
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('saved-count').textContent = savedLeads.length;
  updateLoginUI();
  updateCredsBadge();
  renderSources();
});
</script>
</body>
</html>
