<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lead Hunter</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f3ee;
  --surface: #ffffff;
  --surface2: #f0ede6;
  --border: #e2ddd4;
  --border2: #ccc7bc;
  --accent: #e85d26;
  --accent2: #c44d1a;
  --accent-light: rgba(232,93,38,0.1);
  --text: #1a1714;
  --text-mid: #5a5448;
  --text-dim: #9a9082;
  --green: #1a7a4a;
  --green-bg: #e8f5ee;
  --yellow: #b07800;
  --yellow-bg: #fef3e2;
  --red: #c0392b;
  --red-bg: #fdecea;
  --blue: #2563a8;
  --blue-bg: #e8f0fc;
  --shadow: 0 2px 12px rgba(0,0,0,0.07);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.10);
  --sidebar-bg: #1a1714;
}

/* DARK THEME */
html[data-theme="dark"] {
  --bg: #111010;
  --surface: #1c1a17;
  --surface2: #242220;
  --border: #2e2a25;
  --border2: #3a3530;
  --accent-light: rgba(232,93,38,0.15);
  --text: #f0ede6;
  --text-mid: #a8a098;
  --text-dim: #6a6058;
  --green: #2da866;
  --green-bg: rgba(26,122,74,0.15);
  --yellow: #d4a017;
  --yellow-bg: rgba(176,120,0,0.15);
  --red: #e05545;
  --red-bg: rgba(192,57,43,0.15);
  --blue: #4d8fd4;
  --blue-bg: rgba(37,99,168,0.15);
  --shadow: 0 2px 12px rgba(0,0,0,0.3);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
  --sidebar-bg: #0a0908;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  min-height: 100vh;
}

/* LAYOUT */
.app { display: flex; min-height: 100vh; }

/* SIDEBAR */
.sidebar {
  width: 300px;
  flex-shrink: 0;
  background: var(--sidebar-bg);
  color: #fff;
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0; left: 0; bottom: 0;
  overflow-y: auto;
  z-index: 200;
}

.sidebar-logo {
  padding: 28px 24px 20px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.sidebar-logo .brand {
  font-size: 1.25rem;
  font-weight: 800;
  letter-spacing: -0.02em;
  color: #fff;
}
.sidebar-logo .brand span { color: var(--accent); }
.sidebar-logo .tagline {
  font-size: 0.72rem;
  color: rgba(255,255,255,0.4);
  margin-top: 3px;
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 0.04em;
}

.sidebar-nav {
  padding: 12px 0;
  flex: 1;
}
.nav-section-label {
  font-size: 0.6rem;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: rgba(255,255,255,0.3);
  padding: 12px 24px 6px;
  font-family: 'JetBrains Mono', monospace;
}
.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 9px 24px;
  cursor: pointer;
  transition: background 0.12s;
  font-size: 0.88rem;
  color: rgba(255,255,255,0.7);
  font-weight: 500;
  border: none;
  background: none;
  width: 100%;
  text-align: left;
}
.nav-item:hover { background: rgba(255,255,255,0.06); color: #fff; }
.nav-item.active { background: rgba(232,93,38,0.18); color: #fff; }
.nav-item.active .nav-icon { color: var(--accent); }
.nav-icon { font-size: 1rem; width: 18px; text-align: center; opacity: 0.9; }
.nav-badge {
  margin-left: auto;
  background: var(--accent);
  color: #fff;
  font-size: 0.6rem;
  font-family: 'JetBrains Mono', monospace;
  padding: 1px 6px;
  border-radius: 10px;
  font-weight: 700;
}

/* MAIN */
.main {
  margin-left: 300px;
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

.topbar {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 16px 36px;
  display: flex;
  align-items: center;
  gap: 16px;
  position: sticky;
  top: 0;
  z-index: 100;
}
.page-title {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text);
}
.page-subtitle {
  font-size: 0.75rem;
  color: var(--text-dim);
  margin-left: 2px;
}

.content { padding: 32px 36px; flex: 1; }

/* SEARCH BAR */
.search-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px 24px;
  margin-bottom: 28px;
  box-shadow: var(--shadow);
}
.search-box-label {
  font-size: 0.7rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-dim);
  margin-bottom: 10px;
}
.search-row {
  display: flex;
  gap: 12px;
  align-items: center;
}
.search-input {
  flex: 1;
  font-family: 'Outfit', sans-serif;
  font-size: 1rem;
  font-weight: 500;
  padding: 12px 16px;
  border: 2px solid var(--border);
  border-radius: 8px;
  background: var(--bg);
  color: var(--text);
  outline: none;
  transition: border-color 0.15s;
}
.search-input:focus { border-color: var(--accent); }
.search-input::placeholder { color: var(--text-dim); font-weight: 400; }
.search-btn {
  font-family: 'Outfit', sans-serif;
  font-size: 0.9rem;
  font-weight: 700;
  padding: 12px 28px;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.15s, transform 0.1s;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 8px;
}
.search-btn:hover { background: var(--accent2); transform: translateY(-1px); }
.search-btn:active { transform: none; }
.search-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

.search-tags {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 12px;
  align-items: center;
}
.search-tag-label { font-size: 0.72rem; color: var(--text-dim); }
.preset-tag {
  font-size: 0.75rem;
  padding: 4px 12px;
  border: 1px solid var(--border2);
  border-radius: 20px;
  background: var(--surface2);
  color: var(--text-mid);
  cursor: pointer;
  transition: all 0.12s;
  font-family: 'Outfit', sans-serif;
}
.preset-tag:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }

/* SOURCES GRID */
.sources-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}
.sources-title {
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-dim);
}
.sources-controls {
  display: flex;
  align-items: center;
  gap: 10px;
}
.sort-dropdown {
  font-family: 'Outfit', sans-serif;
  font-size: 0.7rem;
  font-weight: 600;
  padding: 5px 10px;
  background: var(--surface);
  border: 1px solid var(--border2);
  color: var(--text-mid);
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.12s;
}
.sort-dropdown:hover { border-color: var(--accent); color: var(--accent); }
.add-source-btn {
  font-family: 'Outfit', sans-serif;
  font-size: 0.78rem;
  font-weight: 600;
  padding: 6px 14px;
  background: var(--surface);
  border: 1px solid var(--border2);
  color: var(--text-mid);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.12s;
}
.add-source-btn:hover { border-color: var(--accent); color: var(--accent); }
.io-btn { font-family: 'Outfit', sans-serif; font-size: 0.78rem; font-weight: 600; padding: 6px 12px; background: var(--surface); border: 1px solid var(--border2); color: var(--text-dim); border-radius: 6px; cursor: pointer; transition: all 0.12s; display:flex; align-items:center; gap:5px; }
.io-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }

.sources-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 14px;
  margin-bottom: 32px;
}

@media (max-width: 768px) {
  .sources-grid {
    grid-template-columns: 1fr;
    gap: 12px;
  }
}

@media (max-width: 480px) {
  .source-card {
    margin: 0 -10px;
  }
  .content {
    padding: 20px 26px;
  }
}

.source-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  box-shadow: var(--shadow);
  transition: box-shadow 0.15s, border-color 0.15s;
}
.source-card:hover { box-shadow: var(--shadow-lg); border-color: var(--border2); }

.source-card-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 14px 16px 10px;
  position: relative;
}
.favorite-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  background: none;
  border: none;
  font-size: 1rem;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: all 0.12s;
  opacity: 0.4;
}
.favorite-btn:hover { opacity: 1; background: rgba(0,0,0,0.05); }
.favorite-btn.active { opacity: 1; color: #f59e0b; }
.login-status-lamp {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  position: absolute;
  top: 10px;
  right: 32px;
  box-shadow: 0 0 4px currentColor;
}
.login-status-lamp.logged-in {
  background: var(--green);
  color: var(--green);
}
.login-status-lamp.logged-out {
  background: var(--red);
  color: var(--red);
}
.login-status-lamp.not-applicable {
  background: var(--yellow);
  color: var(--yellow);
}
.source-icon {
  width: 34px; height: 34px;
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.1rem;
  flex-shrink: 0;
}
.source-info { flex: 1; min-width: 0; }
.source-name {
  font-weight: 700;
  font-size: 0.88rem;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.source-type-badge {
  font-size: 0.6rem;
  font-family: 'JetBrains Mono', monospace;
  padding: 1px 6px;
  border-radius: 3px;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-top: 2px;
  display: inline-block;
}
.badge-forum { background: #e8f0fc; color: #2563a8; }
.badge-social { background: #fde8f0; color: #a8254f; }
.badge-portal { background: #e8f5ee; color: #1a7a4a; }
.badge-ogloszenia { background: #fef3e2; color: #b07800; }
.badge-it { background: #f0e8fc; color: #6a25a8; }
.badge-biznes { background: #e8f5f5; color: #1a7a7a; }

.source-toggle {
  position: relative;
  width: 36px; height: 20px;
  flex-shrink: 0;
}
.source-toggle input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
  position: absolute; inset: 0;
  background: var(--border2);
  border-radius: 20px;
  cursor: pointer;
  transition: background 0.2s;
}
.toggle-slider::before {
  content: '';
  position: absolute;
  width: 14px; height: 14px;
  left: 3px; top: 3px;
  background: #fff;
  border-radius: 50%;
  transition: transform 0.2s;
}
input:checked + .toggle-slider { background: var(--accent); }
input:checked + .toggle-slider::before { transform: translateX(16px); }

.source-card-body {
  padding: 0 16px 14px;
  border-top: 1px solid var(--border);
  display: none;
}
.source-card-body.open { display: block; padding-top: 12px; }

.field-label {
  font-size: 0.65rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-dim);
  margin-bottom: 5px;
  margin-top: 10px;
}
.field-label:first-child { margin-top: 0; }

.field-input {
  width: 100%;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.72rem;
  padding: 7px 10px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg);
  color: var(--text);
  outline: none;
  transition: border-color 0.15s;
}
.field-input:focus { border-color: var(--accent); }
.field-input::placeholder { color: var(--text-dim); }

.keywords-input {
  font-family: 'Outfit', sans-serif;
  font-size: 0.78rem;
  min-height: 60px;
  resize: vertical;
}

.settings-toggle-btn {
  font-family: 'Outfit', sans-serif;
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--text-dim);
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
  display: flex;
  align-items: center;
  gap: 4px;
  transition: color 0.12s;
  width: 100%;
  padding: 8px 16px 4px;
}
.settings-toggle-btn:hover { color: var(--accent); }
.settings-toggle-btn .chevron { transition: transform 0.2s; display: inline-block; }
.settings-toggle-btn.open .chevron { transform: rotate(180deg); }

/* CHECKBOX */
.result-checkbox-wrap {
  flex-shrink: 0;
  width: 20px;
  display: flex;
  align-items: flex-start;
  padding-top: 3px;
}
.result-checkbox {
  width: 17px; height: 17px;
  accent-color: var(--accent);
  cursor: pointer;
  border-radius: 4px;
  flex-shrink: 0;
}
.result-item.selected {
  border-color: var(--accent);
  background: linear-gradient(135deg, #fff 0%, rgba(232,93,38,0.04) 100%);
  box-shadow: 0 0 0 2px rgba(232,93,38,0.15), var(--shadow);
}

/* BULK ACTION BAR */
.bulk-bar {
  position: sticky;
  bottom: 24px;
  left: 0; right: 0;
  margin: 16px 0 0;
  background: var(--text);
  color: #fff;
  border-radius: 12px;
  padding: 12px 20px;
  display: none;
  align-items: center;
  gap: 14px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.25);
  animation: barIn 0.2s ease;
  z-index: 50;
}
.bulk-bar.visible { display: flex; }
@keyframes barIn { from { opacity:0; transform: translateY(12px); } to { opacity:1; transform: none; } }
.bulk-bar-count {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem;
  color: rgba(255,255,255,0.6);
  white-space: nowrap;
}
.bulk-bar-count strong { color: var(--accent); font-size: 1rem; }
.bulk-btn {
  font-family: 'Outfit', sans-serif;
  font-size: 0.78rem;
  font-weight: 600;
  padding: 7px 16px;
  border-radius: 7px;
  cursor: pointer;
  transition: all 0.12s;
  border: 1px solid rgba(255,255,255,0.2);
  background: rgba(255,255,255,0.1);
  color: #fff;
  white-space: nowrap;
}
.bulk-btn:hover { background: rgba(255,255,255,0.18); }
.bulk-btn.accent { background: var(--accent); border-color: var(--accent); }
.bulk-btn.accent:hover { background: var(--accent2); }
.bulk-btn.danger { color: #ff8a7a; border-color: rgba(255,138,122,0.3); }
.bulk-btn.danger:hover { background: rgba(255,59,59,0.15); }
.bulk-bar-sep { width: 1px; height: 24px; background: rgba(255,255,255,0.12); }
.bulk-deselect {
  margin-left: auto;
  background: none; border: none;
  color: rgba(255,255,255,0.4);
  font-size: 1rem;
  cursor: pointer;
  padding: 2px 4px;
  line-height: 1;
  transition: color 0.12s;
}
.bulk-deselect:hover { color: #fff; }

/* select-all row */
.select-all-row {
  display: none;
  align-items: center;
  gap: 10px;
  padding: 6px 0 10px;
  font-size: 0.75rem;
  color: var(--text-dim);
}
.select-all-row.visible { display: flex; }
.select-all-cb { width: 15px; height: 15px; accent-color: var(--accent); cursor: pointer; }
.select-all-label { cursor: pointer; }

/* RESULTS */
.results-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 14px;
  margin-top: 8px;
}
.results-title {
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-dim);
}
.results-meta {
  font-size: 0.72rem;
  color: var(--text-dim);
  font-family: 'JetBrains Mono', monospace;
}

.result-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px 20px;
  margin-bottom: 10px;
  box-shadow: var(--shadow);
  transition: box-shadow 0.15s;
  display: flex;
  gap: 16px;
  align-items: flex-start;
  animation: slideIn 0.25s ease forwards;
}
@keyframes slideIn { from { opacity:0; transform: translateY(6px); } to { opacity:1; transform: none; } }
.result-item:hover { box-shadow: var(--shadow-lg); }

.result-source-icon {
  width: 38px; height: 38px;
  border-radius: 9px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem;
  flex-shrink: 0;
  margin-top: 2px;
}

.result-body { flex: 1; min-width: 0; }
.result-source-label {
  font-size: 0.65rem;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-bottom: 3px;
}
.result-title {
  font-weight: 700;
  font-size: 0.95rem;
  color: var(--text);
  margin-bottom: 5px;
  line-height: 1.35;
}
.result-title a { color: inherit; text-decoration: none; }
.result-title a:hover { color: var(--accent); }
.result-snippet {
  font-size: 0.82rem;
  color: var(--text-mid);
  line-height: 1.55;
  margin-bottom: 8px;
}
.result-snippet mark {
  background: rgba(232,93,38,0.15);
  color: var(--accent2);
  border-radius: 2px;
  padding: 0 2px;
  font-weight: 600;
}
.result-footer {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}
.result-date {
  font-size: 0.65rem;
  color: var(--text-dim);
  font-family: 'JetBrains Mono', monospace;
}
.result-keyword-tag {
  font-size: 0.62rem;
  padding: 2px 8px;
  background: var(--accent-light);
  color: var(--accent2);
  border-radius: 10px;
  font-weight: 600;
  border: 1px solid rgba(232,93,38,0.2);
}
.result-actions { margin-left: auto; display: flex; gap: 6px; }
.result-btn {
  font-family: 'Outfit', sans-serif;
  font-size: 0.68rem;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.12s;
  border: 1px solid var(--border2);
  background: var(--surface2);
  color: var(--text-mid);
}
.result-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
.result-btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
.result-btn.primary:hover { background: var(--accent2); border-color: var(--accent2); }

.relevance-bar {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-shrink: 0;
  margin-top: 4px;
}
.relevance-label { font-size: 0.62rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }
.relevance-track {
  width: 50px; height: 5px;
  background: var(--border);
  border-radius: 3px;
  overflow: hidden;
}
.relevance-fill {
  height: 100%;
  border-radius: 3px;
  background: linear-gradient(90deg, #f59e0b, var(--accent));
}

/* EMPTY STATE */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-dim);
}
.empty-state .icon { font-size: 3rem; margin-bottom: 14px; opacity: 0.4; }
.empty-state h3 { font-size: 1rem; font-weight: 700; color: var(--text-mid); margin-bottom: 6px; }
.empty-state p { font-size: 0.82rem; line-height: 1.6; }

/* PROGRESS */
.progress-bar {
  height: 3px;
  background: var(--border);
  border-radius: 2px;
  overflow: hidden;
  margin-bottom: 20px;
  display: none;
}
.progress-bar.active { display: block; }
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), #f59e0b);
  border-radius: 2px;
  animation: progressAnim 2s ease-in-out infinite;
}
@keyframes progressAnim {
  0% { width: 5%; margin-left: 0; }
  50% { width: 40%; margin-left: 30%; }
  100% { width: 5%; margin-left: 95%; }
}

/* MODAL / OVERLAY */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 500;
  display: none;
  align-items: center;
  justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--surface);
  border-radius: 14px;
  padding: 28px 32px;
  width: 480px;
  max-width: 95vw;
  box-shadow: var(--shadow-lg);
  animation: modalIn 0.2s ease;
}
@keyframes modalIn { from { opacity:0; transform: scale(0.96); } to { opacity:1; transform: none; } }
.modal-title { font-size: 1.1rem; font-weight: 800; margin-bottom: 4px; }
.modal-sub { font-size: 0.78rem; color: var(--text-dim); margin-bottom: 20px; }
.modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
.btn-cancel {
  font-family: 'Outfit', sans-serif;
  font-size: 0.85rem; font-weight: 600;
  padding: 9px 18px;
  border: 1px solid var(--border2);
  background: var(--surface2);
  color: var(--text-mid);
  border-radius: 7px; cursor: pointer;
  transition: all 0.12s;
}
.btn-cancel:hover { border-color: var(--text); color: var(--text); }
.btn-save {
  font-family: 'Outfit', sans-serif;
  font-size: 0.85rem; font-weight: 700;
  padding: 9px 22px;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 7px; cursor: pointer;
  transition: background 0.12s;
}
.btn-save:hover { background: var(--accent2); }

.form-row { margin-bottom: 14px; }
.form-label { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-dim); margin-bottom: 6px; display: block; }
.form-input {
  width: 100%;
  font-family: 'Outfit', sans-serif;
  font-size: 0.88rem;
  padding: 9px 12px;
  border: 1px solid var(--border);
  border-radius: 7px;
  background: var(--bg);
  color: var(--text);
  outline: none;
  transition: border-color 0.15s;
}
.form-input:focus { border-color: var(--accent); }
.form-select {
  width: 100%;
  font-family: 'Outfit', sans-serif;
  font-size: 0.88rem;
  padding: 9px 12px;
  border: 1px solid var(--border);
  border-radius: 7px;
  background: var(--bg);
  color: var(--text);
  outline: none;
  cursor: pointer;
}

/* SUBFORUM LIST */
.subforum-list { display: flex; flex-direction: column; gap: 6px; margin-bottom: 4px; }
.subforum-row {
  display: flex;
  gap: 6px;
  align-items: center;
  animation: slideIn 0.18s ease;
}
.subforum-row .field-input {
  flex: 1;
  margin: 0;
  font-size: 0.7rem;
  padding: 6px 9px;
}
.subforum-remove {
  flex-shrink: 0;
  width: 26px; height: 26px;
  border-radius: 5px;
  border: 1px solid var(--border2);
  background: var(--surface2);
  color: var(--text-dim);
  font-size: 0.85rem;
  line-height: 1;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.12s;
}
.subforum-remove:hover { background: var(--red-bg); border-color: rgba(192,57,43,0.3); color: var(--red); }
.subforum-add-btn {
  font-family: 'Outfit', sans-serif;
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--accent);
  background: var(--accent-light);
  border: 1px dashed rgba(232,93,38,0.35);
  border-radius: 5px;
  padding: 5px 10px;
  cursor: pointer;
  transition: all 0.12s;
  width: 100%;
  text-align: left;
  margin-top: 2px;
}
.subforum-add-btn:hover { background: rgba(232,93,38,0.15); border-color: var(--accent); }
.subforum-count {
  font-size: 0.6rem;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text-dim);
  margin-left: 4px;
}


::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

/* DARK MODE OVERRIDES */
html[data-theme="dark"] .badge-forum { background: rgba(37,99,168,0.22); color: #6aafdf; }
html[data-theme="dark"] .badge-social { background: rgba(168,37,79,0.22); color: #d45f8f; }
html[data-theme="dark"] .badge-portal { background: rgba(26,122,74,0.22); color: #2da866; }
html[data-theme="dark"] .badge-ogloszenia { background: rgba(176,120,0,0.22); color: #d4a017; }
html[data-theme="dark"] .badge-it { background: rgba(106,37,168,0.22); color: #a44fd4; }
html[data-theme="dark"] .badge-biznes { background: rgba(26,122,122,0.22); color: #2da8a8; }
html[data-theme="dark"] .result-item.selected {
  background: linear-gradient(135deg, var(--surface) 0%, rgba(232,93,38,0.09) 100%);
}
html[data-theme="dark"] .card-subforum-chip:hover { background: rgba(37,99,168,0.3); color: #6aafdf; }
html[data-theme="dark"] .engine-badge { background: rgba(255,255,255,0.08); color: var(--text-dim); }

/* THEME TOGGLE & LANG SWITCHER */
.topbar-controls {
  display: flex; align-items: center; gap: 8px; margin-left: auto;
}
.theme-toggle {
  width: 36px; height: 36px;
  border-radius: 8px;
  border: 1px solid var(--border2);
  background: var(--surface2);
  cursor: pointer;
  font-size: 1.05rem;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.theme-toggle:hover { border-color: var(--accent); background: var(--accent-light); }
.lang-switcher {
  display: flex; align-items: center; gap: 5px;
  height: 36px; padding: 0 10px; box-sizing: border-box;
  border-radius: 8px;
  border: 1px solid var(--border2);
  background: var(--surface2);
  color: var(--text-dim);
  font-size: 0.75rem; font-weight: 600;
  cursor: not-allowed;
  opacity: 0.45;
  user-select: none;
  font-family: 'Outfit', sans-serif;
}
.lang-arrow { font-size: 0.6rem; }

/* SCHEDULE BUTTON & PANEL */
.schedule-btn-wrap { position: relative; }
.schedule-btn {
  width: 36px; height: 36px;
  border-radius: 8px;
  border: 1px solid var(--border2);
  background: var(--surface2);
  color: var(--text-dim);
  cursor: pointer; font-size: 1rem;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s; position: relative;
}
.schedule-btn:hover { border-color: var(--accent); background: var(--accent-light); color: var(--accent); }
.schedule-btn.active { border-color: #10b981; background: rgba(16,185,129,0.1); color: #10b981; }
.schedule-btn.active::after {
  content: '';
  position: absolute; top: 5px; right: 5px;
  width: 7px; height: 7px; border-radius: 50%;
  background: #10b981;
  box-shadow: 0 0 0 0 rgba(16,185,129,0.6);
  animation: schedulePulse 1.8s ease-in-out infinite;
}
@keyframes schedulePulse {
  0%   { box-shadow: 0 0 0 0 rgba(16,185,129,0.6); }
  70%  { box-shadow: 0 0 0 6px rgba(16,185,129,0); }
  100% { box-shadow: 0 0 0 0 rgba(16,185,129,0); }
}
.schedule-panel {
  display: none; position: absolute;
  top: calc(100% + 10px); right: 0;
  width: 300px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 14px; box-shadow: var(--shadow-lg);
  z-index: 300; animation: modalIn 0.18s ease; overflow: hidden;
}
.schedule-panel.open { display: block; }
.schedule-panel-header {
  padding: 14px 18px 12px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.schedule-panel-title {
  font-size: 0.88rem; font-weight: 800; color: var(--text);
  display: flex; align-items: center; gap: 7px;
}
.schedule-panel-close {
  background: none; border: none; cursor: pointer;
  font-size: 1rem; color: var(--text-dim); padding: 2px 5px;
  border-radius: 4px; transition: color 0.12s; line-height: 1;
}
.schedule-panel-close:hover { color: var(--text); }
.schedule-panel-body { padding: 16px 18px; }
.sched-row { margin-bottom: 13px; }
.sched-row:last-child { margin-bottom: 0; }
.sched-label {
  font-size: 0.62rem; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.08em; color: var(--text-dim);
  font-family: 'JetBrains Mono', monospace; margin-bottom: 6px; display: block;
}
.sched-toggle-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 14px; background: var(--surface2);
  border: 1px solid var(--border); border-radius: 8px; margin-bottom: 13px;
}
.sched-toggle-label { font-size: 0.85rem; font-weight: 600; color: var(--text); }
.sched-toggle { position: relative; width: 40px; height: 22px; flex-shrink: 0; }
.sched-toggle input { opacity: 0; width: 0; height: 0; }
.sched-slider {
  position: absolute; inset: 0; background: var(--border2);
  border-radius: 22px; cursor: pointer; transition: background 0.2s;
}
.sched-slider::before {
  content: ''; position: absolute;
  width: 16px; height: 16px; left: 3px; top: 3px;
  background: #fff; border-radius: 50%; transition: transform 0.2s;
}
.sched-toggle input:checked + .sched-slider { background: #10b981; }
.sched-toggle input:checked + .sched-slider::before { transform: translateX(18px); }
.sched-select, .sched-input {
  width: 100%; font-family: 'Outfit', sans-serif; font-size: 0.82rem;
  padding: 8px 10px; border: 1px solid var(--border); border-radius: 7px;
  background: var(--bg); color: var(--text); outline: none;
  transition: border-color 0.15s; cursor: pointer;
}
.sched-select:focus, .sched-input:focus { border-color: var(--accent); }
.sched-options { display: flex; flex-direction: column; gap: 8px; }
.sched-status {
  font-size: 0.72rem; color: var(--text-dim);
  font-family: 'JetBrains Mono', monospace;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 7px; padding: 9px 12px;
  display: flex; flex-direction: column; gap: 4px;
}
.sched-status-row { display: flex; justify-content: space-between; }
.sched-status-val { color: var(--text-mid); font-weight: 600; }
.sched-run-btn {
  width: 100%; margin-top: 10px;
  font-family: 'Outfit', sans-serif; font-size: 0.82rem; font-weight: 700;
  padding: 9px; background: var(--accent); color: #fff;
  border: none; border-radius: 7px; cursor: pointer; transition: background 0.15s;
}
.sched-run-btn:hover { background: var(--accent2); }

/* AUTO-SEARCH TOAST */
.autosearch-toast {
  position: fixed; bottom: 28px; right: 28px;
  background: var(--text); color: #fff;
  border-radius: 13px; padding: 16px 20px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.35);
  z-index: 9999; min-width: 280px; max-width: 360px;
  animation: toastIn 0.3s cubic-bezier(0.34,1.56,0.64,1);
  display: none;
}
.autosearch-toast.visible { display: block; }
@keyframes toastIn { from { opacity:0; transform: translateY(20px) scale(0.95); } to { opacity:1; transform: none; } }
.toast-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
.toast-icon { font-size: 1.4rem; }
.toast-title { font-size: 0.9rem; font-weight: 800; }
.toast-close {
  margin-left: auto; background: none; border: none; color: rgba(255,255,255,0.5);
  font-size: 1rem; cursor: pointer; padding: 0 4px; transition: color 0.12s; line-height: 1;
}
.toast-close:hover { color: #fff; }
.toast-body { font-size: 0.78rem; color: rgba(255,255,255,0.7); line-height: 1.55; }
.toast-body strong { color: #fff; }
.toast-actions { display: flex; gap: 8px; margin-top: 12px; }
.toast-btn {
  font-family: 'Outfit', sans-serif; font-size: 0.75rem; font-weight: 700;
  padding: 6px 14px; border-radius: 6px; cursor: pointer; transition: all 0.12s; border: none;
}
.toast-btn.primary { background: var(--accent); color: #fff; }
.toast-btn.primary:hover { background: var(--accent2); }
.toast-btn.ghost { background: rgba(255,255,255,0.12); color: #fff; }
.toast-btn.ghost:hover { background: rgba(255,255,255,0.2); }

/* INFO BUTTON */
.info-btn-wrap { position: relative; }
.info-btn {
  width: 36px; height: 36px;
  border-radius: 8px;
  border: 1px solid rgba(232,93,38,0.45);
  background: rgba(232,93,38,0.08);
  color: var(--accent);
  cursor: pointer;
  font-size: 1rem; font-weight: 700;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
  position: relative;
}
.info-btn:hover { background: var(--accent); color: #fff; border-color: var(--accent); }
.info-btn::after {
  content: '';
  position: absolute; inset: -4px;
  border-radius: 12px;
  border: 2px solid var(--accent);
  opacity: 0;
  animation: infoPulse 2.2s ease-in-out infinite;
}
@keyframes infoPulse {
  0%   { opacity: 0; transform: scale(0.92); }
  40%  { opacity: 0.45; transform: scale(1.08); }
  100% { opacity: 0; transform: scale(1.22); }
}
.info-panel {
  display: none;
  position: absolute;
  top: calc(100% + 10px);
  right: 0;
  width: 320px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  box-shadow: var(--shadow-lg);
  z-index: 300;
  animation: modalIn 0.18s ease;
  overflow: hidden;
}
.info-panel.open { display: block; }
.info-panel-header {
  padding: 16px 20px 12px;
  background: linear-gradient(135deg, rgba(232,93,38,0.1) 0%, transparent 100%);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.info-panel-title {
  font-size: 0.88rem; font-weight: 800; color: var(--text);
  display: flex; align-items: center; gap: 7px;
}
.info-panel-close {
  background: none; border: none; cursor: pointer;
  font-size: 1rem; color: var(--text-dim); padding: 2px 5px;
  border-radius: 4px; transition: color 0.12s;
  line-height: 1;
}
.info-panel-close:hover { color: var(--text); }
.info-panel-body { padding: 16px 20px; }
.info-row {
  display: flex; gap: 10px; align-items: baseline;
  margin-bottom: 8px; font-size: 0.82rem;
}
.info-row:last-child { margin-bottom: 0; }
.info-label {
  font-size: 0.62rem; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.08em; color: var(--text-dim);
  white-space: nowrap; min-width: 52px;
  font-family: 'JetBrains Mono', monospace;
}
.info-val { color: var(--text-mid); line-height: 1.5; }
.info-val a { color: var(--accent); text-decoration: none; }
.info-val a:hover { text-decoration: underline; }
.info-divider { height: 1px; background: var(--border); margin: 12px 0; }
.info-donation {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px 14px;
  font-size: 0.78rem;
}
.info-donation-title {
  font-size: 0.68rem; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.08em; color: var(--accent); margin-bottom: 8px;
  font-family: 'JetBrains Mono', monospace;
}
.info-donation-row { color: var(--text-mid); margin-bottom: 4px; font-size: 0.78rem; }
.info-donation-iban {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.72rem; color: var(--text); font-weight: 600;
  background: var(--bg); border: 1px solid var(--border);
  border-radius: 5px; padding: 5px 9px; margin-top: 6px;
  letter-spacing: 0.04em; cursor: pointer; transition: border-color 0.15s;
  display: flex; align-items: center; justify-content: space-between; gap: 8px;
}
.info-donation-iban:hover { border-color: var(--accent); }
.info-donation-iban .copy-hint { font-size: 0.58rem; color: var(--text-dim); font-weight: 400; white-space: nowrap; }
.info-donation-alts { margin-top: 10px; }
.info-donation-alt-label {
  font-size: 0.62rem; color: var(--text-dim); text-align: center;
  margin-bottom: 7px; text-transform: uppercase; letter-spacing: 0.08em;
  font-family: 'JetBrains Mono', monospace;
}
.info-donation-alt-btns { display: flex; gap: 8px; }
.info-donation-blik {
  flex: 1; display: flex; align-items: center; gap: 6px;
  background: var(--bg); border: 1px solid var(--border);
  border-radius: 6px; padding: 6px 9px; cursor: pointer;
  transition: border-color 0.15s; font-size: 0.72rem;
}
.info-donation-blik:hover { border-color: #e5007e; }
.blik-logo {
  font-family: 'JetBrains Mono', monospace; font-weight: 800;
  font-size: 0.65rem; color: #e5007e; letter-spacing: -0.02em;
  background: rgba(229,0,126,0.1); border-radius: 3px;
  padding: 1px 5px; flex-shrink: 0;
}
.blik-number { font-family: 'JetBrains Mono', monospace; color: var(--text); font-weight: 600; flex: 1; }
.info-donation-blik .copy-hint { font-size: 0.58rem; color: var(--text-dim); white-space: nowrap; }
.info-donation-patronite {
  flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px;
  background: var(--bg); border: 1px solid var(--border);
  border-radius: 6px; padding: 6px 9px; cursor: pointer;
  text-decoration: none; color: var(--text-mid);
  font-size: 0.78rem; font-weight: 600;
  transition: all 0.15s; font-family: 'Outfit', sans-serif;
}
.info-donation-patronite:hover { border-color: #e5007e; color: #e5007e; background: rgba(229,0,126,0.06); }
.info-note {
  font-size: 0.74rem; color: var(--text-dim);
  text-align: center; margin-top: 12px; line-height: 1.5;
}

/* STATS STRIP */
.stats-strip {
  display: flex;
  gap: 0;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 28px;
  box-shadow: var(--shadow);
}
.stat-item {
  flex: 1;
  padding: 14px 18px;
  border-right: 1px solid var(--border);
  text-align: center;
}
.stat-item:last-child { border-right: none; }
.stat-val {
  font-family: 'JetBrains Mono', monospace;
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--text);
}
.stat-val.orange { color: var(--accent); }
.stat-lbl { font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 2px; }

/* SAVED */
.saved-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 0.62rem;
  padding: 2px 7px;
  background: var(--green-bg);
  color: var(--green);
  border-radius: 10px;
  font-weight: 600;
  border: 1px solid rgba(26,122,74,0.2);
}

/* SOURCES MANAGE VIEW TOGGLE */
.manage-topbar {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 18px; gap: 12px; flex-wrap: wrap;
}
.manage-topbar-left { display: flex; align-items: center; gap: 10px; }
.manage-topbar-right { 
  display: flex; align-items: center; gap: 10px; 
  flex-wrap: wrap;
}
.manage-count {
  font-size: 0.72rem; font-family: 'JetBrains Mono', monospace;
  color: var(--text-dim); background: var(--surface2);
  border: 1px solid var(--border); border-radius: 5px; padding: 3px 10px;
}

@media (max-width: 768px) {
  .manage-topbar {
    flex-direction: column;
    align-items: stretch;
  }
  .manage-topbar-left,
  .manage-topbar-right {
    justify-content: center;
    flex-wrap: wrap;
  }
  .manage-view-toggle {
    order: -1;
  }
}
.manage-view-toggle {
  display: flex; border: 1px solid var(--border2); border-radius: 6px; overflow: hidden;
}
.manage-view-btn {
  font-family: 'Outfit', sans-serif; font-size: 0.7rem; font-weight: 600;
  padding: 6px 13px; background: transparent; border: none;
  color: var(--text-dim); cursor: pointer; transition: all 0.12s;
  display: flex; align-items: center; gap: 5px;
  text-transform: uppercase; letter-spacing: 0.05em;
}
.manage-view-btn + .manage-view-btn { border-left: 1px solid var(--border2); }
.manage-view-btn:hover { color: var(--text); background: var(--surface2); }
.manage-view-btn.active { color: var(--accent); background: var(--accent-light); }

/* SOURCES LIST TABLE */
.sources-list-table {
  width: 100%; border-collapse: collapse;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; overflow: hidden; box-shadow: var(--shadow);
  font-size: 0.82rem;
}
.sources-table-wrapper {
  overflow-x: auto;
  max-width: 100%;
  -webkit-overflow-scrolling: touch;
}
.sources-list-table thead tr { background: var(--surface2); border-bottom: 1px solid var(--border); }
.sources-list-table th {
  text-align: left; padding: 8px 12px;
  font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.1em;
  color: var(--text-dim); font-weight: 600; white-space: nowrap;
  position: sticky; top: 0; background: var(--surface2); z-index: 10;
}
.sources-list-table tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; }
.sources-list-table tbody tr:last-child { border-bottom: none; }
.sources-list-table tbody tr:hover { background: var(--bg); }
.sources-list-table td { padding: 8px 12px; vertical-align: middle; font-size: 0.78rem; }

/* Responsive behavior */
@media (max-width: 1400px) {
  .sources-list-table th:nth-child(4),
  .sources-list-table td:nth-child(4) {
    display: none; /* Ukryj kolumnę słów kluczowych */
  }
}

@media (max-width: 1200px) {
  .sources-list-table th:nth-child(5),
  .sources-list-table td:nth-child(5) {
    display: none; /* Ukryj kolumnę silnika */
  }
  .sources-list-table th,
  .sources-list-table td {
    padding: 6px 8px;
    font-size: 0.75rem;
  }
}

@media (max-width: 1000px) {
  .sources-list-table th:nth-child(3),
  .sources-list-table td:nth-child(3) {
    display: none; /* Ukryj kolumnę podfora */
  }
}

@media (max-width: 800px) {
  .sources-list-table th,
  .sources-list-table td {
    padding: 4px 6px;
    font-size: 0.7rem;
  }
  .slt-name {
    font-size: 0.75rem;
  }
  .source-type-badge {
    font-size: 0.55rem;
    padding: 1px 4px;
  }
}

@media (max-width: 600px) {
  .sources-table-wrapper {
    margin: 0 -16px;
  }
  .sources-list-table {
    border-radius: 0;
  }
}
.slt-icon { width: 32px; height: 32px; border-radius: 7px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
.slt-name { font-weight: 700; color: var(--text); }
.slt-url-chip {
  font-size: 0.62rem; font-family: 'JetBrains Mono', monospace;
  color: var(--blue); background: var(--blue-bg); border-radius: 3px;
  padding: 2px 7px; display: inline-block;
  max-width: 240px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.slt-url-empty { font-size: 0.65rem; color: var(--text-dim); font-style: italic; }
.slt-url-more { font-size: 0.6rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; margin-left: 4px; }
.slt-keywords { font-size: 0.7rem; color: var(--text-mid); max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.slt-edit-btn {
  font-family: 'Outfit', sans-serif; font-size: 0.68rem; font-weight: 600;
  padding: 4px 11px; border: 1px solid var(--border2); border-radius: 5px;
  background: var(--surface2); color: var(--text-mid); cursor: pointer; transition: all 0.12s;
}
.slt-edit-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
.source-base-url {
  font-size: 0.6rem;
  font-family: 'JetBrains Mono', monospace;
  color: var(--blue);
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 3px;
  margin-top: 3px;
  opacity: 0.8;
  transition: opacity 0.12s;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 160px;
}
.source-base-url:hover { opacity: 1; text-decoration: underline; }

.slt-settings-inner { padding: 12px 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; max-width: 640px; }

/* CARD SUBFORUM CHIPS */
.card-subforums {
  display: flex; flex-direction: column; gap: 4px;
  padding: 6px 14px 10px;
  border-top: 1px solid var(--border);
}
.card-subforum-chip {
  font-size: 0.62rem; font-family: 'JetBrains Mono', monospace;
  color: var(--blue); background: var(--blue-bg); border-radius: 4px;
  padding: 3px 8px; text-decoration: none; overflow: hidden;
  text-overflow: ellipsis; white-space: nowrap;
  transition: background 0.12s, color 0.12s; display: block;
}
.card-subforum-chip:hover { background: #d0e4fb; color: #1a4fa8; }

/* ENGINE SELECT */
.engine-select {
  width: 100%; font-family: 'JetBrains Mono', monospace; font-size: 0.72rem;
  padding: 6px 9px; border: 1px solid var(--border); border-radius: 6px;
  background: var(--bg); color: var(--text); outline: none; cursor: pointer;
  transition: border-color 0.15s;
}
.engine-select:focus { border-color: var(--accent); }
.engine-badge {
  font-size: 0.58rem; font-family: 'JetBrains Mono', monospace;
  padding: 1px 6px; border-radius: 3px; text-transform: uppercase;
  letter-spacing: 0.05em; margin-left: 4px; vertical-align: middle;
  background: rgba(0,0,0,0.06); color: var(--text-dim);
}

/* LOGIN BUTTON */
.login-btn {
  display: flex; align-items: center; gap: 7px;
  font-family: 'Outfit', sans-serif; font-size: 0.75rem; font-weight: 600;
  height: 36px; padding: 0 14px; box-sizing: border-box;
  border-radius: 7px; cursor: pointer;
  border: 1px solid var(--border2); background: var(--surface);
  color: var(--text-mid); transition: all 0.15s; white-space: nowrap;
}
.login-btn:hover { border-color: var(--accent); color: var(--accent); }
.login-lamp {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
  position: relative;
}
.login-lamp::after {
  content: ''; position: absolute; inset: -3px; border-radius: 50%;
  opacity: 0.35; animation: lpulse 2s ease-in-out infinite;
}
@keyframes lpulse { 0%,100%{transform:scale(1);opacity:0.35} 50%{transform:scale(1.7);opacity:0.1} }
.lamp-logged-out { background: var(--red); box-shadow: 0 0 6px var(--red); }
.lamp-logged-out::after { background: var(--red); }
.lamp-logged-in  { background: var(--green); box-shadow: 0 0 6px var(--green); }
.lamp-logged-in::after  { background: var(--green); }

/* LOGIN MODAL */
.login-modal { width: 400px; }
.login-user-row {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 14px; background: var(--green-bg);
  border: 1px solid rgba(26,122,74,0.2); border-radius: 8px; margin-bottom: 4px;
}
.login-avatar {
  width: 36px; height: 36px; border-radius: 50%;
  background: var(--green); color: #fff;
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 0.9rem; flex-shrink: 0;
}
.login-user-name { font-weight: 700; font-size: 0.88rem; color: var(--text); }
.login-user-email { font-size: 0.7rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }

/* SOURCE LOGIN BUTTON */
.src-login-btn {
  display: inline-flex; align-items: center; gap: 5px;
  font-family: 'Outfit', sans-serif; font-size: 0.65rem; font-weight: 600;
  padding: 3px 9px; border-radius: 5px; cursor: pointer;
  border: 1px solid var(--border2); background: var(--surface2);
  color: var(--text-dim); transition: all 0.12s; white-space: nowrap;
}
.src-login-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
.src-login-btn.logged-in { border-color: rgba(26,122,74,0.35); background: var(--green-bg); color: var(--green); }
.src-login-btn.logged-in:hover { border-color: var(--red); background: var(--red-bg); color: var(--red); }
.src-lamp { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.src-lamp.on  { background: var(--green); box-shadow: 0 0 4px var(--green); }
.src-lamp.off { background: var(--text-dim); }

/* CREDENTIALS PAGE */
.creds-table { width: 100%; border-collapse: collapse; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; box-shadow: var(--shadow); }
.creds-table thead tr { background: var(--surface2); border-bottom: 1px solid var(--border); }
.creds-table th { text-align: left; padding: 10px 14px; font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-dim); font-weight: 600; }
.creds-table tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; }
.creds-table tbody tr:last-child { border-bottom: none; }
.creds-table tbody tr:hover { background: var(--bg); }
.creds-table td { padding: 10px 14px; vertical-align: middle; font-size: 0.82rem; }
.creds-source-name { font-weight: 700; color: var(--text); }
.creds-login-val { font-family: 'JetBrains Mono', monospace; font-size: 0.72rem; color: var(--text-mid); }
.creds-pass-val { font-family: 'JetBrains Mono', monospace; font-size: 0.72rem; color: var(--text-dim); letter-spacing: 0.1em; }
.creds-empty { color: var(--text-dim); font-style: italic; font-size: 0.72rem; }
.creds-status { display: inline-flex; align-items: center; gap: 5px; font-size: 0.7rem; font-weight: 600; }
.creds-status.set { color: var(--green); }
.creds-status.unset { color: var(--text-dim); }
.creds-edit-btn { font-family: 'Outfit', sans-serif; font-size: 0.68rem; font-weight: 600; padding: 4px 10px; border: 1px solid var(--border2); border-radius: 5px; background: var(--surface2); color: var(--text-mid); cursor: pointer; transition: all 0.12s; }
.creds-edit-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
.creds-clear-btn { font-family: 'Outfit', sans-serif; font-size: 0.68rem; font-weight: 600; padding: 4px 10px; border: 1px solid transparent; border-radius: 5px; background: transparent; color: var(--text-dim); cursor: pointer; transition: all 0.12s; }
.creds-clear-btn:hover { border-color: rgba(192,57,43,0.3); color: var(--red); background: var(--red-bg); }
.creds-topbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px; }
.creds-notice { background: var(--yellow-bg); border: 1px solid rgba(176,120,0,0.25); border-radius: 8px; padding: 10px 14px; font-size: 0.75rem; color: var(--yellow); margin-bottom: 16px; display: flex; align-items: flex-start; gap: 8px; }
.creds-notice-icon { flex-shrink: 0; font-size: 0.9rem; margin-top: 1px; }
.creds-group-header td { background: var(--surface2); padding: 6px 14px; border-top: 2px solid var(--border2); border-bottom: 1px solid var(--border); }
.creds-group-header:first-child td { border-top: none; }
.creds-group-label { font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-dim); }
.creds-group-count { display: inline-flex; align-items: center; justify-content: center; margin-left: 7px; background: var(--border2); color: var(--text-dim); font-size: 0.6rem; font-weight: 700; min-width: 18px; height: 18px; padding: 0 5px; border-radius: 9px; }
.creds-group-header.status-set .creds-group-label { color: var(--green); }
.creds-group-header.status-unset .creds-group-label { color: var(--text-dim); }

/* SOURCE SEARCH MODAL */
.src-search-modal { width: 680px; max-height: 88vh; display: flex; flex-direction: column; }
.src-search-modal .modal-body { flex: 1; overflow-y: auto; padding-right: 4px; }
.query-builder { background: var(--surface2); border: 1px solid var(--border2); border-radius: 10px; padding: 14px 16px; font-size: 0.82rem; color: var(--text-mid); line-height: 2.2; display: flex; flex-wrap: wrap; align-items: center; gap: 6px; }
.query-keyword-input { font-family: 'Outfit', sans-serif; font-size: 0.82rem; font-weight: 600; padding: 4px 10px; border: 2px solid var(--accent); border-radius: 6px; background: var(--surface); color: var(--text); min-width: 180px; flex: 1; outline: none; }
.query-builder-actions { display: flex; gap: 8px; margin-top: 12px; }
.src-search-go-btn { font-family: 'Outfit', sans-serif; font-size: 0.78rem; font-weight: 700; padding: 8px 18px; background: var(--accent); border: none; color: #fff; border-radius: 7px; cursor: pointer; transition: opacity 0.12s; }
.src-search-go-btn:hover { opacity: 0.88; }
.src-search-copy-btn { font-family: 'Outfit', sans-serif; font-size: 0.78rem; font-weight: 600; padding: 8px 14px; background: var(--surface2); border: 1px solid var(--border2); color: var(--text-mid); border-radius: 7px; cursor: pointer; transition: all 0.12s; }
.src-search-copy-btn:hover { border-color: var(--accent); color: var(--accent); }
.src-search-divider { display: flex; align-items: center; gap: 10px; margin: 18px 0 10px; color: var(--text-dim); font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; }
.src-search-divider::before,.src-search-divider::after { content:''; flex:1; height:1px; background:var(--border); }
.src-paste-area { width:100%; min-height:90px; max-height:150px; resize:vertical; font-family:'JetBrains Mono',monospace; font-size:0.72rem; padding:10px 12px; border:1px solid var(--border2); border-radius:8px; background:var(--surface2); color:var(--text); box-sizing:border-box; line-height:1.6; }
.src-paste-area:focus { outline:none; border-color:var(--accent); }
.src-analyze-btn { font-family:'Outfit',sans-serif; font-size:0.75rem; font-weight:700; padding:7px 16px; background:var(--surface2); border:1px solid var(--border2); color:var(--text-mid); border-radius:7px; cursor:pointer; transition:all 0.12s; margin-top:8px; }
.src-analyze-btn:hover { border-color:var(--accent); color:var(--accent); }
.src-results-list { display:flex; flex-direction:column; gap:8px; margin-top:14px; }
.src-result-card { display:flex; align-items:flex-start; gap:12px; background:var(--surface2); border:1px solid var(--border); border-radius:9px; padding:11px 14px; transition:border-color 0.12s; }
.src-result-card:hover { border-color:var(--border2); }
.src-result-info { flex:1; min-width:0; }
.src-result-name { font-weight:700; font-size:0.85rem; color:var(--text); margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.src-result-url  { font-family:'JetBrains Mono',monospace; font-size:0.63rem; color:var(--accent); margin-bottom:5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.src-result-desc { font-size:0.74rem; color:var(--text-dim); line-height:1.5; }
.src-result-add  { flex-shrink:0; font-family:'Outfit',sans-serif; font-size:1rem; font-weight:700; width:30px; height:30px; border-radius:7px; border:2px solid var(--accent); background:var(--accent-light); color:var(--accent); cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.12s; margin-top:1px; }
.src-result-add:hover { background:var(--accent); color:#fff; }
.src-result-add.added { background:var(--green-bg); border-color:var(--green); color:var(--green); cursor:default; font-size:0.8rem; }
.search-source-btn { font-family:'Outfit',sans-serif; font-size:0.78rem; font-weight:600; padding:6px 12px; background:var(--surface); border:1px solid var(--border2); color:var(--text-dim); border-radius:6px; cursor:pointer; transition:all 0.12s; }
.search-source-btn:hover { border-color:var(--accent); color:var(--accent); background:var(--accent-light); }

/* KEYWORDS PAGE */
.kw-card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 16px; }
.kw-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); display: flex; flex-direction: column; }
.kw-card-header { display: flex; align-items: center; justify-content: space-between; padding: 13px 16px; border-bottom: 1px solid var(--border); gap: 10px; }
.kw-card-name { font-weight: 700; font-size: 0.9rem; color: var(--text); flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.kw-card-actions { display: flex; gap: 5px; flex-shrink: 0; }
.kw-card-body { padding: 12px 16px; display: flex; flex-direction: column; gap: 12px; }
.kw-section-label { font-size: 0.62rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-dim); margin-bottom: 7px; }
.kw-phrases { display: flex; flex-wrap: wrap; gap: 5px; }
.kw-phrase { display: inline-block; background: var(--accent-light); color: var(--accent); border: 1px solid rgba(232,93,38,0.2); border-radius: 20px; font-size: 0.7rem; font-weight: 600; padding: 3px 10px; }
.kw-phrase-more { background: var(--surface2); color: var(--text-dim); border-color: var(--border2); }
.kw-link-row { display: flex; align-items: center; gap: 8px; padding: 4px 0; }
.kw-link-name { font-size: 0.78rem; font-weight: 600; color: var(--text); flex: 1; }
.kw-link-sub { font-size: 0.62rem; font-family: 'JetBrains Mono', monospace; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 130px; }
.kw-no-links { font-size: 0.72rem; color: var(--text-dim); font-style: italic; }
/* KW MODAL */
.kw-modal { width: 560px; max-height: 85vh; display: flex; flex-direction: column; }
.kw-modal .modal-body { flex: 1; overflow-y: auto; padding: 0 4px; }
.kw-source-picker { max-height: 260px; overflow-y: auto; border: 1px solid var(--border2); border-radius: 8px; background: var(--surface2); }
.kw-source-row { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.1s; }
.kw-source-row:last-child { border-bottom: none; }
.kw-source-row:hover { background: var(--bg); }
.kw-source-row input[type=checkbox] { width: 15px; height: 15px; accent-color: var(--accent); cursor: pointer; flex-shrink: 0; }
.kw-src-name { font-size: 0.8rem; font-weight: 600; flex: 1; }
.kw-sub-select { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; padding: 3px 7px; border: 1px solid var(--border2); border-radius: 5px; background: var(--surface); color: var(--text-mid); max-width: 170px; }
.kw-phrases-textarea { width: 100%; min-height: 110px; resize: vertical; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; padding: 10px 12px; border: 1px solid var(--border2); border-radius: 8px; background: var(--surface2); color: var(--text); box-sizing: border-box; line-height: 1.6; }
.kw-phrases-textarea:focus { outline: none; border-color: var(--accent); }
.kw-hint { font-size: 0.65rem; color: var(--text-dim); margin-top: 4px; }
.add-kwset-btn { font-family: 'Outfit', sans-serif; font-size: 0.78rem; font-weight: 600; padding: 6px 14px; background: var(--surface); border: 1px solid var(--border2); color: var(--text-mid); border-radius: 6px; cursor: pointer; transition: all 0.12s; }
.add-kwset-btn:hover { border-color: var(--accent); color: var(--accent); }

/* SCRIPTS PAGE */
.scripts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 14px; margin-bottom: 24px; }
.script-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); transition: box-shadow 0.15s; }
.script-card:hover { box-shadow: var(--shadow-lg); }
.script-card-header { padding: 13px 14px 10px; display: flex; align-items: flex-start; gap: 10px; }
.script-card-icon { width: 34px; height: 34px; border-radius: 8px; background: var(--surface2); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 1.05rem; flex-shrink: 0; }
.script-card-info { flex: 1; min-width: 0; }
.script-card-name { font-weight: 700; font-size: 0.88rem; color: var(--text); margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.script-card-badges { display: flex; gap: 5px; flex-wrap: wrap; }
.script-lang-badge { font-size: 0.58rem; font-family: 'JetBrains Mono', monospace; padding: 1px 6px; border-radius: 3px; text-transform: uppercase; letter-spacing: 0.05em; background: var(--surface2); color: var(--text-dim); border: 1px solid var(--border2); }
.lang-js  { background: rgba(247,220,111,0.18); color: #9a7300; border-color: rgba(247,220,111,0.5); }
.lang-python { background: rgba(37,99,168,0.12); color: var(--blue); border-color: rgba(37,99,168,0.3); }
.lang-bash   { background: rgba(16,185,129,0.12); color: #10b981; border-color: rgba(16,185,129,0.3); }
.lang-curl   { background: rgba(232,93,38,0.12); color: var(--accent); border-color: rgba(232,93,38,0.25); }
.lang-php    { background: rgba(106,37,168,0.12); color: #6a25a8; border-color: rgba(106,37,168,0.3); }
html[data-theme="dark"] .lang-js { color: #f0c040; }
.script-card-actions { display: flex; gap: 5px; flex-shrink: 0; }
.script-action-btn { width: 28px; height: 28px; border-radius: 6px; border: 1px solid var(--border2); background: var(--surface2); color: var(--text-dim); cursor: pointer; font-size: 0.78rem; display: flex; align-items: center; justify-content: center; transition: all 0.12s; }
.script-action-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
.script-action-btn.danger:hover { border-color: var(--red); color: var(--red); background: var(--red-bg); }
.script-desc { padding: 0 14px 10px; font-size: 0.78rem; color: var(--text-mid); line-height: 1.5; }
.script-code-wrap { border-top: 1px solid var(--border); }
.script-code-toggle { width: 100%; display: flex; align-items: center; gap: 6px; padding: 7px 14px; background: none; border: none; cursor: pointer; font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.06em; transition: color 0.12s; }
.script-code-toggle:hover { color: var(--accent); }
.script-code-toggle .chevron { transition: transform 0.2s; display: inline-block; }
.script-code-toggle.open .chevron { transform: rotate(180deg); }
.script-code-block { display: none; background: var(--bg); border-top: 1px solid var(--border); padding: 12px 14px; overflow-x: auto; max-height: 260px; overflow-y: auto; }
.script-code-block.open { display: block; }
.script-code-block pre { font-family: 'JetBrains Mono', monospace; font-size: 0.72rem; color: var(--text-mid); line-height: 1.65; margin: 0; white-space: pre; }
/* SCRIPT MODAL */
.script-modal { width: 620px; max-height: 90vh; display: flex; flex-direction: column; }
.script-modal .modal-body { flex: 1; overflow-y: auto; padding-right: 4px; }
.script-textarea { width: 100%; min-height: 220px; resize: vertical; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; padding: 12px 14px; border: 1px solid var(--border2); border-radius: 8px; background: var(--bg); color: var(--text); box-sizing: border-box; line-height: 1.65; outline: none; tab-size: 2; }
.script-textarea:focus { border-color: var(--accent); }

/* ENGINES PAGE */
.engines-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px; }
.engine-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); }
.engine-card-header { display: flex; align-items: center; gap: 12px; padding: 14px 16px; border-bottom: 1px solid var(--border); }
.engine-card-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.engine-card-name { font-weight: 700; font-size: 0.88rem; flex: 1; }
.engine-card-count { font-size: 0.68rem; font-weight: 700; background: var(--border2); color: var(--text-dim); padding: 2px 8px; border-radius: 9px; }
.engine-cfg-btn { border: none; background: var(--surface2); border: 1px solid var(--border2); border-radius: 6px; padding: 3px 8px; font-size: 0.75rem; cursor: pointer; color: var(--text-dim); transition: all 0.15s; }
.engine-cfg-btn:hover { border-color: var(--accent); color: var(--accent); }
.engine-cfg-btn.configured { color: #10b981; border-color: rgba(16,185,129,0.4); background: rgba(16,185,129,0.08); }
.engine-source-list { padding: 6px 0; }
.engine-source-row { display: flex; align-items: center; gap: 10px; padding: 7px 16px; transition: background 0.1s; }
.engine-source-row:hover { background: var(--bg); }
.engine-source-icon { width: 26px; height: 26px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; flex-shrink: 0; }
.engine-source-name { flex: 1; font-size: 0.8rem; font-weight: 600; color: var(--text); }
.engine-source-url  { font-size: 0.62rem; font-family: 'JetBrains Mono', monospace; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; }
.engine-source-status { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.engine-source-status.on  { background: var(--green); box-shadow: 0 0 4px var(--green); }
.engine-source-status.off { background: var(--text-dim); }
.engine-source-del { width: 22px; height: 22px; border-radius: 5px; border: none; background: transparent; color: var(--text-dim); font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.15s; }
.engine-source-del:hover { background: rgba(239,68,68,0.12); color: #ef4444; }
.engine-empty { padding: 18px 16px; font-size: 0.75rem; color: var(--text-dim); font-style: italic; }

/* REDDIT API */
.reddit-api-bar {
  display: flex; align-items: center; gap: 10px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; padding: 12px 16px; margin-bottom: 20px;
  box-shadow: var(--shadow);
}
.reddit-api-dot {
  width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0;
  background: var(--text-dim);
}
.reddit-api-dot.active { background: #10b981; box-shadow: 0 0 5px #10b98199; }
.reddit-api-label { font-size: 0.82rem; font-weight: 700; color: var(--text); flex: 1; }
.reddit-api-sub { font-size: 0.7rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }
.reddit-api-btn {
  font-family: 'Outfit', sans-serif; font-size: 0.75rem; font-weight: 700;
  padding: 6px 14px; border-radius: 7px; cursor: pointer; border: none;
  transition: all 0.15s;
}
.reddit-api-btn.setup { background: #ff4500; color: #fff; }
.reddit-api-btn.setup:hover { background: #cc3700; }
.reddit-api-btn.edit { background: var(--surface2); border: 1px solid var(--border2); color: var(--text-mid); }
.reddit-api-btn.edit:hover { border-color: var(--accent); color: var(--accent); }
/* GOOGLE API */
.google-api-bar {
  display: flex; align-items: center; gap: 10px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; padding: 12px 16px; margin-bottom: 20px;
  box-shadow: var(--shadow);
}
.google-api-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; background: var(--text-dim); }
.google-api-dot.active { background: #4285F4; box-shadow: 0 0 5px #4285F499; }
.google-api-label { font-size: 0.82rem; font-weight: 700; color: var(--text); flex: 1; }
.google-api-sub { font-size: 0.7rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }
.google-api-btn {
  font-family: 'Outfit', sans-serif; font-size: 0.75rem; font-weight: 700;
  padding: 6px 14px; border-radius: 7px; cursor: pointer; border: none; transition: all 0.15s;
}
.google-api-btn.setup { background: #4285F4; color: #fff; }
.google-api-btn.setup:hover { background: #2a6dd9; }
.google-api-btn.edit { background: var(--surface2); border: 1px solid var(--border2); color: var(--text-mid); }
.google-api-btn.edit:hover { border-color: var(--accent); color: var(--accent); }
/* modal */
.reddit-modal { width: 500px; }
.reddit-step {
  display: flex; gap: 12px; align-items: flex-start;
  padding: 10px 14px; border-radius: 8px; background: var(--surface2);
  border: 1px solid var(--border); margin-bottom: 8px;
}
.reddit-step-num {
  width: 22px; height: 22px; border-radius: 50%; background: var(--accent);
  color: #fff; font-size: 0.7rem; font-weight: 800;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px;
}
.reddit-step-text { font-size: 0.78rem; color: var(--text-mid); line-height: 1.5; }
.reddit-step-text a { color: var(--accent); text-decoration: none; }
.reddit-step-text a:hover { text-decoration: underline; }
.reddit-step-text code { font-family: 'JetBrains Mono', monospace; font-size: 0.72rem; background: var(--bg); padding: 1px 5px; border-radius: 3px; color: var(--text); }
.reddit-test-row { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
.reddit-test-status { font-size: 0.75rem; font-family: 'JetBrains Mono', monospace; color: var(--text-dim); }
/* real result badge */
.real-badge {
  font-size: 0.58rem; font-family: 'JetBrains Mono', monospace;
  padding: 1px 5px; border-radius: 3px; font-weight: 700;
  background: rgba(16,185,129,0.15); color: #10b981;
  border: 1px solid rgba(16,185,129,0.3); margin-left: 5px;
  vertical-align: middle; text-transform: uppercase;
}
.clone-btn { font-family: 'Outfit', sans-serif; font-size: 0.65rem; font-weight: 600; padding: 3px 8px; border: 1px solid var(--border2); border-radius: 5px; background: transparent; color: var(--text-dim); cursor: pointer; transition: all 0.12s; white-space: nowrap; }
.clone-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
.delete-src-btn { font-family: 'Outfit', sans-serif; font-size: 0.65rem; font-weight: 600; padding: 3px 8px; border: 1px solid var(--border2); border-radius: 5px; background: transparent; color: var(--text-dim); cursor: pointer; transition: all 0.12s; white-space: nowrap; }
.delete-src-btn:hover { border-color: #ef4444; color: #ef4444; background: rgba(239,68,68,0.07); }

/* SOURCE CRED MODAL */
.src-cred-modal { width: 420px; }
.src-cred-source-info { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--surface2); border-radius: 8px; margin-bottom: 16px; }
.src-cred-icon { width: 34px; height: 34px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; }
.src-cred-name { font-weight: 700; font-size: 0.9rem; }
.src-cred-url  { font-size: 0.65rem; font-family: 'JetBrains Mono', monospace; color: var(--text-dim); }
.pass-toggle-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-dim); font-size: 0.75rem; padding: 2px 4px; }
.pass-input-wrap { position: relative; }
.pass-input-wrap .form-input { padding-right: 40px; }
</style>

</head>
<body>

<div class="app">

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="brand">LEAD<span>●</span>HUNTER</div>
    <div style="display:flex;align-items:center;gap:8px;margin-top:3px">
      <div class="tagline">client discovery engine</div>
      <div style="font-size:0.6rem;font-family:'JetBrains Mono',monospace;color:var(--accent);background:rgba(232,93,38,0.18);border:1px solid rgba(232,93,38,0.35);border-radius:4px;padding:1px 6px;font-weight:700;letter-spacing:0.04em">v1.0.0-alfa</div>
    </div>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section-label">Nawigacja</div>
    <button class="nav-item active" onclick="showPage('search')">
      <span class="nav-icon">🔍</span> Szukaj klientów
    </button>
    <button class="nav-item" onclick="showPage('saved')">
      <span class="nav-icon">🔖</span> Zapisane leady
      <span class="nav-badge" id="saved-count">0</span>
    </button>
    <button class="nav-item" onclick="showPage('sources')">
      <span class="nav-icon">⚙️</span> Zarządzaj źródłami
    </button>
    <button class="nav-item" onclick="showPage('keywords')">
      <span class="nav-icon">🏷️</span> Frazy i słowa kluczowe
    </button>
    <button class="nav-item" onclick="showPage('engines')">
      <span class="nav-icon">🔎</span> Silniki wyszukiwań
    </button>
    <button class="nav-item" onclick="showPage('scripts')">
      <span class="nav-icon">📜</span> Skrypty
    </button>
    <button class="nav-item" onclick="showPage('credentials')">
      <span class="nav-icon">🔐</span> Loginy do źródeł
      <span class="nav-badge" id="creds-count" style="display:none">0</span>
    </button>

    <div class="nav-section-label" style="margin-top:8px">Szybkie zapytania</div>
    <div id="quick-queries-list"></div>
  </nav>
</aside>

<!-- MAIN -->
<main class="main">
  <div class="topbar">
    <div>
      <div class="page-title" id="page-title">Szukaj klientów</div>
      <div class="page-subtitle" id="page-subtitle">Przeszukuj fora i serwisy społecznościowe</div>
    </div>
    <div class="topbar-controls">
      <div class="schedule-btn-wrap">
        <button class="schedule-btn" id="schedule-btn" onclick="toggleSchedulePanel(event)" title="Automatyczne wyszukiwanie">⏱</button>
        <div class="schedule-panel" id="schedule-panel">
          <div class="schedule-panel-header">
            <div class="schedule-panel-title">⏱ Automatyczne wyszukiwanie</div>
            <button class="schedule-panel-close" onclick="closeSchedulePanel()">✕</button>
          </div>
          <div class="schedule-panel-body">
            <div class="sched-toggle-row">
              <span class="sched-toggle-label">Włącz harmonogram</span>
              <label class="sched-toggle">
                <input type="checkbox" id="sched-enabled" onchange="onSchedToggle(this.checked)">
                <span class="sched-slider"></span>
              </label>
            </div>
            <div class="sched-options" id="sched-options">
              <div class="sched-row">
                <span class="sched-label">Częstotliwość</span>
                <select class="sched-select" id="sched-frequency" onchange="onSchedChange()">
                  <option value="hourly">Co godzinę</option>
                  <option value="every2h">Co 2 godziny</option>
                  <option value="every4h">Co 4 godziny</option>
                  <option value="every8h">Co 8 godzin</option>
                  <option value="daily" selected>Codziennie o godzinie</option>
                </select>
              </div>
              <div class="sched-row" id="sched-time-row">
                <span class="sched-label">Godzina</span>
                <input type="time" class="sched-input" id="sched-time" value="09:00" onchange="onSchedChange()">
              </div>
              <div class="sched-row">
                <span class="sched-label">Fraza wyszukiwania <span style="font-weight:400;text-transform:none">(zostaw puste = z pola głównego)</span></span>
                <input type="text" class="sched-input" id="sched-query" placeholder="np. szukam szkoleń..." oninput="onSchedChange()">
              </div>
              <div class="sched-status" id="sched-status">
                <div class="sched-status-row"><span>Ostatnie uruchomienie</span><span class="sched-status-val" id="sched-last-run">—</span></div>
                <div class="sched-status-row"><span>Następne</span><span class="sched-status-val" id="sched-next-run">—</span></div>
                <div class="sched-status-row"><span>Źródła (ulubione)</span><span class="sched-status-val" id="sched-fav-count">0</span></div>
              </div>
              <button class="sched-run-btn" onclick="runAutoSearch(true)">▶ Uruchom teraz</button>
            </div>
          </div>
        </div>
      </div>
      <div class="info-btn-wrap">
        <button class="info-btn" onclick="toggleInfoPanel(event)" id="info-btn" title="Informacje o autorze">ℹ</button>
        <div class="info-panel" id="info-panel">
          <div class="info-panel-header">
            <div class="info-panel-title">👤 Autor &amp; Kontakt <span style="font-size:0.6rem;font-family:'JetBrains Mono',monospace;color:var(--accent);background:var(--accent-light);border:1px solid rgba(232,93,38,0.25);border-radius:4px;padding:1px 6px;font-weight:700;margin-left:4px">v1.0.0-alfa</span></div>
            <button class="info-panel-close" onclick="closeInfoPanel()">✕</button>
          </div>
          <div class="info-panel-body">
            <div class="info-row">
              <span class="info-label">Autor</span>
              <span class="info-val">Michał Stankiewicz</span>
            </div>
            <div class="info-row">
              <span class="info-label">Tel</span>
              <span class="info-val"><a href="tel:+48797486355">+48 797 486 355</a></span>
            </div>
            <div class="info-row">
              <span class="info-label">Mail</span>
              <span class="info-val"><a href="mailto:michalstankiewicz@onet.eu">michalstankiewicz@onet.eu</a></span>
            </div>
            <div class="info-row">
              <span class="info-label">Info</span>
              <span class="info-val">Aplikację można dostosować na życzenie. Program jest darmowy — free to use.</span>
            </div>
            <div class="info-divider"></div>
            <div class="info-donation">
              <div class="info-donation-title">☕ Wesprzyj jeśli chcesz</div>
              <div class="info-donation-row">Nie czuj się zobowiązany ❤️ 🙂</div>
              <div class="info-donation-row" style="margin-top:8px">Michał Stankiewicz<br>02-585 Warszawa · PKO BP</div>
              <div class="info-donation-row" style="margin-top:6px; font-size:0.72rem; color:var(--text-dim)">Tytuł przelewu: <strong style="color:var(--text)">"Wyszukiwarka klientów"</strong></div>
              <div class="info-donation-iban" onclick="copyIban(this)" title="Kliknij aby skopiować">
                <span>PL55 1020 1097 0000 7902 0226 5353</span>
                <span class="copy-hint">📋 kopiuj</span>
              </div>
              <div class="info-donation-alts">
                <div class="info-donation-alt-label">lub</div>
                <div class="info-donation-alt-btns">
                  <div class="info-donation-blik" onclick="copyBlik(this)" title="Kliknij aby skopiować numer BLIK">
                    <span class="blik-logo">BLIK</span>
                    <span class="blik-number">797 486 355</span>
                    <span class="copy-hint">📋 kopiuj</span>
                  </div>
                  <a class="info-donation-patronite" href="https://patronite.pl/michalstankiewicz" target="_blank" rel="noopener">
                    <span>❤️</span>
                    <span>Patronite</span>
                    <span style="font-size:0.6rem;opacity:0.7">↗</span>
                  </a>
                </div>
              </div>
            </div>
            <div class="info-note">Jeżeli wspierasz moją pracę — dziękuję! 🙏</div>
          </div>
        </div>
      </div>
      <div class="lang-switcher" title="Zmiana języka – wkrótce dostępna">
        <span>🌐</span>
        <span>PL</span>
        <span class="lang-arrow">▾</span>
      </div>
      <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle-btn" title="Przełącz motyw (jasny / ciemny)">
        <span id="theme-icon">🌙</span>
      </button>
    </div>
    <button class="login-btn" id="login-btn" onclick="openLoginModal()">
      <div class="login-lamp lamp-logged-out" id="login-lamp"></div>
      <span id="login-btn-label">Zaloguj się</span>
    </button>
  </div>

  <div class="content">

    <!-- PAGE: SEARCH -->
    <div id="page-search">
      <!-- Search box -->
      <div class="search-box">
        <div class="search-box-label">Czego szukają Twoi klienci?</div>
        <div class="search-row">
          <input type="text" class="search-input" id="main-query"
            placeholder="np. szukam szkoleń z Excela, potrzebuję dostawcy papieru..."
            onkeydown="if(event.key==='Enter') doSearch()" />
          <button class="search-btn" onclick="doSearch()" id="search-btn">
            <span id="search-btn-icon">🔍</span> Szukaj
          </button>
        </div>
        <div class="search-tags">
          <span class="search-tag-label">Przykłady:</span>
          <span class="preset-tag" onclick="setQuery('szukam szkoleń z Excela')">Szkolenia Excel</span>
          <span class="preset-tag" onclick="setQuery('potrzebuję artykułów biurowych hurt')">Art. biurowe</span>
          <span class="preset-tag" onclick="setQuery('polecacie programistę PHP freelancer')">PHP dev</span>
          <span class="preset-tag" onclick="setQuery('szukam agencji SEO dla firmy')">Agencja SEO</span>
          <span class="preset-tag" onclick="setQuery('potrzebuję tłumacza angielski')">Tłumacz</span>
          <span class="preset-tag" onclick="setQuery('szukam dostawcy kawy do biura')">Kawa do biura</span>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-strip" id="stats-strip" style="display:none">
        <div class="stat-item">
          <div class="stat-val orange" id="stat-results">0</div>
          <div class="stat-lbl">Wyników</div>
        </div>
        <div class="stat-item">
          <div class="stat-val" id="stat-sources">0</div>
          <div class="stat-lbl">Źródeł</div>
        </div>
        <div class="stat-item">
          <div class="stat-val" id="stat-hot">0</div>
          <div class="stat-lbl">Hot leads</div>
        </div>
        <div class="stat-item">
          <div class="stat-val" id="stat-saved">0</div>
          <div class="stat-lbl">Zapisanych</div>
        </div>
      </div>

      <!-- Progress -->
      <div class="progress-bar" id="progress-bar"><div class="progress-fill"></div></div>

      <!-- Sources quick toggle -->
      <div id="sources-container"></div>

      <!-- Results -->
      <div id="results-section" style="display:none">
        <div class="results-header">
          <div class="results-title" id="results-title">Wyniki</div>
          <div class="results-meta" id="results-meta"></div>
        </div>
        <div class="select-all-row" id="select-all-row">
          <input type="checkbox" class="select-all-cb" id="select-all-cb" onchange="toggleSelectAll(this.checked)">
          <label class="select-all-label" for="select-all-cb">Zaznacz wszystkie</label>
        </div>
        <div id="results-list"></div>
        <div class="bulk-bar" id="bulk-bar">
          <div class="bulk-bar-count">Zaznaczono: <strong id="bulk-count">0</strong></div>
          <div class="bulk-bar-sep"></div>
          <button class="bulk-btn accent" onclick="bulkSave()">🔖 Zapisz zaznaczone</button>
          <button class="bulk-btn" onclick="bulkCopy()">📋 Kopiuj linki</button>
          <button class="bulk-btn danger" onclick="bulkDeselect()">✕ Odznacz</button>
          <button class="bulk-deselect" onclick="bulkDeselect()" title="Zamknij">✕</button>
        </div>
      </div>

      <div id="empty-state" class="empty-state">
        <div class="icon">🎯</div>
        <h3>Gotowy do polowania na leady?</h3>
        <p>Wpisz zapytanie, włącz interesujące źródła i kliknij Szukaj.<br>
        Narzędzie przeszuka fora i serwisy społecznościowe w poszukiwaniu<br>potencjalnych klientów.</p>
      </div>
    </div>

    <!-- PAGE: SAVED -->
    <div id="page-saved" style="display:none">
      <div id="saved-list"></div>
      <div id="saved-empty" class="empty-state" style="display:none">
        <div class="icon">🔖</div>
        <h3>Brak zapisanych leadów</h3>
        <p>Wyszukaj klientów i zapisuj obiecujące wyniki klikając<br>przycisk "Zapisz lead".</p>
      </div>
    </div>

    <!-- PAGE: SOURCES MANAGEMENT -->
    <div id="page-sources" style="display:none">
      <div class="manage-topbar">
        <div class="manage-topbar-left">
          <div class="sources-title">Wszystkie źródła</div>
          <div class="manage-count" id="manage-count">15 źródeł</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <div class="manage-view-toggle">
            <button class="manage-view-btn active" id="mgbtn-grid" onclick="setManageView('grid',this)">
              <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><rect x="0" y="0" width="5.5" height="5.5" rx="1" fill="currentColor"/><rect x="7.5" y="0" width="5.5" height="5.5" rx="1" fill="currentColor"/><rect x="0" y="7.5" width="5.5" height="5.5" rx="1" fill="currentColor"/><rect x="7.5" y="7.5" width="5.5" height="5.5" rx="1" fill="currentColor"/></svg>
              Kafelki
            </button>
            <button class="manage-view-btn" id="mgbtn-list" onclick="setManageView('list',this)">
              <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><rect x="0" y="1" width="13" height="2" rx="1" fill="currentColor"/><rect x="0" y="5.5" width="13" height="2" rx="1" fill="currentColor"/><rect x="0" y="10" width="13" height="2" rx="1" fill="currentColor"/></svg>
              Lista
            </button>
          </div>
          <button class="io-btn" onclick="exportSources()">
            <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><path d="M6.5 1v8M3 6.5l3.5 3.5 3.5-3.5M1 11h11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Eksport
          </button>
          <button class="io-btn" onclick="importSources()">
            <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><path d="M6.5 12V4M3 6.5L6.5 3 10 6.5M1 1h11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Import
          </button>
          <button class="search-source-btn" onclick="openSrcSearchModal()">🔍 Szukaj źródeł</button>
          <button class="add-source-btn" onclick="openAddModal()">+ Dodaj źródło</button>
        </div>
      </div>
      <div id="sources-manage-content"></div>
    </div>

    <!-- PAGE: KEYWORDS -->
    <div id="page-keywords" style="display:none">
      <div class="creds-topbar">
        <div><div class="sources-title">Frazy i słowa kluczowe</div></div>
        <button class="add-kwset-btn" onclick="openKwModal()">+ Dodaj zestaw</button>
      </div>
      <div id="keywords-content"></div>
    </div>

    <!-- PAGE: SCRIPTS -->
    <div id="page-scripts" style="display:none">
      <div class="creds-topbar">
        <div>
          <div class="sources-title">Skrypty</div>
          <div style="font-size:0.72rem;color:var(--text-dim);margin-top:2px">Skrypty dla niestandardowych wyszukiwań — powiązane z silnikami</div>
        </div>
        <button class="add-kwset-btn" onclick="openScriptModal()">+ Dodaj skrypt</button>
      </div>
      <div id="scripts-content"></div>
    </div>

    <!-- PAGE: ENGINES -->
    <div id="page-engines" style="display:none">
      <div class="creds-topbar">
        <div><div class="sources-title">Silniki wyszukiwań</div></div>
      </div>
      <div id="engines-content"></div>
    </div>

    <!-- PAGE: CREDENTIALS -->
    <div id="page-credentials" style="display:none">
      <div class="creds-topbar">
        <div>
          <div class="sources-title">Loginy do źródeł</div>
        </div>
        <div class="manage-view-toggle">
          <button class="manage-view-btn" id="cg-btn-status" onclick="setCredsGroup('status',this)">Wg statusu</button>
          <button class="manage-view-btn" id="cg-btn-name" onclick="setCredsGroup('name',this)">Wg nazwy</button>
        </div>
      </div>
      <div class="creds-notice" id="creds-notice">
        <span class="creds-notice-icon">🔒</span>
        <span>Hasła są przechowywane lokalnie w przeglądarce i powiązane z Twoim kontem użytkownika. Zaloguj się do systemu, aby zarządzać swoimi loginami.</span>
      </div>
      <div id="creds-content"></div>
    </div>

  </div>
</main>
</div>

<!-- KEYWORDS MODAL -->
<div class="modal-overlay" id="kw-modal-overlay">
  <div class="modal kw-modal">
    <div class="modal-title" id="kw-modal-title">Dodaj zestaw fraz</div>
    <div class="modal-body">
      <div class="form-row">
        <label class="form-label">Nazwa zestawu</label>
        <input class="form-input" id="kw-modal-name" placeholder="np. Zapytania o szkolenia IT" />
      </div>
      <div class="form-row">
        <label class="form-label">Frazy i słowa kluczowe</label>
        <textarea class="kw-phrases-textarea" id="kw-modal-phrases" placeholder="szukam szkolenia z Excela&#10;kurs programowania&#10;potrzebuję nauczyciela&#10;(jedna fraza na linię)"></textarea>
        <div class="kw-hint">Wpisz każdą frazę w osobnej linii. Frazy będą używane podczas wyszukiwania.</div>
      </div>
      <div class="form-row">
        <label class="form-label">Powiązane źródła i podlinki</label>
        <div class="kw-source-picker" id="kw-source-picker"></div>
        <div class="kw-hint">Zaznacz źródła i wybierz konkretny podlink lub zostaw „Wszystkie".</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeKwModal()">Anuluj</button>
      <button class="btn-save" onclick="saveKwSet()">Zapisz</button>
    </div>
  </div>
</div>

<!-- REDDIT API MODAL -->
<div class="modal-overlay" id="reddit-modal-overlay">
  <div class="modal reddit-modal">
    <div class="modal-title">🤖 Reddit API — konfiguracja</div>
    <div class="modal-sub">Połącz aplikację z Reddit API aby uzyskiwać prawdziwe wyniki wyszukiwania</div>
    <div class="form-row" style="margin-bottom:16px">
      <div class="reddit-step">
        <div class="reddit-step-num">1</div>
        <div class="reddit-step-text">Wejdź na <a href="https://support.reddithelp.com/hc/en-us/articles/42728983564564-Responsible-Builder-Policy" target="_blank">Responsible Builder Policy</a>, przeczytaj i zaakceptuj politykę Reddit — bez tego formularz tworzenia aplikacji jest niedostępny.</div>
      </div>
      <div class="reddit-step">
        <div class="reddit-step-num">2</div>
        <div class="reddit-step-text">Wejdź na <a href="https://www.reddit.com/prefs/apps" target="_blank">reddit.com/prefs/apps</a> i kliknij <strong>„create another app..."</strong></div>
      </div>
      <div class="reddit-step">
        <div class="reddit-step-num">3</div>
        <div class="reddit-step-text">Wypełnij: dowolna nazwa, typ: <code>installed app</code>, redirect URI: <code>http://localhost</code> → kliknij <strong>create app</strong></div>
      </div>
      <div class="reddit-step">
        <div class="reddit-step-num">4</div>
        <div class="reddit-step-text">Pod nazwą aplikacji znajdziesz ciąg znaków (np. <code>AbCdEfGhIj1234</code>) — to Twój <strong>Client ID</strong>. Wklej go poniżej.</div>
      </div>
    </div>
    <div class="form-row">
      <label class="form-label">Client ID</label>
      <input class="form-input" id="reddit-client-id" placeholder="np. AbCdEfGhIj1234" autocomplete="off">
    </div>
    <div class="reddit-test-row">
      <button class="btn-cancel" style="font-size:0.78rem;padding:7px 14px" onclick="testRedditConnection()">⚡ Testuj połączenie</button>
      <span class="reddit-test-status" id="reddit-test-status"></span>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeRedditModal()">Anuluj</button>
      <button class="btn-save" onclick="saveRedditConfig()">Zapisz</button>
    </div>
  </div>
</div>

<!-- GOOGLE API MODAL -->
<div class="modal-overlay" id="google-modal-overlay">
  <div class="modal reddit-modal">
    <div class="modal-title">🔍 Google Custom Search API — konfiguracja</div>
    <div class="modal-sub">Prawdziwe wyniki Google wewnątrz aplikacji. Każde aktywne źródło Google = 1 zapytanie.</div>
    <div class="form-row" style="margin-bottom:16px">
      <div class="reddit-step">
        <div class="reddit-step-num">1</div>
        <div class="reddit-step-text">Wejdź na <a href="https://programmablesearchengine.google.com/" target="_blank">programmablesearchengine.google.com</a> → <strong>Dodaj</strong> → zaznacz <strong>„Wyszukaj w całej sieci"</strong> → skopiuj <strong>Identyfikator wyszukiwarki (cx)</strong></div>
      </div>
      <div class="reddit-step">
        <div class="reddit-step-num">2</div>
        <div class="reddit-step-text">Wejdź na <a href="https://console.cloud.google.com/apis/library/customsearch.googleapis.com" target="_blank">Google Cloud Console</a> → włącz <strong>Custom Search API</strong> → <strong>Dane logowania</strong> → <strong>Utwórz dane logowania</strong> → <strong>Klucz API</strong></div>
      </div>
      <div class="reddit-step">
        <div class="reddit-step-num">3</div>
        <div class="reddit-step-text">Wklej oba klucze poniżej i kliknij <strong>Testuj</strong></div>
      </div>
      <div class="reddit-step" style="border-color:rgba(234,179,8,0.4);background:rgba(234,179,8,0.07)">
        <div class="reddit-step-num" style="background:#ca8a04">⚠</div>
        <div class="reddit-step-text"><strong>Limit:</strong> 100 zapytań/dobę bezpłatnie. Każde aktywne źródło Google to osobne zapytanie — włącz tylko te, których naprawdę używasz.</div>
      </div>
    </div>
    <div class="form-row">
      <label class="form-label">Klucz API</label>
      <input class="form-input" id="google-api-key" placeholder="np. AIzaSyB…" autocomplete="off">
    </div>
    <div class="form-row" style="margin-top:10px">
      <label class="form-label">Identyfikator wyszukiwarki (cx)</label>
      <input class="form-input" id="google-cx" placeholder="np. 017576662512468239146:omuauf9t8to" autocomplete="off">
    </div>
    <div class="reddit-test-row">
      <button class="btn-cancel" style="font-size:0.78rem;padding:7px 14px" onclick="testGoogleConnection()">⚡ Testuj połączenie</button>
      <span class="reddit-test-status" id="google-test-status"></span>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeGoogleModal()">Anuluj</button>
      <button class="btn-save" onclick="saveGoogleConfig()">Zapisz</button>
    </div>
  </div>
</div>

<!-- SOURCE SEARCH MODAL -->
<div class="modal-overlay" id="src-search-modal-overlay">
  <div class="modal src-search-modal">
    <div class="modal-title">🔍 Szukaj nowych źródeł</div>
    <div class="modal-sub">Zbuduj zapytanie i wyślij je do Google AI, a następnie wklej wyniki tutaj</div>
    <div class="modal-body">
      <div class="form-row">
        <label class="form-label">Zapytanie do Google AI</label>
        <div class="query-builder">
          <span>szukam osób poszukujących</span>
          <input class="query-keyword-input" id="src-search-keyword" placeholder="np. szkoleń IT, agencji SEO, dostawcy..." onkeydown="if(event.key==='Enter')openGoogleAISearch()" />
          <span>wynik prezentuj w postaci nazwy źródła, pełnego linku (http://www. lub https://www) i krótkiego opisu w jednym zdaniu oraz znaczka [+] po każdym źródle.</span>
        </div>
        <div class="query-builder-actions">
          <button class="src-search-go-btn" onclick="openGoogleAISearch()">🌐 Otwórz Google AI</button>
          <button class="src-search-copy-btn" onclick="copySourceQuery()">📋 Skopiuj zapytanie</button>
        </div>
      </div>

      <div class="src-search-divider">Wklej wyniki Google AI</div>

      <div class="form-row">
        <textarea class="src-paste-area" id="src-paste-area" placeholder="Wklej tutaj odpowiedź z Google AI...&#10;&#10;Przykład:&#10;Elektroda.pl, https://elektroda.pl, Forum techniczne z aktywną społecznością elektroniczną. [+]&#10;OLX Usługi, https://olx.pl/uslugi/, Serwis ogłoszeń z sekcją usług dla firm i osób prywatnych. [+]"></textarea>
        <button class="src-analyze-btn" onclick="analyzeSourceResults()">🔎 Analizuj wyniki</button>
      </div>

      <div id="src-search-results" class="src-results-list"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeSrcSearchModal()">Zamknij</button>
    </div>
  </div>
</div>

<!-- ADD SOURCE MODAL -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <div class="modal-title">Dodaj nowe źródło</div>
    <div class="modal-sub">Skonfiguruj nowe miejsce przeszukiwania</div>
    <div class="form-row">
      <label class="form-label">Nazwa źródła</label>
      <input class="form-input" id="new-name" placeholder="np. Forum Moje Forum" />
    </div>
    <div class="form-row">
      <label class="form-label">Typ</label>
      <select class="form-select" id="new-type">
        <option value="forum">Forum</option>
        <option value="social">Social media</option>
        <option value="portal">Portal informacyjny</option>
        <option value="ogloszenia">Serwis ogłoszeniowy</option>
        <option value="it">Forum IT</option>
        <option value="biznes">Forum biznesowe</option>
      </select>
    </div>
    <div class="form-row">
      <label class="form-label">Silnik wyszukiwania</label>
      <select class="form-select" id="new-engine" onchange="document.getElementById('new-api-fields').style.display=this.value==='api'?'':'none'">
        <option value="internal">Wewnętrzna wyszukiwarka</option>
        <option value="google">Google Custom Search (cała sieć)</option>
        <option value="google_site">Google Custom Search (site:)</option>
        <option value="reddit">Reddit API</option>
        <option value="bing">Bing</option>
        <option value="duckduckgo">DuckDuckGo</option>
        <option value="api">API</option>
      </select>
    </div>
    <div id="new-api-fields" style="display:none">
      <div class="form-row">
        <label class="form-label">URL endpointu API</label>
        <input class="form-input" type="text" id="new-api-url" placeholder="https://api.example.com/search">
      </div>
      <div class="form-row">
        <label class="form-label">Klucz API <span style="font-weight:400;color:var(--text-dim)">(opcjonalnie)</span></label>
        <input class="form-input" type="password" id="new-api-key" placeholder="sk-...">
      </div>
    </div>
    <div class="form-row">
      <label class="form-label">Główny URL serwisu</label>
      <input class="form-input" id="new-baseurl" placeholder="https://forum.example.com" />
    </div>
    <div class="form-row">
      <label class="form-label">URL podforum / sekcji (opcjonalnie)</label>
      <input class="form-input" id="new-url" placeholder="https://forum.example.com/kategoria/" />
    </div>
    <div class="form-row">
      <label class="form-label">Ikona (emoji)</label>
      <input class="form-input" id="new-icon" placeholder="🌐" maxlength="2" style="width:80px" />
    </div>
    <div class="form-row">
      <label class="form-label">Zestawy fraz i słów kluczowych</label>
      <div class="kw-source-picker" id="new-kw-sets-picker"></div>
      <div class="kw-hint">Frazy z zaznaczonych zestawów będą używane podczas wyszukiwania w tym źródle.</div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal()">Anuluj</button>
      <button class="btn-save" onclick="saveNewSource()">Dodaj źródło</button>
    </div>
  </div>
</div>

<!-- LOGIN MODAL -->
<div class="modal-overlay" id="login-modal-overlay">
  <div class="modal login-modal">
    <div id="login-form-view">
      <div class="modal-title">Logowanie</div>
      <div class="modal-sub">Zaloguj się aby korzystać z pełnych możliwości</div>
      <div class="form-row">
        <label class="form-label">Email</label>
        <input class="form-input" id="login-email" type="email" placeholder="jan@firma.pl" />
      </div>
      <div class="form-row">
        <label class="form-label">Hasło</label>
        <input class="form-input" id="login-password" type="password" placeholder="••••••••"
          onkeydown="if(event.key==='Enter') doLogin()" />
      </div>
      <div id="login-error" style="display:none;color:var(--red);font-size:0.75rem;margin-top:-6px;margin-bottom:8px"></div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeLoginModal()">Anuluj</button>
        <button class="btn-save" onclick="doLogin()">Zaloguj</button>
      </div>
    </div>
    <div id="login-logged-view" style="display:none">
      <div class="modal-title">Konto</div>
      <div class="modal-sub" style="margin-bottom:16px">Jesteś zalogowany</div>
      <div class="login-user-row">
        <div class="login-avatar" id="login-avatar">?</div>
        <div>
          <div class="login-user-name" id="login-user-name">—</div>
          <div class="login-user-email" id="login-user-email">—</div>
        </div>
      </div>
      <div class="modal-footer" style="margin-top:16px">
        <button class="btn-cancel" onclick="closeLoginModal()">Zamknij</button>
        <button class="btn-save" style="background:var(--red)" onclick="doLogout()">Wyloguj</button>
      </div>
    </div>
  </div>
</div>

<!-- SCRIPT MODAL -->
<div class="modal-overlay" id="script-modal-overlay">
  <div class="modal script-modal">
    <div class="modal-title" id="script-modal-title">Dodaj skrypt</div>
    <div class="modal-sub">Skrypt dla niestandardowego wyszukiwania powiązany z silnikiem</div>
    <div class="modal-body">
      <div class="form-row">
        <label class="form-label">Nazwa skryptu</label>
        <input class="form-input" id="script-name" placeholder="np. OpenSearch API scraper">
      </div>
      <div style="display:flex;gap:12px">
        <div class="form-row" style="flex:1">
          <label class="form-label">Silnik</label>
          <select class="form-select" id="script-engine"></select>
        </div>
        <div class="form-row" style="flex:1">
          <label class="form-label">Język</label>
          <select class="form-select" id="script-language">
            <option value="javascript">JavaScript</option>
            <option value="python">Python</option>
            <option value="bash">Bash</option>
            <option value="curl">cURL</option>
            <option value="php">PHP</option>
            <option value="other">Inny</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <label class="form-label">Opis <span style="font-weight:400;color:var(--text-dim)">(opcjonalnie)</span></label>
        <input class="form-input" id="script-desc" placeholder="Co robi ten skrypt?">
      </div>
      <div class="form-row">
        <label class="form-label">Kod skryptu</label>
        <textarea class="script-textarea" id="script-code" placeholder="// Wpisz kod skryptu...&#10;// Skrypt zostanie uruchomiony gdy silnik wymaga niestandardowego wyszukiwania"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeScriptModal()">Anuluj</button>
      <button class="btn-save" onclick="saveScript()">Zapisz skrypt</button>
    </div>
  </div>
</div>

<!-- SOURCE CREDENTIALS MODAL -->
<div class="modal-overlay" id="src-cred-modal-overlay">
  <div class="modal src-cred-modal">
    <div class="modal-title" id="src-cred-title">Logowanie do źródła</div>
    <div class="modal-sub" id="src-cred-sub">Podaj dane dostępowe</div>
    <div class="src-cred-source-info" id="src-cred-info"></div>
    <div class="form-row">
      <label class="form-label">Login / Email</label>
      <input class="form-input" id="src-cred-login" type="text" placeholder="twój login lub email" />
    </div>
    <div class="form-row">
      <label class="form-label">Hasło</label>
      <div class="pass-input-wrap">
        <input class="form-input" id="src-cred-pass" type="password" placeholder="••••••••" />
        <button class="pass-toggle-btn" type="button" onclick="togglePassVis()" id="pass-toggle-btn">👁</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeSrcCredModal()">Anuluj</button>
      <button class="btn-save" onclick="saveSrcCred()">Zapisz</button>
    </div>
  </div>
</div>

<script>
// =====================
// DATA
// =====================
let savedLeads = JSON.parse(localStorage.getItem('lh_saved') || '[]');

const ENGINES = [
  { value: 'internal',    label: 'Wewnętrzna wyszukiwarka' },
  { value: 'google',      label: 'Google' },
  { value: 'google_site', label: 'Google (site:)' },
  { value: 'bing',        label: 'Bing' },
  { value: 'duckduckgo',  label: 'DuckDuckGo' },
  { value: 'api',         label: 'API' },
];

const SOURCES = JSON.parse(localStorage.getItem('lh_sources') || '[]');
let nextId = SOURCES.length ? Math.max(...SOURCES.map(s => s.id)) + 1 : 1;

function saveSources() {
  localStorage.setItem('lh_sources', JSON.stringify(SOURCES));
}

// =====================
// PAGES
// =====================
function showPage(page) {
  ['search','saved','sources','keywords','scripts','engines','credentials'].forEach(p => {
    document.getElementById(`page-${p}`).style.display = p === page ? 'block' : 'none';
  });
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  event.currentTarget.classList.add('active');
  const titles = {
    search:      ['Szukaj klientów',          'Przeszukuj fora i serwisy społecznościowe'],
    saved:       ['Zapisane leady',            'Twoja lista potencjalnych klientów'],
    sources:     ['Zarządzaj źródłami',        'Konfiguruj i edytuj źródła danych'],
    keywords:    ['Frazy i słowa kluczowe',    'Zestawy fraz powiązane z wybranymi źródłami'],
    scripts:     ['Skrypty',                   'Skrypty dla niestandardowych wyszukiwań'],
    engines:     ['Silniki wyszukiwań',        'Źródła pogrupowane według metody wyszukiwania'],
    credentials: ['Loginy do źródeł',          'Zarządzaj danymi dostępowymi do każdego źródła'],
  };
  document.getElementById('page-title').textContent = titles[page][0];
  document.getElementById('page-subtitle').textContent = titles[page][1];

  if (page === 'saved')       renderSaved();
  if (page === 'sources')     renderSourcesManage();
  if (page === 'keywords')    renderKeywords();
  if (page === 'scripts')     renderScripts();
  if (page === 'engines')     renderEngines();
  if (page === 'credentials') renderCredentials();
}

// =====================
// SORTING & FAVORITES
// =====================
let currentSort = 'name-asc'; // name-asc, name-desc, date-asc, date-desc
let showFavoritesOnly = false;

function changeSorting(sortType) {
  currentSort = sortType;
  renderSources();
  if (document.getElementById('page-sources').style.display !== 'none') {
    renderSourcesManage();
  }
}

function toggleFavorite(sourceId) {
  const source = SOURCES.find(s => s.id === sourceId);
  if (source) {
    source.favorite = !source.favorite;
    saveSources();
    renderSources();
    renderQuickQueries();
    if (document.getElementById('page-sources').style.display !== 'none') {
      renderSourcesManage();
    }
  }
}

function getLoginStatus(source) {
  if (!source.loginRequired) {
    return 'not-applicable';
  }
  const cred = getSourceCred(source.id);
  return cred ? 'logged-in' : 'logged-out';
}

function getSortedSources() {
  let sources = [...SOURCES];
  
  // Sortowanie
  switch (currentSort) {
    case 'name-asc':
      sources.sort((a, b) => a.name.localeCompare(b.name));
      break;
    case 'name-desc':
      sources.sort((a, b) => b.name.localeCompare(a.name));
      break;
    case 'date-asc':
      sources.sort((a, b) => new Date(a.dateAdded) - new Date(b.dateAdded));
      break;
    case 'date-desc':
      sources.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
      break;
  }
  
  return sources;
}
// =====================
// RENDER SOURCES
// =====================
function typeBadge(t) {
  const map = { forum:'badge-forum', social:'badge-social', portal:'badge-portal', ogloszenia:'badge-ogloszenia', it:'badge-it', biznes:'badge-biznes' };
  const labels = { forum:'Forum', social:'Social', portal:'Portal', ogloszenia:'Ogłoszenia', it:'IT', biznes:'Biznes' };
  return `<span class="source-type-badge ${map[t]||'badge-forum'}">${labels[t]||t}</span>`;
}

function renderSources() {
  const sortedSources = getSortedSources();
  const enabled = sortedSources.filter(s => s.enabled);
  
  // Podziel na ulubione i pozostałe
  const favorites = enabled.filter(s => s.favorite);
  const others = enabled.filter(s => !s.favorite);
  
  // Znajdź lub utwórz kontener dla źródeł
  let sourcesContainer = document.getElementById('sources-container');
  if (!sourcesContainer) {
    sourcesContainer = document.createElement('div');
    sourcesContainer.id = 'sources-container';
    
    // Znajdź miejsce w page-search i dodaj przed results-section
    const pageSearch = document.getElementById('page-search');
    const resultsSection = document.getElementById('results-section');
    if (pageSearch && resultsSection) {
      pageSearch.insertBefore(sourcesContainer, resultsSection);
    } else if (pageSearch) {
      // Jeśli nie ma results-section, dodaj przed empty-state
      const emptyState = document.getElementById('empty-state');
      if (emptyState) {
        pageSearch.insertBefore(sourcesContainer, emptyState);
      } else {
        pageSearch.appendChild(sourcesContainer);
      }
    }
  }
  
  let html = '';
  
  // Sekcja ulubionych
  if (favorites.length > 0) {
    html += `
      <div class="sources-header">
        <div class="sources-title">⭐ Ulubione źródła</div>
        <div class="sources-controls">
          <select class="sort-dropdown" onchange="changeSorting(this.value)">
            <option value="name-asc" ${currentSort === 'name-asc' ? 'selected' : ''}>Nazwa A-Z</option>
            <option value="name-desc" ${currentSort === 'name-desc' ? 'selected' : ''}>Nazwa Z-A</option>
            <option value="date-asc" ${currentSort === 'date-asc' ? 'selected' : ''}>Data dodania ↑</option>
            <option value="date-desc" ${currentSort === 'date-desc' ? 'selected' : ''}>Data dodania ↓</option>
          </select>
        </div>
      </div>
      <div class="sources-grid">
        ${favorites.map(s => sourceCardHTML(s)).join('')}
      </div>
    `;
  }
  
  // Sekcja pozostałych aktywnych
  if (others.length > 0) {
    html += `
      <div class="sources-header" ${favorites.length > 0 ? 'style="margin-top:32px"' : ''}>
        <div class="sources-title">Aktywne źródła</div>
        ${favorites.length === 0 ? `
        <div class="sources-controls">
          <select class="sort-dropdown" onchange="changeSorting(this.value)">
            <option value="name-asc" ${currentSort === 'name-asc' ? 'selected' : ''}>Nazwa A-Z</option>
            <option value="name-desc" ${currentSort === 'name-desc' ? 'selected' : ''}>Nazwa Z-A</option>
            <option value="date-asc" ${currentSort === 'date-asc' ? 'selected' : ''}>Data dodania ↑</option>
            <option value="date-desc" ${currentSort === 'date-desc' ? 'selected' : ''}>Data dodania ↓</option>
          </select>
        </div>` : ''}
      </div>
      <div class="sources-grid">
        ${others.map(s => sourceCardHTML(s)).join('')}
      </div>
    `;
  }
  
  // Jeśli brak włączonych źródeł
  if (enabled.length === 0) {
    html = `
      <div class="sources-header">
        <div class="sources-title">Aktywne źródła</div>
        <div class="sources-controls">
          <select class="sort-dropdown" onchange="changeSorting(this.value)">
            <option value="name-asc" ${currentSort === 'name-asc' ? 'selected' : ''}>Nazwa A-Z</option>
            <option value="name-desc" ${currentSort === 'name-desc' ? 'selected' : ''}>Nazwa Z-A</option>
            <option value="date-asc" ${currentSort === 'date-asc' ? 'selected' : ''}>Data dodania ↑</option>
            <option value="date-desc" ${currentSort === 'date-desc' ? 'selected' : ''}>Data dodania ↓</option>
          </select>
        </div>
      </div>
      <div class="sources-grid">
        <div style="color:var(--text-dim);font-size:0.78rem;padding:12px 0">Brak włączonych źródeł. Włącz je w <a href="#" onclick="document.querySelectorAll('.nav-item')[2].click();return false;" style="color:var(--accent)">Zarządzaj źródłami</a>.</div>
      </div>
    `;
  }
  
  if (sourcesContainer) {
    sourcesContainer.innerHTML = html;
  }
}

function toggleSource(id, val) {
  const s = SOURCES.find(x => x.id === id);
  if (s) s.enabled = val;
  saveSources();
  renderSources();
}

function sourceCardHTML(s, fullSettings = false) {
  if (!s.subforums) s.subforums = s.subforum ? [s.subforum] : [''];
  const iconBg = s.color || '#e8f0fc';
  const filledCount = s.subforums.filter(u => u.trim()).length;
  const countLabel = filledCount > 0 ? `<span class="subforum-count">(${filledCount})</span>` : '';
  const loginStatus = getLoginStatus(s);
  const statusTitles = {
    'logged-in': 'Zalogowany',
    'logged-out': 'Niezalogowany',
    'not-applicable': 'Logowanie niewymagane'
  };

  const settingsPanel = fullSettings ? `
    <button class="settings-toggle-btn" id="stbtn-${s.id}" onclick="toggleSettings(${s.id})">
      <span class="chevron">▾</span> Ustawienia
    </button>
    <div class="source-card-body" id="sbody-${s.id}">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <div class="field-label" style="margin:0">Dane logowania</div>
        ${srcLoginBtnHTML(s.id)}
      </div>
      <div class="field-label" style="margin-top:6px">Silnik wyszukiwania</div>
      <select class="engine-select" onchange="updateSource(${s.id},'engine',this.value);toggleApiFields(${s.id},this.value)">
        ${ENGINES.map(e => `<option value="${e.value}" ${(s.engine||'internal')===e.value?'selected':''}>${e.label}</option>`).join('')}
      </select>
      <div id="api-fields-${s.id}" style="${(s.engine||'')!=='api'?'display:none':''}">
        <div class="field-label" style="margin-top:8px">URL endpointu API</div>
        <input class="field-input" type="text" placeholder="https://api.example.com/search" value="${s.apiUrl||''}" oninput="updateSource(${s.id},'apiUrl',this.value)">
        <div class="field-label" style="margin-top:8px">Klucz API <span style="font-weight:400;color:var(--text-dim)">(opcjonalnie)</span></div>
        <input class="field-input" type="password" placeholder="sk-..." value="${s.apiKey||''}" oninput="updateSource(${s.id},'apiKey',this.value)">
      </div>
      <div class="field-label" style="margin-top:10px">Podfora / sekcje ${countLabel}</div>
      <div class="subforum-list" id="sflist-${s.id}">
        ${s.subforums.map((url, idx) => subforumRowHTML(s.id, idx, url)).join('')}
      </div>
      <button class="subforum-add-btn" onclick="addSubforum(${s.id})">+ Dodaj kolejny link</button>
      <div class="field-label" style="margin-top:10px">Opis źródła <span style="font-weight:400;color:var(--text-dim)">(widoczny po najechaniu na kafelek)</span></div>
      <textarea class="field-input keywords-input" id="sdesc-${s.id}" placeholder="Krótki opis źródła..." maxlength="255" oninput="updateSource(${s.id},'desc',this.value)" style="min-height:52px;resize:vertical">${s.desc||''}</textarea>
      <div class="field-label" style="margin-top:10px">Powiązane zestawy fraz</div>
      <div style="margin-top:5px;display:flex;flex-wrap:wrap;gap:3px">${getSourceKwSetsHTML(s.id)}</div>
      <div class="field-label" style="margin-top:10px">Słowa kluczowe aktywne (z zestawów)</div>
      <textarea class="field-input keywords-input" id="skw-${s.id}" placeholder="np. szukam, polecacie, potrzebuję..." oninput="updateSource(${s.id},'keywords',this.value)" title="Zarządzaj frazami przez zakładkę Frazy i słowa kluczowe">${s.keywords||''}</textarea>
    </div>` : '';

  const toggleHTML = fullSettings ? `
      <label class="source-toggle">
        <input type="checkbox" ${s.enabled?'checked':''} onchange="toggleSource(${s.id}, this.checked)">
        <span class="toggle-slider"></span>
      </label>` : '';

  const subforumsDisplay = !fullSettings ? (() => {
    const filled = s.subforums.filter(u => u.trim());
    if (!filled.length) return '';
    return `<div class="card-subforums">${filled.map(u => `<a class="card-subforum-chip" href="${u}" target="_blank" onclick="event.stopPropagation()" title="${u}">↗ ${u.replace(/https?:\/\/(www\.)?/,'').replace(/\/$/,'')}</a>`).join('')}</div>`;
  })() : '';

  const cardTitle = !fullSettings && s.desc ? s.desc : '';

  return `
  <div class="source-card" id="scard-${s.id}"${cardTitle ? ` title="${cardTitle.replace(/"/g,'&quot;')}"` : ''}>
    <div class="source-card-header">
      <div class="source-icon" style="background:${iconBg}">${s.icon}</div>
      <div class="source-info">
        <div class="source-name">${s.name}</div>
        ${typeBadge(s.type)}
        ${s.baseUrl ? `<a class="source-base-url" href="${s.baseUrl}" target="_blank" onclick="event.stopPropagation()">🔗 ${s.baseUrl.replace('https://','').replace('www.','')}</a>` : ''}
      </div>
      ${toggleHTML}
      <button class="favorite-btn${s.favorite ? ' active' : ''}" onclick="toggleFavorite(${s.id})" title="${s.favorite ? 'Usuń z ulubionych' : 'Dodaj do ulubionych'}">
        ${s.favorite ? '⭐' : '☆'}
      </button>
      ${fullSettings ? `<button class="clone-btn" onclick="cloneSource(${s.id})" title="Klonuj źródło">⧉</button><button class="delete-src-btn" onclick="deleteSource(${s.id})" title="Usuń źródło">🗑</button>` : ''}
      <div class="login-status-lamp ${loginStatus}" title="${statusTitles[loginStatus]}"></div>
    </div>
    ${subforumsDisplay}
    ${settingsPanel}
  </div>
  `;
}

function subforumRowHTML(sourceId, idx, url) {
  return `
    <div class="subforum-row" id="sfrow-${sourceId}-${idx}">
      <input class="field-input" value="${url}" placeholder="https://forum.example.com/kategoria/"
        oninput="updateSubforum(${sourceId}, ${idx}, this.value)" />
      <button class="subforum-remove" onclick="removeSubforum(${sourceId}, ${idx})" title="Usuń">×</button>
    </div>
  `;
}

let manageView = 'grid';

function setManageView(v, btn) {
  manageView = v;
  document.querySelectorAll('.manage-view-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderSourcesManage();
}

function renderSourcesManage() {
  const container = document.getElementById('sources-manage-content');
  const sortedSources = getSortedSources();
  
  document.getElementById('manage-count').textContent = sortedSources.length + ' źródeł';
  
  // Aktualizuj topbar
  const topbar = document.querySelector('.manage-topbar');
  if (topbar) {
    topbar.innerHTML = `
      <div class="manage-topbar-left">
        <div class="sources-title">Wszystkie źródła</div>
        <div class="manage-count" id="manage-count">${sortedSources.length} źródeł</div>
      </div>
      <div class="manage-topbar-right">
        <select class="sort-dropdown" onchange="changeSorting(this.value)">
          <option value="name-asc" ${currentSort === 'name-asc' ? 'selected' : ''}>Nazwa A-Z</option>
          <option value="name-desc" ${currentSort === 'name-desc' ? 'selected' : ''}>Nazwa Z-A</option>
          <option value="date-asc" ${currentSort === 'date-asc' ? 'selected' : ''}>Data dodania ↑</option>
          <option value="date-desc" ${currentSort === 'date-desc' ? 'selected' : ''}>Data dodania ↓</option>
        </select>
        <div class="manage-view-toggle">
          <button class="manage-view-btn${manageView === 'grid' ? ' active' : ''}" id="mgbtn-grid" onclick="setManageView('grid',this)">
            <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><rect x="0" y="0" width="5.5" height="5.5" rx="1" fill="currentColor"/><rect x="7.5" y="0" width="5.5" height="5.5" rx="1" fill="currentColor"/><rect x="0" y="7.5" width="5.5" height="5.5" rx="1" fill="currentColor"/><rect x="7.5" y="7.5" width="5.5" height="5.5" rx="1" fill="currentColor"/></svg>
            Kafelki
          </button>
          <button class="manage-view-btn${manageView === 'list' ? ' active' : ''}" id="mgbtn-list" onclick="setManageView('list',this)">
            <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><rect x="0" y="1" width="13" height="2" rx="1" fill="currentColor"/><rect x="0" y="5.5" width="13" height="2" rx="1" fill="currentColor"/><rect x="0" y="10" width="13" height="2" rx="1" fill="currentColor"/></svg>
            Lista
          </button>
        </div>
        <button class="io-btn" onclick="exportSources()" title="Eksportuj źródła do pliku JSON">
          <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><path d="M6.5 1v8M3 6.5l3.5 3.5 3.5-3.5M1 11h11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Eksport
        </button>
        <button class="io-btn" onclick="importSources()" title="Importuj źródła z pliku JSON">
          <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><path d="M6.5 12V4M3 6.5L6.5 3 10 6.5M1 1h11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Import
        </button>
        <button class="search-source-btn" onclick="openSrcSearchModal()">🔍 Szukaj źródeł</button>
        <button class="add-source-btn" onclick="openAddModal()">+ Dodaj źródło</button>
      </div>`;
  }

  if (!sortedSources.length) {
    container.innerHTML = `<div class="empty-state"><div class="icon">📋</div><h3>Brak źródeł</h3><p>Kliknij „+ Dodaj źródło" aby dodać pierwsze źródło wyszukiwania.</p></div>`;
    return;
  }

  if (manageView === 'grid') {
    let html = '';

    // Podziel na aktywne i nieaktywne
    const active = sortedSources.filter(s => s.enabled);
    const inactive = sortedSources.filter(s => !s.enabled);
    
    // Sekcja aktywnych
    if (active.length > 0) {
      html += `
        <div class="sources-header" style="margin-bottom:16px">
          <div class="sources-title">✅ Aktywne źródła (${active.length})</div>
        </div>
        <div class="sources-grid" style="margin-bottom:32px">
          ${active.map(s => sourceCardHTML(s, true)).join('')}
        </div>
      `;
    }
    
    // Sekcja nieaktywnych
    if (inactive.length > 0) {
      html += `
        <div class="sources-header" style="margin-bottom:16px">
          <div class="sources-title">⏸️ Nieaktywne źródła (${inactive.length})</div>
        </div>
        <div class="sources-grid">
          ${inactive.map(s => sourceCardHTML(s, true)).join('')}
        </div>
      `;
    }
    
    container.innerHTML = html;
  } else {
    const active   = sortedSources.filter(s => s.enabled);
    const inactive = sortedSources.filter(s => !s.enabled);
    let html = '';
    if (active.length > 0) {
      html += `<div class="sources-header" style="margin-bottom:16px"><div class="sources-title">✅ Aktywne źródła (${active.length})</div></div>`;
      html += sourceListTableHTML(active);
      html += `<div style="margin-bottom:28px"></div>`;
    }
    if (inactive.length > 0) {
      html += `<div class="sources-header" style="margin-bottom:16px"><div class="sources-title">⏸️ Nieaktywne źródła (${inactive.length})</div></div>`;
      html += sourceListTableHTML(inactive);
    }
    container.innerHTML = html;
  }
}

function sourceListTableHTML(sources = null) {
  const sortedSources = sources || getSortedSources();
  const rows = sortedSources.map(s => {
    if (!s.subforums) s.subforums = s.subforum ? [s.subforum] : [''];
    const filled = s.subforums.filter(u => u.trim());
    const loginStatus = getLoginStatus(s);
    const statusTitles = {
      'logged-in': 'Zalogowany',
      'logged-out': 'Niezalogowany', 
      'not-applicable': 'Niewymagane'
    };
    
    let urlsHTML = '';
    if (filled.length === 0) {
      urlsHTML = `<span class="slt-url-empty">Brak URL</span>`;
    } else {
      urlsHTML = `<span class="slt-url-chip" title="${filled[0]}">${filled[0]}</span>`;
      if (filled.length > 1) urlsHTML += `<span class="slt-url-more">+${filled.length - 1} więcej</span>`;
    }
    const kwShort = s.keywords ? s.keywords : '—';
    const engineLabel = (ENGINES.find(e => e.value === (s.engine||'internal')) || ENGINES[0]).label;
    const enabledHTML = `<label class="source-toggle" style="display:inline-block">
      <input type="checkbox" ${s.enabled?'checked':''} onchange="toggleSource(${s.id},this.checked)">
      <span class="toggle-slider"></span>
    </label>`;
    
    const favoriteHTML = `<button class="favorite-btn${s.favorite ? ' active' : ''}" onclick="toggleFavorite(${s.id})" style="position:static;opacity:1;margin-right:4px;font-size:0.8rem" title="${s.favorite ? 'Usuń z ulubionych' : 'Dodaj do ulubionych'}">
      ${s.favorite ? '⭐' : '☆'}
    </button>`;
    
    const nameHTML = `
      <div style="display:flex;align-items:center;gap:4px;min-width:120px">
        ${favoriteHTML}
        <div>
          <div class="slt-name">${s.name}</div>
          ${typeBadge(s.type)}
          ${s.baseUrl ? `<br><a class="source-base-url" href="${s.baseUrl}" target="_blank">🔗 ${s.baseUrl.replace('https://','').replace('www.','').substring(0,25)}</a>` : ''}
        </div>
      </div>
    `;
    
    return `
      <tr id="sltr-${s.id}">
        <td><div class="slt-icon" style="background:${s.color||'#e8f0fc'}">${s.icon}</div></td>
        <td>
          ${nameHTML}
        </td>
        <td><div style="display:flex;flex-direction:column;gap:3px">${urlsHTML}</div></td>
        <td><div class="slt-keywords" title="${s.keywords}">${kwShort}</div></td>
        <td><span class="engine-badge">${engineLabel}</span></td>
        <td>
          <div style="display:flex;align-items:center;gap:6px;min-width:80px">
            <div class="login-status-lamp ${loginStatus}" title="${statusTitles[loginStatus]}" style="position:static"></div>
            <div style="font-size:0.7rem">${srcLoginBtnHTML(s.id)}</div>
          </div>
        </td>
        <td style="text-align:center">${enabledHTML}</td>
        <td style="white-space:nowrap">
          <button class="slt-edit-btn" onclick="toggleListSettings(${s.id})" style="font-size:0.65rem;padding:3px 8px">⚙</button>
          <button class="clone-btn" onclick="cloneSource(${s.id})" title="Klonuj źródło" style="margin-left:4px">⧉</button>
          <button class="delete-src-btn" onclick="deleteSource(${s.id})" title="Usuń źródło" style="margin-left:4px">🗑</button>
        </td>
      </tr>
      <tr class="slt-settings-row" id="slts-${s.id}" style="display:none">
        <td colspan="8">
          <div class="slt-settings-inner">
            <div class="field-label">Silnik wyszukiwania</div>
            <select class="engine-select" onchange="updateSource(${s.id},'engine',this.value);toggleApiFields(${s.id},this.value)">
              ${ENGINES.map(e => `<option value="${e.value}" ${(s.engine||'internal')===e.value?'selected':''}>${e.label}</option>`).join('')}
            </select>
            <div id="api-fields-${s.id}" style="${(s.engine||'')!=='api'?'display:none':''}">
              <div class="field-label" style="margin-top:8px">URL endpointu API</div>
              <input class="field-input" type="text" placeholder="https://api.example.com/search" value="${s.apiUrl||''}" oninput="updateSource(${s.id},'apiUrl',this.value)">
              <div class="field-label" style="margin-top:8px">Klucz API <span style="font-weight:400;color:var(--text-dim)">(opcjonalnie)</span></div>
              <input class="field-input" type="password" placeholder="sk-..." value="${s.apiKey||''}" oninput="updateSource(${s.id},'apiKey',this.value)">
            </div>
            <div class="field-label" style="margin-top:10px">Podfora / sekcje</div>
            <div class="subforum-list" id="sflist-${s.id}">
              ${s.subforums.map((url, idx) => subforumRowHTML(s.id, idx, url)).join('')}
            </div>
            <button class="subforum-add-btn" onclick="addSubforum(${s.id})">+ Dodaj kolejny link</button>
            <div class="field-label" style="margin-top:10px">Opis źródła <span style="font-weight:400;color:var(--text-dim)">(widoczny po najechaniu na kafelek)</span></div>
            <textarea class="field-input keywords-input" id="sdesc-${s.id}" placeholder="Krótki opis źródła..." maxlength="255" oninput="updateSource(${s.id},'desc',this.value)" style="min-height:52px;resize:vertical">${s.desc||''}</textarea>
            <div class="field-label" style="margin-top:10px">Powiązane zestawy fraz</div>
            <div style="margin-top:5px;display:flex;flex-wrap:wrap;gap:3px">${getSourceKwSetsHTML(s.id)}</div>
            <div class="field-label" style="margin-top:10px">Słowa kluczowe aktywne (z zestawów)</div>
            <textarea class="field-input keywords-input" id="skw-${s.id}" placeholder="np. szukam, polecacie, potrzebuję..." oninput="updateSource(${s.id},'keywords',this.value)">${s.keywords||''}</textarea>
          </div>
        </td>
      </tr>
    `;
  }).join('');
  return `
    <div class="sources-table-wrapper">
    <table class="sources-list-table">
      <thead><tr>
        <th style="width:44px"></th>
        <th>Źródło</th>
        <th>Podfora</th>
        <th>Słowa kluczowe</th>
        <th>Silnik</th>
        <th>Logowanie</th>
        <th style="text-align:center">Aktywne</th>
        <th></th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
    </div>`;
}

function toggleListSettings(id) {
  const row = document.getElementById(`slts-${id}`);
  if (!row) return;
  const visible = row.style.display !== 'none';
  row.style.display = visible ? 'none' : 'table-row';
  // update button label
  const btn = document.querySelector(`#sltr-${id} .slt-edit-btn`);
  if (btn) btn.textContent = visible ? '⚙ Edytuj' : '✕ Zamknij';
}


function toggleSettings(id) {
  const body = document.getElementById(`sbody-${id}`);
  const btn = document.getElementById(`stbtn-${id}`);
  const open = body.classList.toggle('open');
  btn.classList.toggle('open', open);
}

function updateSource(id, field, val) {
  const s = SOURCES.find(x => x.id === id);
  if (s) { s[field] = val; saveSources(); }
}

function updateSubforum(sourceId, idx, val) {
  const s = SOURCES.find(x => x.id === sourceId);
  if (!s) return;
  s.subforums[idx] = val;
  // update count label in both grids
  refreshSubforumCount(sourceId);
}

function addSubforum(sourceId) {
  const s = SOURCES.find(x => x.id === sourceId);
  if (!s) return;
  s.subforums.push('');
  const idx = s.subforums.length - 1;
  // append row to both grids (search page + manage page)
  ['sflist-' + sourceId].forEach(listId => {
    const list = document.getElementById(listId);
    if (list) {
      list.insertAdjacentHTML('beforeend', subforumRowHTML(sourceId, idx, ''));
      // focus the new input
      const inputs = list.querySelectorAll('.subforum-row input');
      if (inputs.length) inputs[inputs.length - 1].focus();
    }
  });
  refreshSubforumCount(sourceId);
}

function removeSubforum(sourceId, idx) {
  const s = SOURCES.find(x => x.id === sourceId);
  if (!s) return;
  if (s.subforums.length <= 1) {
    // just clear it instead of removing
    s.subforums[0] = '';
    const input = document.querySelector(`#sfrow-${sourceId}-0 input`);
    if (input) input.value = '';
    return;
  }
  s.subforums.splice(idx, 1);
  // re-render the list
  const list = document.getElementById(`sflist-${sourceId}`);
  if (list) list.innerHTML = s.subforums.map((url, i) => subforumRowHTML(sourceId, i, url)).join('');
  refreshSubforumCount(sourceId);
}

function refreshSubforumCount(sourceId) {
  const s = SOURCES.find(x => x.id === sourceId);
  if (!s) return;
  const filledCount = s.subforums.filter(u => u.trim()).length;
  // update the label in every open settings panel
  document.querySelectorAll(`#sbody-${sourceId} .subforum-count`).forEach(el => {
    el.textContent = filledCount > 0 ? `(${filledCount})` : '';
  });
}


// =====================
// SEARCH
// =====================

let currentResults = [];
let searching = false;
let selectedIndices = new Set();

function toggleSelect(idx, checked) {
  if (checked) selectedIndices.add(idx);
  else selectedIndices.delete(idx);
  document.getElementById(`ri-${idx}`).classList.toggle('selected', checked);
  // update select-all state
  const total = currentResults.length;
  document.getElementById('select-all-cb').checked = selectedIndices.size === total;
  document.getElementById('select-all-cb').indeterminate = selectedIndices.size > 0 && selectedIndices.size < total;
  updateBulkBar();
}

function toggleSelectAll(checked) {
  currentResults.forEach((_, i) => {
    if (checked) selectedIndices.add(i);
    else selectedIndices.delete(i);
    const el = document.getElementById(`ri-${i}`);
    if (el) el.classList.toggle('selected', checked);
    const cb = document.querySelector(`.result-checkbox[data-idx="${i}"]`);
    if (cb) cb.checked = checked;
  });
  updateBulkBar();
}

function updateBulkBar() {
  const bar = document.getElementById('bulk-bar');
  const count = selectedIndices.size;
  document.getElementById('bulk-count').textContent = count;
  bar.classList.toggle('visible', count > 0);
}

function bulkDeselect() {
  toggleSelectAll(false);
  document.getElementById('select-all-cb').checked = false;
  document.getElementById('select-all-cb').indeterminate = false;
}

function bulkSave() {
  let saved = 0;
  selectedIndices.forEach(i => {
    const btn = document.getElementById(`save-btn-${i}`);
    if (btn && !btn.dataset.saved) {
      saveLead(i, btn);
      saved++;
    }
  });
  const bar = document.getElementById('bulk-bar');
  const orig = document.getElementById('bulk-count').textContent;
  document.getElementById('bulk-bar').innerHTML = `<span style="color:#7effc0;font-weight:600;font-size:0.85rem">✅ Zapisano ${saved} lead${saved === 1 ? '' : 'ów'}!</span>`;
  setTimeout(() => {
    bulkDeselect();
    // restore bar content
    bar.innerHTML = `
      <div class="bulk-bar-count">Zaznaczono: <strong id="bulk-count">0</strong></div>
      <div class="bulk-bar-sep"></div>
      <button class="bulk-btn accent" onclick="bulkSave()">🔖 Zapisz zaznaczone</button>
      <button class="bulk-btn" onclick="bulkCopy()">📋 Kopiuj linki</button>
      <button class="bulk-btn danger" onclick="bulkDeselect()">✕ Odznacz</button>
      <button class="bulk-deselect" onclick="bulkDeselect()" title="Zamknij">✕</button>`;
  }, 1800);
}

function bulkCopy() {
  const links = [...selectedIndices].map(i => currentResults[i]?.url).filter(Boolean).join('\n');
  navigator.clipboard.writeText(links).catch(() => {});
  const btn = document.querySelector('.bulk-btn:nth-child(3)');
  const orig = '📋 Kopiuj linki';
  if (btn) { btn.textContent = `✅ Skopiowano ${selectedIndices.size}`; setTimeout(() => { btn.textContent = orig; }, 2000); }
}


function setQuery(q) {
  document.getElementById('main-query').value = q;
  document.getElementById('main-query').focus();
}

function quickSearch(q) {
  setQuery(q);
  // Switch to search page
  document.getElementById('page-saved').style.display = 'none';
  document.getElementById('page-sources').style.display = 'none';
  document.getElementById('page-search').style.display = 'block';
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  document.querySelector('.nav-item').classList.add('active');
  document.getElementById('page-title').textContent = 'Szukaj klientów';
  document.getElementById('page-subtitle').textContent = 'Przeszukuj fora i serwisy społecznościowe';
  doSearch();
}

async function doSearch() {
  if (searching) return;
  const query = document.getElementById('main-query').value.trim();
  if (!query) { document.getElementById('main-query').focus(); return; }

  searching = true;
  const btn = document.getElementById('search-btn');
  const icon = document.getElementById('search-btn-icon');
  btn.disabled = true;
  icon.textContent = '⏳';

  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('results-section').style.display = 'none';
  document.getElementById('stats-strip').style.display = 'none';
  document.getElementById('progress-bar').classList.add('active');

  const activeCount = SOURCES.filter(s => s.enabled).length;
  const redditCfg = loadRedditConfig();
  const redditActive = SOURCES.some(s => s.enabled && (s.engine === 'reddit' || s.id === 11));
  const googleCfg = loadGoogleConfig();
  const googleActive = SOURCES.some(s => s.enabled && (s.engine === 'google' || s.engine === 'google_site'));

  const redditPromise = (redditActive && redditCfg.clientId)
    ? searchRedditAPI(query).catch(() => [])
    : Promise.resolve([]);

  const googlePromise = (googleActive && googleCfg.apiKey && googleCfg.cx)
    ? searchGoogleAPI(query).catch(() => [])
    : Promise.resolve([]);

  const [redditResults, googleResults] = await Promise.all([redditPromise, googlePromise]);

  currentResults = [...redditResults, ...googleResults]
    .sort((a, b) => b.relevance - a.relevance);

  searching = false;
  btn.disabled = false;
  icon.textContent = '🔍';
  document.getElementById('progress-bar').classList.remove('active');

  renderResults(query, activeCount);
}

function renderResults(query, sourceCount) {
  const list = document.getElementById('results-list');
  selectedIndices.clear();
  updateBulkBar();

  if (!currentResults.length) {
    const redditCfg = loadRedditConfig();
    const googleCfg = loadGoogleConfig();
    const hasApi = redditCfg.clientId || (googleCfg.apiKey && googleCfg.cx);
    list.innerHTML = `<div class="empty-state" style="padding:40px 20px">
      <div class="icon">${hasApi ? '🔍' : '🔑'}</div>
      <h3>${hasApi ? 'Brak wyników' : 'Brak skonfigurowanego API'}</h3>
      <p>${hasApi
        ? `Zapytanie „${query}" nie zwróciło wyników. Spróbuj innych słów kluczowych lub włącz więcej źródeł.`
        : 'Skonfiguruj Reddit API lub Google Custom Search API w zakładce <strong>Silniki wyszukiwań</strong>, aby rozpocząć wyszukiwanie.'
      }</p>
    </div>`;
    document.getElementById('results-section').style.display = 'block';
    document.getElementById('results-title').textContent = `Wyniki dla: „${query}"`;
    document.getElementById('results-meta').textContent = '0 wyników';
    document.getElementById('stats-strip').style.display = 'none';
    document.getElementById('select-all-row').classList.remove('visible');
    return;
  }

  const hotCount = currentResults.filter(r => r.relevance >= 88).length;

  list.innerHTML = currentResults.map((r, i) => `
    <div class="result-item" style="animation-delay:${i*60}ms" id="ri-${i}">
      <div class="result-checkbox-wrap">
        <input type="checkbox" class="result-checkbox" data-idx="${i}" onchange="toggleSelect(${i}, this.checked)">
      </div>
      <div class="result-source-icon" style="background:${r.color}">${r.icon}</div>
      <div class="result-body">
        <div class="result-source-label">${r.source} ${typeBadge(r.type)}${r.isReal ? '<span class="real-badge">LIVE</span>' : ''}</div>
        <div class="result-title"><a href="${r.url}" target="_blank">${r.title}</a></div>
        <div class="result-snippet">${r.snippet}</div>
        <div class="result-footer">
          <span class="result-date">📅 ${r.date}</span>
          <span class="result-keyword-tag">🏷 ${r.keyword}</span>
          <div class="relevance-bar">
            <span class="relevance-label">${r.relevance}%</span>
            <div class="relevance-track"><div class="relevance-fill" style="width:${r.relevance}%"></div></div>
          </div>
          <div class="result-actions">
            <button class="result-btn" onclick="copyLink('${r.url}', this)">📋 Kopiuj</button>
            <button class="result-btn primary" onclick="saveLead(${i}, this)" id="save-btn-${i}">🔖 Zapisz lead</button>
          </div>
        </div>
      </div>
    </div>
  `).join('');

  document.getElementById('select-all-row').classList.add('visible');
  document.getElementById('select-all-cb').checked = false;

  document.getElementById('stat-results').textContent = currentResults.length;
  document.getElementById('stat-sources').textContent = sourceCount;
  document.getElementById('stat-hot').textContent = hotCount;
  document.getElementById('stat-saved').textContent = savedLeads.length;
  document.getElementById('stats-strip').style.display = 'flex';

  document.getElementById('results-title').textContent = `Wyniki dla: "${query}"`;
  document.getElementById('results-meta').textContent = `${currentResults.length} wyników · ${sourceCount} źródeł`;
  document.getElementById('results-section').style.display = 'block';
}

function copyLink(url, btn) {
  navigator.clipboard.writeText(url).catch(() => {});
  btn.textContent = '✅ Skopiowano';
  setTimeout(() => { btn.textContent = '📋 Kopiuj'; }, 2000);
}

function saveLead(idx, btn) {
  if (btn.dataset.saved) return;
  const r = currentResults[idx];
  if (!r) return;
  const lead = { ...r, savedAt: new Date().toLocaleDateString('pl-PL'), id: Date.now() };
  savedLeads.unshift(lead);
  localStorage.setItem('lh_saved', JSON.stringify(savedLeads));
  btn.dataset.saved = '1';
  btn.innerHTML = '✅ Zapisano';
  btn.style.background = '#e8f5ee';
  btn.style.color = '#1a7a4a';
  btn.style.borderColor = 'rgba(26,122,74,0.3)';
  document.getElementById('saved-count').textContent = savedLeads.length;
  document.getElementById('stat-saved').textContent = savedLeads.length;
}

// =====================
// REDDIT API
// =====================
function loadRedditConfig() {
  return JSON.parse(localStorage.getItem('lh_reddit') || JSON.stringify({ clientId: '', token: null, tokenExpiry: null }));
}
function saveRedditConfigToStorage(cfg) {
  localStorage.setItem('lh_reddit', JSON.stringify(cfg));
}

async function getRedditToken() {
  const cfg = loadRedditConfig();
  if (!cfg.clientId) throw new Error('Brak Client ID');
  if (cfg.token && cfg.tokenExpiry && Date.now() < cfg.tokenExpiry - 300000) return cfg.token;
  const resp = await fetch('https://www.reddit.com/api/v1/access_token', {
    method: 'POST',
    headers: {
      'Authorization': 'Basic ' + btoa(cfg.clientId + ':'),
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: 'grant_type=https://oauth.reddit.com/grants/installed_client&device_id=DO_NOT_TRACK_THIS_DEVICE'
  });
  if (!resp.ok) throw new Error('Błąd autoryzacji: ' + resp.status);
  const data = await resp.json();
  if (!data.access_token) throw new Error(data.message || 'Brak tokenu');
  cfg.token = data.access_token;
  cfg.tokenExpiry = Date.now() + (data.expires_in || 86400) * 1000;
  saveRedditConfigToStorage(cfg);
  return cfg.token;
}

async function searchRedditAPI(query) {
  const token = await getRedditToken();
  const headers = { 'Authorization': `Bearer ${token}`, 'User-Agent': 'LeadHunter/1.0.0-alfa' };
  const redditSources = SOURCES.filter(s => s.enabled && (s.engine === 'reddit' || s.id === 11));
  if (!redditSources.length) return [];

  const subreddits = [];
  redditSources.forEach(s => {
    (s.subforums || []).forEach(url => {
      const m = url.match(/\/r\/([^\/]+)/);
      if (m) subreddits.push(m[1]);
    });
  });
  if (!subreddits.length) subreddits.push('all');

  const results = [];
  for (const sub of subreddits) {
    try {
      const url = `https://oauth.reddit.com/r/${sub}/search.json?q=${encodeURIComponent(query)}&restrict_sr=1&sort=new&limit=10&t=year`;
      const resp = await fetch(url, { headers });
      if (!resp.ok) continue;
      const json = await resp.json();
      const posts = json?.data?.children || [];
      posts.forEach(({ data: p }) => {
        const snippet = (p.selftext || p.title || '').slice(0, 220);
        results.push({
          id: p.id,
          source: `Reddit r/${sub}`,
          icon: '🤖',
          color: '#fde8f0',
          type: 'social',
          title: p.title,
          url: `https://www.reddit.com${p.permalink}`,
          snippet: snippet || '(brak treści)',
          date: new Date(p.created_utc * 1000).toLocaleDateString('pl-PL'),
          keyword: query,
          relevance: Math.min(98, 60 + Math.round((p.score || 0) / 5)),
          isReal: true
        });
      });
    } catch(e) { /* ignoruj błędy pojedynczego subredditu */ }
  }
  return results;
}

function openRedditModal() {
  const cfg = loadRedditConfig();
  document.getElementById('reddit-client-id').value = cfg.clientId || '';
  document.getElementById('reddit-test-status').textContent = '';
  document.getElementById('reddit-modal-overlay').classList.add('open');
  setTimeout(() => document.getElementById('reddit-client-id').focus(), 100);
}

function closeRedditModal() {
  document.getElementById('reddit-modal-overlay').classList.remove('open');
}

async function testRedditConnection() {
  const clientId = document.getElementById('reddit-client-id').value.trim();
  const statusEl = document.getElementById('reddit-test-status');
  if (!clientId) { statusEl.textContent = '⚠ Wpisz Client ID'; return; }
  statusEl.textContent = '⏳ Łączenie…';
  const cfg = loadRedditConfig();
  const oldClientId = cfg.clientId;
  cfg.clientId = clientId;
  cfg.token = null;
  saveRedditConfigToStorage(cfg);
  try {
    await getRedditToken();
    statusEl.textContent = '✅ Połączono!';
    statusEl.style.color = '#10b981';
  } catch(e) {
    statusEl.textContent = '❌ ' + e.message;
    statusEl.style.color = '#ef4444';
    cfg.clientId = oldClientId;
    cfg.token = null;
    saveRedditConfigToStorage(cfg);
  }
}

function saveRedditConfig() {
  const clientId = document.getElementById('reddit-client-id').value.trim();
  const cfg = loadRedditConfig();
  cfg.clientId = clientId;
  cfg.token = null;
  cfg.tokenExpiry = null;
  saveRedditConfigToStorage(cfg);
  closeRedditModal();
  updateRedditApiBar();
}

function updateRedditApiBar() {
  const cfg = loadRedditConfig();
  const dot = document.getElementById('reddit-api-dot');
  const sub = document.getElementById('reddit-api-sub');
  const btn = document.getElementById('reddit-api-config-btn');
  if (!dot || !sub || !btn) return;
  if (cfg.clientId) {
    dot.classList.add('active');
    sub.textContent = `Client ID: ${cfg.clientId.slice(0,6)}… · token ${cfg.tokenExpiry && Date.now() < cfg.tokenExpiry ? 'ważny' : 'wygasły'}`;
    btn.textContent = 'Edytuj';
    btn.className = 'reddit-api-btn edit';
  } else {
    dot.classList.remove('active');
    sub.textContent = 'Nie skonfigurowano — wyniki będą symulowane';
    btn.textContent = 'Skonfiguruj';
    btn.className = 'reddit-api-btn setup';
  }
}

// =====================
// GOOGLE CUSTOM SEARCH API
// =====================
function loadGoogleConfig() {
  return JSON.parse(localStorage.getItem('lh_google') || JSON.stringify({ apiKey: '', cx: '' }));
}
function saveGoogleConfigToStorage(cfg) {
  localStorage.setItem('lh_google', JSON.stringify(cfg));
}

async function searchGoogleAPI(query) {
  const cfg = loadGoogleConfig();
  if (!cfg.apiKey || !cfg.cx) return [];
  const sources = SOURCES.filter(s => s.enabled && (s.engine === 'google' || s.engine === 'google_site'));
  if (!sources.length) return [];

  const fetches = sources.map(async s => {
    const domain = s.baseUrl ? s.baseUrl.replace(/https?:\/\/(www\.)?/, '').split('/')[0] : '';
    let url = `https://www.googleapis.com/customsearch/v1?key=${encodeURIComponent(cfg.apiKey)}&cx=${encodeURIComponent(cfg.cx)}&q=${encodeURIComponent(query)}&num=5`;
    if (s.engine === 'google_site' && domain) url += `&siteSearch=${encodeURIComponent(domain)}`;
    try {
      const resp = await fetch(url);
      if (!resp.ok) return [];
      const data = await resp.json();
      return (data.items || []).map(item => ({
        id: item.cacheId || item.link,
        source: s.name,
        icon: s.icon,
        color: s.color,
        type: s.type,
        title: item.title,
        url: item.link,
        snippet: (item.snippet || '').replace(/\n/g, ' ').slice(0, 220),
        date: new Date().toLocaleDateString('pl-PL'),
        keyword: query,
        relevance: Math.min(97, 72 + Math.floor(Math.random() * 20)),
        isReal: true
      }));
    } catch(e) { return []; }
  });

  const results = await Promise.allSettled(fetches);
  return results.flatMap(r => r.status === 'fulfilled' ? r.value : []);
}

function openGoogleModal() {
  const cfg = loadGoogleConfig();
  document.getElementById('google-api-key').value = cfg.apiKey || '';
  document.getElementById('google-cx').value = cfg.cx || '';
  document.getElementById('google-test-status').textContent = '';
  document.getElementById('google-modal-overlay').classList.add('open');
  setTimeout(() => document.getElementById('google-api-key').focus(), 100);
}

function closeGoogleModal() {
  document.getElementById('google-modal-overlay').classList.remove('open');
}

async function testGoogleConnection() {
  const apiKey = document.getElementById('google-api-key').value.trim();
  const cx = document.getElementById('google-cx').value.trim();
  const statusEl = document.getElementById('google-test-status');
  if (!apiKey) { statusEl.textContent = '⚠ Wpisz klucz API'; return; }
  if (!cx) { statusEl.textContent = '⚠ Wpisz identyfikator CX'; return; }
  statusEl.textContent = '⏳ Łączenie…';
  statusEl.style.color = 'var(--text-dim)';
  try {
    const url = `https://www.googleapis.com/customsearch/v1?key=${encodeURIComponent(apiKey)}&cx=${encodeURIComponent(cx)}&q=test&num=1`;
    const resp = await fetch(url);
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.error?.message || 'HTTP ' + resp.status);
    statusEl.textContent = '✅ Połączono!';
    statusEl.style.color = '#10b981';
  } catch(e) {
    statusEl.textContent = '❌ ' + e.message;
    statusEl.style.color = '#ef4444';
  }
}

function saveGoogleConfig() {
  const apiKey = document.getElementById('google-api-key').value.trim();
  const cx = document.getElementById('google-cx').value.trim();
  saveGoogleConfigToStorage({ apiKey, cx });
  closeGoogleModal();
  updateGoogleApiBar();
}

function updateGoogleApiBar() {
  const cfg = loadGoogleConfig();
  const dot = document.getElementById('google-api-dot');
  const sub = document.getElementById('google-api-sub');
  const btn = document.getElementById('google-api-config-btn');
  if (!dot || !sub || !btn) return;
  if (cfg.apiKey && cfg.cx) {
    dot.classList.add('active');
    sub.textContent = `Klucz: ${cfg.apiKey.slice(0,8)}… · CX: ${cfg.cx.slice(0,10)}…`;
    btn.textContent = 'Edytuj';
    btn.className = 'google-api-btn edit';
  } else {
    dot.classList.remove('active');
    sub.textContent = 'Nie skonfigurowano — wyniki będą symulowane';
    btn.textContent = 'Skonfiguruj';
    btn.className = 'google-api-btn setup';
  }
}

// =====================
// SAVED LEADS
// =====================
function renderSaved() {
  const list = document.getElementById('saved-list');
  const empty = document.getElementById('saved-empty');
  if (!savedLeads.length) {
    list.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';
  list.innerHTML = `
    <div class="results-header">
      <div class="results-title">Zapisane leady</div>
      <div class="results-meta">${savedLeads.length} leadów · <button onclick="clearSaved()" style="background:none;border:none;cursor:pointer;color:var(--red);font-size:0.72rem;font-family:'Outfit',sans-serif">Wyczyść wszystkie</button></div>
    </div>
    ${savedLeads.map((r, i) => `
    <div class="result-item" style="animation-delay:${i*40}ms">
      <div class="result-source-icon" style="background:${r.color||'#e8f0fc'}">${r.icon}</div>
      <div class="result-body">
        <div class="result-source-label">${r.source} ${typeBadge(r.type)} <span class="saved-badge">✅ Zapisano ${r.savedAt}</span></div>
        <div class="result-title"><a href="${r.url}" target="_blank">${r.title}</a></div>
        <div class="result-snippet">${r.snippet}</div>
        <div class="result-footer">
          <span class="result-date">📅 ${r.date}</span>
          <span class="result-keyword-tag">🏷 ${r.keyword}</span>
          <div class="result-actions">
            <button class="result-btn" onclick="copyLink('${r.url}', this)">📋 Kopiuj</button>
            <button class="result-btn" style="color:var(--red);border-color:rgba(192,57,43,0.3)" onclick="removeLead(${r.id}, this)">🗑 Usuń</button>
          </div>
        </div>
      </div>
    </div>
  `).join('')}`;
}

function removeLead(id, btn) {
  savedLeads = savedLeads.filter(l => l.id !== id);
  localStorage.setItem('lh_saved', JSON.stringify(savedLeads));
  document.getElementById('saved-count').textContent = savedLeads.length;
  renderSaved();
}

function clearSaved() {
  if (!confirm('Usunąć wszystkie zapisane leady?')) return;
  savedLeads = [];
  localStorage.setItem('lh_saved', JSON.stringify(savedLeads));
  document.getElementById('saved-count').textContent = '0';
  renderSaved();
}

// =====================
// SOURCE SEARCH
// =====================
function openSrcSearchModal() {
  document.getElementById('src-search-results').innerHTML = '';
  document.getElementById('src-paste-area').value = '';
  document.getElementById('src-search-modal-overlay').classList.add('open');
  setTimeout(() => document.getElementById('src-search-keyword').focus(), 80);
}

function closeSrcSearchModal() {
  document.getElementById('src-search-modal-overlay').classList.remove('open');
}

function buildSourceQuery() {
  const kw = document.getElementById('src-search-keyword').value.trim() || '…';
  return `szukam osób poszukujących ${kw} wynik prezentuj w postaci nazwy źródła, pełnego linku (http://www. lub https://www) i krótkiego opisu w jednym zdaniu oraz znaczka [+] po każdym źródle.`;
}

function openGoogleAISearch() {
  const query = buildSourceQuery();
  const url = 'https://www.google.com/search?udm=50&q=' + encodeURIComponent(query);
  window.open(url, '_blank');
}

function copySourceQuery() {
  const query = buildSourceQuery();
  navigator.clipboard.writeText(query).then(() => {
    const btn = document.querySelector('.src-search-copy-btn');
    const orig = btn.textContent;
    btn.textContent = '✓ Skopiowano!';
    setTimeout(() => btn.textContent = orig, 1800);
  });
}

function analyzeSourceResults() {
  const text = document.getElementById('src-paste-area').value.trim();
  if (!text) return;
  const container = document.getElementById('src-search-results');

  // Split on [+] — each chunk is one source entry
  const chunks = text.split(/\[\+\]/gi).map(c => c.trim()).filter(Boolean);
  if (!chunks.length) {
    container.innerHTML = '<div style="font-size:0.78rem;color:var(--text-dim);padding:8px 0">Nie znaleziono wyników w formacie z [+]. Upewnij się, że wkleiłeś odpowiedź Google AI.</div>';
    return;
  }

  const parsed = [];
  chunks.forEach(chunk => {
    // Remove leading bullets/numbers/markdown
    chunk = chunk.replace(/^\s*[\*\-\d\.\)]+\s*/, '').replace(/\*\*/g, '').trim();
    const urlMatch = chunk.match(/https?:\/\/[^\s,;\)]+/);
    if (!urlMatch) return;
    const url = urlMatch[0].replace(/[.,;)]+$/, '');
    const urlIdx = chunk.indexOf(urlMatch[0]);
    const namePart = chunk.substring(0, urlIdx).replace(/[,\-:]+$/, '').trim();
    const descPart = chunk.substring(urlIdx + urlMatch[0].length).replace(/^[,\-:\s]+/, '').trim();
    if (!namePart && !descPart) return;
    parsed.push({
      name: (namePart || url.replace(/https?:\/\/(www\.)?/, '').split('/')[0]).substring(0, 80),
      url,
      desc: descPart.substring(0, 220)
    });
  });

  if (!parsed.length) {
    container.innerHTML = '<div style="font-size:0.78rem;color:var(--text-dim);padding:8px 0">Nie udało się wyodrębnić źródeł. Sprawdź format wklejonego tekstu.</div>';
    return;
  }

  container.innerHTML = parsed.map((r, i) => `
    <div class="src-result-card" id="src-res-${i}">
      <div class="src-result-info">
        <div class="src-result-name">${r.name}</div>
        <div class="src-result-url">${r.url}</div>
        ${r.desc ? `<div class="src-result-desc">${r.desc}</div>` : ''}
      </div>
      <button class="src-result-add" id="src-add-btn-${i}" onclick="addSourceFromSearch(${i},'${encodeURIComponent(r.name)}','${encodeURIComponent(r.url)}')" title="Dodaj źródło">+</button>
    </div>`).join('');

  // Store parsed for later use
  window._srcSearchParsed = parsed;
}

function addSourceFromSearch(idx, encodedName, encodedUrl) {
  const name = decodeURIComponent(encodedName);
  const url  = decodeURIComponent(encodedUrl);
  const btn  = document.getElementById(`src-add-btn-${idx}`);

  // Mark as added
  btn.textContent = '✓';
  btn.classList.add('added');
  btn.disabled = true;

  // Pre-fill add source modal
  closeSrcSearchModal();
  document.getElementById('new-name').value = name;
  document.getElementById('new-baseurl').value = url;
  document.getElementById('new-url').value = '';
  document.getElementById('new-icon').value = '🌐';
  document.getElementById('new-engine').value = 'google_site';
  renderNewSourceKwPicker();
  document.getElementById('modal-overlay').classList.add('open');
  setTimeout(() => document.getElementById('new-name').select(), 80);
}

document.getElementById('src-search-modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeSrcSearchModal();
});

// =====================
// ADD SOURCE MODAL
// =====================
function openAddModal() {
  renderNewSourceKwPicker();
  document.getElementById('modal-overlay').classList.add('open');
  document.getElementById('new-name').focus();
}

function renderNewSourceKwPicker() {
  const picker = document.getElementById('new-kw-sets-picker');
  if (!KEYWORD_SETS.length) {
    picker.innerHTML = '<div style="padding:10px 12px;font-size:0.72rem;color:var(--text-dim)">Brak zestawów — dodaj je w zakładce Frazy i słowa kluczowe.</div>';
    return;
  }
  picker.innerHTML = KEYWORD_SETS.map(ks => `
    <label class="kw-source-row">
      <input type="checkbox" class="new-kw-cb" data-id="${ks.id}">
      <span class="kw-src-name">${ks.name}</span>
      <span style="font-size:0.62rem;color:var(--text-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px">${ks.phrases.slice(0,3).join(', ')}${ks.phrases.length > 3 ? '…' : ''}</span>
    </label>`).join('');
}
function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
}
function saveNewSource() {
  const name = document.getElementById('new-name').value.trim();
  if (!name) { document.getElementById('new-name').focus(); return; }
  const type = document.getElementById('new-type').value;
  const engine = document.getElementById('new-engine').value;
  const baseUrl = document.getElementById('new-baseurl').value.trim();
  const url = document.getElementById('new-url').value.trim();
  const icon = document.getElementById('new-icon').value.trim() || '🌐';
  const apiUrl = document.getElementById('new-api-url').value.trim();
  const apiKey = document.getElementById('new-api-key').value.trim();
  const colorMap = { forum:'#e8f0fc', social:'#fde8f0', portal:'#e8f5ee', ogloszenia:'#fef3e2', it:'#f0e8fc', biznes:'#e8f5f5' };
  const newId = nextId++;

  // Nowe źródło z pełną konfiguracją
  SOURCES.push({
    id: newId,
    name,
    type,
    icon,
    color: colorMap[type],
    enabled: true,
    baseUrl,
    engine,
    apiUrl,
    apiKey,
    subforums: url ? [url] : [''],
    keywords: '',
    desc: '',
    favorite: false,
    dateAdded: new Date().toISOString().split('T')[0],
    loginRequired: true
  });
  saveSources();

  // Przypisz zaznaczone zestawy fraz
  const selectedKwIds = [...document.querySelectorAll('.new-kw-cb:checked')].map(cb => parseInt(cb.dataset.id));
  selectedKwIds.forEach(kwId => {
    const ks = KEYWORD_SETS.find(k => k.id === kwId);
    if (ks) ks.links.push({ sourceId: newId, subforum: url || '' });
  });
  if (selectedKwIds.length) {
    saveKeywordSets();
    syncKeywordSetsToSources();
  }

  closeModal();
  document.getElementById('new-name').value = '';
  document.getElementById('new-baseurl').value = '';
  document.getElementById('new-url').value = '';
  document.getElementById('new-icon').value = '';
  document.getElementById('new-engine').value = 'internal';
  document.getElementById('new-api-url').value = '';
  document.getElementById('new-api-key').value = '';
  document.getElementById('new-api-fields').style.display = 'none';
  renderSources();
  renderSourcesManage();

  // Navigate to search page and highlight the new card
  ['search','saved','sources'].forEach(p => {
    document.getElementById(`page-${p}`).style.display = p === 'search' ? 'block' : 'none';
  });
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  document.querySelector('.nav-item').classList.add('active');
  document.getElementById('page-title').textContent = 'Szukaj klientów';
  document.getElementById('page-subtitle').textContent = 'Przeszukuj fora i serwisy społecznościowe';

  // Scroll to and flash the new card
  setTimeout(() => {
    // Źródło jest dodawane jako ulubione jeśli favorite=false, więc będzie w sekcji "Pozostałe źródła"
    const card = document.getElementById(`scard-${newId}`);
    if (!card) return;
    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    card.style.transition = 'box-shadow 0.3s, outline 0.3s';
    card.style.outline = '2px solid var(--accent)';
    card.style.boxShadow = '0 0 0 4px rgba(232,93,38,0.2)';
    setTimeout(() => {
      card.style.outline = '';
      card.style.boxShadow = '';
    }, 2000);
  }, 120);
}

function deleteSource(id) {
  const s = SOURCES.find(x => x.id === id);
  if (!s) return;
  if (!confirm(`Usunąć źródło „${s.name}"?`)) return;
  const idx = SOURCES.indexOf(s);
  if (idx !== -1) SOURCES.splice(idx, 1);
  saveSources();
  renderSourcesManage();
  renderEngines();
}

function cloneSource(id) {
  const s = SOURCES.find(x => x.id === id);
  if (!s) return;
  const newId = nextId++;
  const clone = {
    ...s,
    id: newId,
    name: s.name + ' (kopia)',
    favorite: false,
    dateAdded: new Date().toISOString().split('T')[0],
    subforums: s.subforums ? [...s.subforums] : [''],
  };
  SOURCES.push(clone);
  saveSources();
  renderSources();
  renderSourcesManage();
  setTimeout(() => {
    const card = document.getElementById(`scard-${newId}`);
    if (!card) return;
    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    card.style.outline = '2px solid var(--accent)';
    card.style.boxShadow = '0 0 0 4px rgba(232,93,38,0.2)';
    setTimeout(() => { card.style.outline = ''; card.style.boxShadow = ''; }, 2000);
  }, 120);
}

// =====================
// IMPORT / EXPORT
// =====================
function exportSources() {
  const data = {
    version: 3,
    exportedAt: new Date().toISOString(),
    sources: SOURCES,
    keywordSets: KEYWORD_SETS,
    credentials: loadCreds(),
    scripts: SCRIPTS,
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = `klienthunter-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importSources() {
  const input = document.createElement('input');
  input.type   = 'file';
  input.accept = '.json';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      let parsed;
      try {
        parsed = JSON.parse(ev.target.result);
      } catch (err) {
        alert('Błąd importu: nieprawidłowy plik JSON.');
        return;
      }

      const importedSources  = Array.isArray(parsed) ? parsed : (parsed.sources || []);
      const importedKwSets   = parsed.keywordSets || null;
      const importedCreds    = parsed.credentials || null;
      const importedScripts  = parsed.scripts || null;

      try {
        if (!Array.isArray(importedSources) || importedSources.length === 0) throw new Error('Brak źródeł w pliku');
        importedSources.forEach(s => {
          if (typeof s.id === 'undefined' || typeof s.name === 'undefined') throw new Error('Nieprawidłowy format źródeł');
        });
      } catch (err) {
        alert('Błąd importu: ' + err.message + '\nUpewnij się, że plik pochodzi z eksportu KlientHunter.');
        return;
      }

      let summary = `Znaleziono w pliku:\n• ${importedSources.length} źródeł`;
      if (importedKwSets)   summary += `\n• ${importedKwSets.length} zestawów fraz`;
      if (importedCreds)    summary += `\n• ${Object.keys(importedCreds).length} loginów`;
      if (importedScripts)  summary += `\n• ${importedScripts.length} skryptów`;
      summary += '\n\nOK → Dołącz źródła do istniejących\nAnuluj → Zastąp wszystkie źródła';

      const appendMode = confirm(summary);

      // --- Źródła ---
      if (appendMode) {
        importedSources.forEach(s => {
          const newId = nextId++;
          SOURCES.push({ desc: '', ...s, id: newId, dateAdded: s.dateAdded || new Date().toISOString().split('T')[0] });
        });
      } else {
        SOURCES.length = 0;
        importedSources.forEach(s => SOURCES.push({ desc: '', ...s }));
        nextId = Math.max(...SOURCES.map(s => s.id), 0) + 1;
      }
      saveSources();

      // --- Zestawy fraz (zastąp) ---
      if (importedKwSets) {
        KEYWORD_SETS.splice(0, KEYWORD_SETS.length, ...importedKwSets);
        saveKeywordSets();
        syncKeywordSetsToSources();
      }

      // --- Loginy (scala z istniejącymi) ---
      if (importedCreds) {
        const existing = loadCreds();
        saveCreds({ ...existing, ...importedCreds });
      }

      // --- Skrypty (zastąp) ---
      if (importedScripts) {
        SCRIPTS.splice(0, SCRIPTS.length, ...importedScripts);
        scriptNextId = SCRIPTS.length ? Math.max(...SCRIPTS.map(s => s.id)) + 1 : 1;
        saveScripts();
      }

      renderSources();
      renderSourcesManage();
      if (importedKwSets)  renderKeywords();
      if (importedCreds)   renderCredentials();
      if (importedScripts) renderScripts();
    };
    reader.readAsText(file);
  };
  input.click();
}

document.getElementById('kw-modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeKwModal();
});
document.getElementById('modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
document.getElementById('login-modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeLoginModal();
});
document.getElementById('src-cred-modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeSrcCredModal();
});
document.getElementById('reddit-modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeRedditModal();
});
document.getElementById('google-modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeGoogleModal();
});

// =====================
// SOURCE CREDENTIALS
// =====================
function getCredsKey() {
  // Per-user storage key
  const uid = currentUser ? currentUser.email : '__guest__';
  return `lh_creds_${uid}`;
}

function loadCreds() {
  return JSON.parse(localStorage.getItem(getCredsKey()) || '{}');
}

function saveCreds(creds) {
  localStorage.setItem(getCredsKey(), JSON.stringify(creds));
}

function getSourceCred(sourceId) {
  const creds = loadCreds();
  return creds[sourceId] || null;
}

function srcLoginBtnHTML(sourceId) {
  const cred = getSourceCred(sourceId);
  if (cred) {
    return `<button class="src-login-btn logged-in" onclick="openSrcCredModal(${sourceId})" title="Zalogowany jako: ${cred.login}\nKliknij aby zmienić lub usunąć">
      <div class="src-lamp on"></div> ${cred.login}
    </button>`;
  }
  return `<button class="src-login-btn" onclick="openSrcCredModal(${sourceId})">
    <div class="src-lamp off"></div> Dodaj login
  </button>`;
}

let srcCredEditingId = null;

function openSrcCredModal(sourceId) {
  if (!currentUser) {
    alert('Zaloguj się do systemu, aby zarządzać loginami do źródeł.');
    return;
  }
  srcCredEditingId = sourceId;
  const s = SOURCES.find(x => x.id === sourceId);
  const cred = getSourceCred(sourceId);

  document.getElementById('src-cred-info').innerHTML = `
    <div class="src-cred-icon" style="background:${s.color||'#e8f0fc'}">${s.icon}</div>
    <div>
      <div class="src-cred-name">${s.name}</div>
      <div class="src-cred-url">${s.baseUrl || ''}</div>
    </div>`;
  document.getElementById('src-cred-login').value = cred ? cred.login : '';
  document.getElementById('src-cred-pass').value  = cred ? cred.pass  : '';
  document.getElementById('src-cred-pass').type = 'password';
  document.getElementById('pass-toggle-btn').textContent = '👁';
  document.getElementById('src-cred-modal-overlay').classList.add('open');
  setTimeout(() => document.getElementById('src-cred-login').focus(), 100);
}

function closeSrcCredModal() {
  document.getElementById('src-cred-modal-overlay').classList.remove('open');
  srcCredEditingId = null;
}

function togglePassVis() {
  const inp = document.getElementById('src-cred-pass');
  const btn = document.getElementById('pass-toggle-btn');
  if (inp.type === 'password') { inp.type = 'text'; btn.textContent = '🙈'; }
  else { inp.type = 'password'; btn.textContent = '👁'; }
}

function updateCredsBadge() {
  if (!currentUser) {
    document.getElementById('creds-count').style.display = 'none';
    return;
  }
  const count = Object.keys(loadCreds()).length;
  const badge = document.getElementById('creds-count');
  badge.textContent = count;
  badge.style.display = count > 0 ? 'inline-flex' : 'none';
}

function saveSrcCred() {
  const login = document.getElementById('src-cred-login').value.trim();
  const pass  = document.getElementById('src-cred-pass').value;
  if (!login) { document.getElementById('src-cred-login').focus(); return; }
  const creds = loadCreds();
  creds[srcCredEditingId] = { login, pass };
  saveCreds(creds);
  closeSrcCredModal();
  updateCredsBadge();
  // refresh all views
  if (document.getElementById('page-sources').style.display !== 'none') renderSourcesManage();
  if (document.getElementById('page-credentials').style.display !== 'none') renderCredentials();
}

function clearSrcCred(sourceId) {
  if (!confirm('Usunąć dane logowania dla tego źródła?')) return;
  const creds = loadCreds();
  delete creds[sourceId];
  saveCreds(creds);
  updateCredsBadge();
  renderCredentials();
  if (document.getElementById('page-sources').style.display !== 'none') renderSourcesManage();
}

let credsGroupBy = 'status';

function setCredsGroup(mode, btn) {
  if (credsGroupBy === mode) {
    credsGroupBy = 'none';
    btn.classList.remove('active');
  } else {
    credsGroupBy = mode;
    document.querySelectorAll('#cg-btn-status,#cg-btn-name').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }
  renderCredentials();
}

function renderCredentials() {
  const container = document.getElementById('creds-content');
  const notice = document.getElementById('creds-notice');

  if (!currentUser) {
    notice.style.display = 'flex';
    container.innerHTML = `<div class="empty-state"><div class="icon">🔐</div><h3>Wymagane logowanie</h3><p>Zaloguj się do systemu (przycisk w prawym górnym rogu),<br>aby zarządzać loginami do poszczególnych źródeł.</p></div>`;
    return;
  }

  notice.style.display = 'none';
  ['status','name'].forEach(m => {
    const b = document.getElementById('cg-btn-'+m);
    if (b) b.classList.toggle('active', credsGroupBy === m);
  });
  const creds = loadCreds();
  const initials = currentUser.name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);

  function makeRow(s) {
    const cred = creds[s.id];
    const maskedPass = cred && cred.pass ? '•'.repeat(Math.min(cred.pass.length, 10)) : '';
    return `
      <tr>
        <td><div class="slt-icon" style="background:${s.color||'#e8f0fc'}">${s.icon}</div></td>
        <td>
          <div class="creds-source-name">${s.name}</div>
          ${s.baseUrl ? `<a class="source-base-url" href="${s.baseUrl}" target="_blank">🔗 ${s.baseUrl.replace('https://','').replace('www.','')}</a>` : ''}
        </td>
        <td>${cred ? `<span class="creds-login-val">${cred.login}</span>` : '<span class="creds-empty">—</span>'}</td>
        <td>${cred && cred.pass ? `<span class="creds-pass-val">${maskedPass}</span>` : '<span class="creds-empty">—</span>'}</td>
        <td>
          ${cred
            ? `<span class="creds-status set">● Skonfigurowane</span>`
            : `<span class="creds-status unset">○ Brak</span>`}
        </td>
        <td style="white-space:nowrap">
          <button class="creds-edit-btn" onclick="openSrcCredModal(${s.id})">${cred ? '✏ Zmień' : '+ Dodaj'}</button>
          ${cred ? `<button class="creds-clear-btn" onclick="clearSrcCred(${s.id})">🗑</button>` : ''}
        </td>
      </tr>`;
  }

  function makeGroupHeader(label, count, extraClass) {
    return `<tr class="creds-group-header${extraClass ? ' '+extraClass : ''}"><td colspan="6"><span class="creds-group-label">${label}</span><span class="creds-group-count">${count}</span></td></tr>`;
  }

  let rows = '';
  if (credsGroupBy === 'status') {
    const loggedIn  = SOURCES.filter(s => creds[s.id]);
    const loggedOut = SOURCES.filter(s => !creds[s.id]);
    if (loggedIn.length) {
      rows += makeGroupHeader('Zalogowane', loggedIn.length, 'status-set');
      rows += loggedIn.map(makeRow).join('');
    }
    if (loggedOut.length) {
      rows += makeGroupHeader('Niezalogowane', loggedOut.length, 'status-unset');
      rows += loggedOut.map(makeRow).join('');
    }
  } else if (credsGroupBy === 'name') {
    const nameMap = {};
    SOURCES.forEach(s => {
      if (!nameMap[s.name]) nameMap[s.name] = [];
      nameMap[s.name].push(s);
    });
    Object.entries(nameMap).sort((a,b) => a[0].localeCompare(b[0], 'pl')).forEach(([name, sources]) => {
      rows += makeGroupHeader(name, sources.length);
      rows += sources.map(makeRow).join('');
    });
  } else {
    rows = SOURCES.map(makeRow).join('');
  }

  container.innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
      <div class="login-avatar" style="width:30px;height:30px;font-size:0.75rem">${initials}</div>
      <div>
        <div style="font-weight:700;font-size:0.85rem">${currentUser.name}</div>
        <div style="font-size:0.65rem;font-family:'JetBrains Mono',monospace;color:var(--text-dim)">${currentUser.email}</div>
      </div>
    </div>
    <table class="creds-table">
      <thead><tr>
        <th style="width:44px"></th>
        <th>Źródło</th>
        <th>Login</th>
        <th>Hasło</th>
        <th>Status</th>
        <th>Akcje</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

// =====================
// KEYWORDS
// =====================
function getDefaultKeywordSets() {
  return [
    {
      id: 10001, name: 'Frazy ogólne',
      phrases: ['szukam', 'potrzebuję', 'polecacie', 'poszukuję', 'pomożecie'],
      links: [
        { sourceId: 1,  subforum: '' },
        { sourceId: 3,  subforum: '' },
        { sourceId: 9,  subforum: 'https://www.olx.pl/uslugi/' },
        { sourceId: 11, subforum: 'https://reddit.com/r/Polska/' },
        { sourceId: 12, subforum: '' },
      ]
    },
    {
      id: 10002, name: 'Frazy IT i programowanie',
      phrases: ['szukam', 'potrzebuję', 'pomoc', 'oferta', 'zlecę', 'szukam wykonawcy'],
      links: [
        { sourceId: 2,  subforum: 'https://4programmers.net/Forum/Praca' },
        { sourceId: 2,  subforum: 'https://4programmers.net/Forum/Oferty' },
        { sourceId: 11, subforum: 'https://reddit.com/r/PracaIT/' },
        { sourceId: 13, subforum: 'https://freelancer.pl/zlecenia/' },
      ]
    },
    {
      id: 10003, name: 'Frazy biznesowe',
      phrases: ['szukam dostawcy', 'polecacie firmę', 'potrzebuję usługi', 'firma'],
      links: [
        { sourceId: 4, subforum: 'https://forum.bankier.pl/' },
      ]
    },
    {
      id: 10004, name: 'Frazy prawne',
      phrases: ['szukam prawnika', 'potrzebuję porady', 'pomoc prawna'],
      links: [
        { sourceId: 15, subforum: '' },
      ]
    },
    {
      id: 10005, name: 'Frazy rekrutacja i praca',
      phrases: ['szukam', 'hiring', 'rekrutacja', 'oferta', 'looking for', 'need vendor'],
      links: [
        { sourceId: 5, subforum: '' },
        { sourceId: 6, subforum: '' },
      ]
    },
    {
      id: 10006, name: 'Frazy edukacja i szkolenia',
      phrases: ['szukam szkolenia', 'potrzebuję kursu', 'szukam kursu'],
      links: [
        { sourceId: 14, subforum: '' },
      ]
    },
  ];
}

let KEYWORD_SETS = (() => {
  const stored = localStorage.getItem('lh_kw_sets');
  if (stored) return JSON.parse(stored);
  const defaults = getDefaultKeywordSets();
  localStorage.setItem('lh_kw_sets', JSON.stringify(defaults));
  return defaults;
})();
let editingKwId = null;

function saveKeywordSets() {
  localStorage.setItem('lh_kw_sets', JSON.stringify(KEYWORD_SETS));
}

function syncKeywordSetsToSources() {
  SOURCES.forEach(src => {
    const linked = KEYWORD_SETS.filter(ks => ks.links.some(l => l.sourceId === src.id));
    if (!linked.length) return;
    const merged = [...new Set(linked.flatMap(ks => ks.phrases))];
    src.keywords = merged.join(', ');
  });
}

function getSourceKwSetsHTML(sourceId) {
  const linked = KEYWORD_SETS.filter(ks => ks.links.some(l => l.sourceId === sourceId));
  if (!linked.length)
    return `<span style="font-size:0.7rem;color:var(--text-dim);font-style:italic">Brak — dodaj w zakładce Frazy i słowa kluczowe</span>`;
  return linked.map(ks => `<span class="kw-phrase" style="margin-right:3px;margin-bottom:3px">${ks.name}</span>`).join('');
}

syncKeywordSetsToSources();

function renderQuickQueries() {
  const container = document.getElementById('quick-queries-list');
  if (!container) return;
  const favIds = new Set(SOURCES.filter(s => s.favorite && s.enabled).map(s => s.id));
  const sets = KEYWORD_SETS.filter(ks => ks.links.some(l => favIds.has(l.sourceId)));
  if (!sets.length) {
    container.innerHTML = `<div style="padding:3px 12px 6px;font-size:0.7rem;color:var(--text-dim);font-style:italic;line-height:1.4">Oznacz źródło jako ulubione i przypisz do niego zestaw fraz</div>`;
    return;
  }
  const icons = ['🔍','📌','💡','🎯','⚡','🔎','📢','🏷️'];
  container.innerHTML = sets.map((ks, i) => {
    const phrase = ks.phrases[0] || ks.name;
    const icon = icons[i % icons.length];
    const safePhrase = phrase.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    return `<button class="nav-item" onclick="quickSearch('${safePhrase}')" title="${ks.phrases.join(', ')}">
      <span class="nav-icon">${icon}</span> ${ks.name}
    </button>`;
  }).join('');
}

function renderKeywords() {
  const container = document.getElementById('keywords-content');
  if (!KEYWORD_SETS.length) {
    container.innerHTML = `<div class="empty-state"><div class="icon">🏷️</div><h3>Brak zestawów fraz</h3><p>Kliknij „+ Dodaj zestaw" aby stworzyć pierwszy zestaw słów kluczowych.</p></div>`;
    return;
  }
  const cards = KEYWORD_SETS.map(set => {
    const shown = set.phrases.slice(0, 6).map(p => `<span class="kw-phrase">${p}</span>`).join('');
    const more  = set.phrases.length > 6 ? `<span class="kw-phrase kw-phrase-more">+${set.phrases.length - 6} więcej</span>` : '';
    const linkedRows = set.links.map(l => {
      const src = SOURCES.find(s => s.id === l.sourceId);
      if (!src) return '';
      const sub = l.subforum
        ? l.subforum.replace(/https?:\/\/(www\.)?/,'').replace(/\/$/,'').split('/').slice(-2).join('/')
        : 'Wszystkie podlinki';
      return `<div class="kw-link-row">
        <div class="slt-icon" style="background:${src.color||'#e8f0fc'};width:20px;height:20px;font-size:0.65rem;flex-shrink:0">${src.icon}</div>
        <span class="kw-link-name">${src.name}</span>
        <span class="kw-link-sub" title="${l.subforum||''}">${sub}</span>
      </div>`;
    }).join('');
    return `
      <div class="kw-card">
        <div class="kw-card-header">
          <span class="kw-card-name" title="${set.name}">${set.name}</span>
          <div class="kw-card-actions">
            <button class="creds-edit-btn" onclick="openKwModal(${set.id})">✏ Edytuj</button>
            <button class="creds-clear-btn" onclick="deleteKwSet(${set.id})">🗑</button>
          </div>
        </div>
        <div class="kw-card-body">
          <div>
            <div class="kw-section-label">Frazy (${set.phrases.length})</div>
            <div class="kw-phrases">${shown}${more}</div>
          </div>
          ${set.links.length
            ? `<div><div class="kw-section-label">Powiązane źródła (${set.links.length})</div>${linkedRows}</div>`
            : '<div class="kw-no-links">Brak powiązanych źródeł</div>'}
        </div>
      </div>`;
  }).join('');
  container.innerHTML = `<div class="kw-card-grid">${cards}</div>`;
}

function openKwModal(id = null) {
  editingKwId = id || null;
  const set = id ? KEYWORD_SETS.find(s => s.id === id) : null;
  document.getElementById('kw-modal-title').textContent = set ? 'Edytuj zestaw fraz' : 'Dodaj zestaw fraz';
  document.getElementById('kw-modal-name').value = set ? set.name : '';
  document.getElementById('kw-modal-phrases').value = set ? set.phrases.join('\n') : '';
  const linksMap = {};
  if (set) set.links.forEach(l => { linksMap[l.sourceId] = l.subforum; });
  const rows = SOURCES.map(s => {
    const checked = s.id in linksMap;
    if (!s.subforums) s.subforums = s.subforum ? [s.subforum] : [''];
    const subs = s.subforums.filter(u => u.trim());
    const opts = ['', ...subs].map(u =>
      `<option value="${u}" ${linksMap[s.id] === u ? 'selected' : ''}>${u ? u.replace(/https?:\/\/(www\.)?/,'').replace(/\/$/,'') : 'Wszystkie podlinki'}</option>`
    ).join('');
    const sel = subs.length
      ? `<select class="kw-sub-select" id="kwsub-${s.id}" style="${checked ? '' : 'display:none'}">${opts}</select>`
      : '';
    return `<label class="kw-source-row">
      <input type="checkbox" class="kw-src-cb" data-id="${s.id}" ${checked ? 'checked' : ''} onchange="toggleKwSource(${s.id})">
      <div class="slt-icon" style="background:${s.color||'#e8f0fc'};width:22px;height:22px;font-size:0.7rem;flex-shrink:0">${s.icon}</div>
      <span class="kw-src-name">${s.name}</span>
      ${sel}
    </label>`;
  }).join('');
  document.getElementById('kw-source-picker').innerHTML = rows;
  document.getElementById('kw-modal-overlay').classList.add('open');
  setTimeout(() => document.getElementById('kw-modal-name').focus(), 80);
}

function toggleKwSource(sourceId) {
  const cb  = document.querySelector(`.kw-src-cb[data-id="${sourceId}"]`);
  const sel = document.getElementById(`kwsub-${sourceId}`);
  if (sel) sel.style.display = cb.checked ? '' : 'none';
}

function saveKwSet() {
  const name = document.getElementById('kw-modal-name').value.trim();
  if (!name) { document.getElementById('kw-modal-name').focus(); return; }
  const phrases = document.getElementById('kw-modal-phrases').value
    .split('\n').map(p => p.trim()).filter(Boolean);
  const links = [];
  document.querySelectorAll('.kw-src-cb:checked').forEach(cb => {
    const sourceId = parseInt(cb.dataset.id);
    const sel = document.getElementById(`kwsub-${sourceId}`);
    links.push({ sourceId, subforum: sel ? sel.value : '' });
  });
  if (editingKwId) {
    const set = KEYWORD_SETS.find(s => s.id === editingKwId);
    if (set) { set.name = name; set.phrases = phrases; set.links = links; }
  } else {
    KEYWORD_SETS.push({ id: Date.now(), name, phrases, links });
  }
  saveKeywordSets();
  syncKeywordSetsToSources();
  closeKwModal();
  renderKeywords();
  renderQuickQueries();
  if (document.getElementById('page-sources').style.display !== 'none') renderSourcesManage();
}

function deleteKwSet(id) {
  if (!confirm('Usunąć ten zestaw fraz?')) return;
  KEYWORD_SETS = KEYWORD_SETS.filter(s => s.id !== id);
  saveKeywordSets();
  syncKeywordSetsToSources();
  renderKeywords();
  renderQuickQueries();
  if (document.getElementById('page-sources').style.display !== 'none') renderSourcesManage();
}

function closeKwModal() {
  document.getElementById('kw-modal-overlay').classList.remove('open');
}

// =====================
// SCRIPTS
// =====================
let SCRIPTS = (() => {
  const stored = localStorage.getItem('lh_scripts');
  return stored ? JSON.parse(stored) : [];
})();
let scriptNextId = SCRIPTS.length ? Math.max(...SCRIPTS.map(s => s.id)) + 1 : 1;
let editingScriptId = null;

function saveScripts() { localStorage.setItem('lh_scripts', JSON.stringify(SCRIPTS)); }

const LANG_META = {
  javascript: { label: 'JS',   cls: 'lang-js',     icon: '⚡' },
  python:     { label: 'Py',   cls: 'lang-python',  icon: '🐍' },
  bash:       { label: 'Bash', cls: 'lang-bash',    icon: '🖥️' },
  curl:       { label: 'cURL', cls: 'lang-curl',    icon: '📡' },
  php:        { label: 'PHP',  cls: 'lang-php',     icon: '🐘' },
  other:      { label: '?',    cls: '',             icon: '📄' },
};

function escapeHtml(str) {
  return (str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function renderScripts() {
  const container = document.getElementById('scripts-content');
  if (!SCRIPTS.length) {
    container.innerHTML = `<div class="empty-state"><div class="icon">📜</div><h3>Brak skryptów</h3><p>Dodaj skrypt powiązany z silnikiem wyszukiwania dla niestandardowych zapytań.</p></div>`;
    return;
  }
  const enginesUsed = [...new Set(SCRIPTS.map(s => s.engine))];
  let html = '';
  enginesUsed.forEach(eng => {
    const meta = ENGINE_META[eng] || { label: eng, color: '#999' };
    const group = SCRIPTS.filter(s => s.engine === eng);
    html += `
      <div class="sources-header" style="margin:14px 0 10px">
        <div style="display:flex;align-items:center;gap:8px">
          <div style="width:9px;height:9px;border-radius:50%;background:${meta.color};box-shadow:0 0 5px ${meta.color}99;flex-shrink:0"></div>
          <span class="sources-title">${meta.label}</span>
          <span class="manage-count">${group.length}</span>
        </div>
      </div>
      <div class="scripts-grid">${group.map(scriptCardHTML).join('')}</div>`;
  });
  container.innerHTML = html;
}

function scriptCardHTML(s) {
  const lang    = LANG_META[s.language] || LANG_META.other;
  const engMeta = ENGINE_META[s.engine] || { label: s.engine, color: '#999' };
  const lines   = (s.code || '').split('\n').length;
  return `
    <div class="script-card" id="sscript-${s.id}">
      <div class="script-card-header">
        <div class="script-card-icon">${lang.icon}</div>
        <div class="script-card-info">
          <div class="script-card-name">${s.name}</div>
          <div class="script-card-badges">
            <span class="engine-badge" style="background:${engMeta.color}22;color:${engMeta.color};border:1px solid ${engMeta.color}44">${engMeta.label}</span>
            <span class="script-lang-badge ${lang.cls}">${lang.label}</span>
            <span class="script-lang-badge" style="opacity:0.7">${s.dateAdded||''}</span>
          </div>
        </div>
        <div class="script-card-actions">
          <button class="script-action-btn" onclick="openScriptModal(${s.id})" title="Edytuj">✏️</button>
          <button class="script-action-btn danger" onclick="deleteScript(${s.id})" title="Usuń">🗑</button>
        </div>
      </div>
      ${s.description ? `<div class="script-desc">${s.description}</div>` : ''}
      ${s.code ? `
      <div class="script-code-wrap">
        <button class="script-code-toggle" id="sct-${s.id}" onclick="toggleScriptCode(${s.id})">
          <span class="chevron">▾</span>&nbsp; Kod · ${lines} ${lines === 1 ? 'linia' : 'linii'}
        </button>
        <div class="script-code-block" id="scb-${s.id}">
          <pre>${escapeHtml(s.code)}</pre>
        </div>
      </div>` : ''}
    </div>`;
}

function toggleScriptCode(id) {
  document.getElementById('sct-' + id).classList.toggle('open');
  document.getElementById('scb-' + id).classList.toggle('open');
}

function openScriptModal(id = null) {
  editingScriptId = id;
  const sel = document.getElementById('script-engine');
  sel.innerHTML = ENGINES.map(e => `<option value="${e.value}">${e.label}</option>`).join('');
  if (id !== null) {
    const s = SCRIPTS.find(x => x.id === id);
    if (!s) return;
    document.getElementById('script-modal-title').textContent = 'Edytuj skrypt';
    document.getElementById('script-name').value     = s.name;
    document.getElementById('script-engine').value   = s.engine;
    document.getElementById('script-language').value = s.language;
    document.getElementById('script-desc').value     = s.description || '';
    document.getElementById('script-code').value     = s.code || '';
  } else {
    document.getElementById('script-modal-title').textContent = 'Dodaj skrypt';
    document.getElementById('script-name').value     = '';
    document.getElementById('script-engine').value   = 'api';
    document.getElementById('script-language').value = 'javascript';
    document.getElementById('script-desc').value     = '';
    document.getElementById('script-code').value     = '';
  }
  document.getElementById('script-modal-overlay').classList.add('open');
  setTimeout(() => document.getElementById('script-name').focus(), 80);
}

function closeScriptModal() {
  document.getElementById('script-modal-overlay').classList.remove('open');
  editingScriptId = null;
}

function saveScript() {
  const name = document.getElementById('script-name').value.trim();
  if (!name) { document.getElementById('script-name').focus(); return; }
  const data = {
    name,
    engine:      document.getElementById('script-engine').value,
    language:    document.getElementById('script-language').value,
    description: document.getElementById('script-desc').value.trim(),
    code:        document.getElementById('script-code').value,
    dateAdded:   new Date().toISOString().split('T')[0],
  };
  if (editingScriptId !== null) {
    const idx = SCRIPTS.findIndex(s => s.id === editingScriptId);
    if (idx >= 0) SCRIPTS[idx] = { ...SCRIPTS[idx], ...data };
  } else {
    SCRIPTS.push({ id: scriptNextId++, ...data });
  }
  saveScripts();
  closeScriptModal();
  renderScripts();
}

function deleteScript(id) {
  if (!confirm('Usunąć ten skrypt?')) return;
  SCRIPTS = SCRIPTS.filter(s => s.id !== id);
  saveScripts();
  renderScripts();
}

document.getElementById('script-modal-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeScriptModal();
});

// =====================
// ENGINES
// =====================
const ENGINE_META = {
  internal:    { label: 'Wewnętrzna wyszukiwarka',      color: '#6c63ff' },
  google:      { label: 'Google Custom Search',          color: '#4285F4' },
  google_site: { label: 'Google Custom Search (site:)',  color: '#34A853' },
  reddit:      { label: 'Reddit API',                   color: '#ff4500' },
  bing:        { label: 'Bing',                         color: '#008272' },
  duckduckgo:  { label: 'DuckDuckGo',                   color: '#DE5833' },
  api:         { label: 'API',                          color: '#10b981' },
};

function deleteEngineSource(id) {
  const s = SOURCES.find(x => x.id === id);
  if (!s) return;
  if (!confirm(`Usunąć źródło „${s.name}"?`)) return;
  const idx = SOURCES.indexOf(s);
  if (idx !== -1) SOURCES.splice(idx, 1);
  saveSources();
  renderEngines();
  renderSources();
}

function renderEngines() {
  const container = document.getElementById('engines-content');
  const order = ['internal','google','google_site','reddit','bing','duckduckgo','api'];
  const redditCfg = loadRedditConfig();
  const googleCfg = loadGoogleConfig();

  const cards = order.map(key => {
    const meta = ENGINE_META[key] || { label: key, color: '#999' };
    const sources = SOURCES.filter(s => (s.engine || 'internal') === key);
    if (!sources.length) return '';

    const rows = sources.map(s => {
      const domain = s.baseUrl ? s.baseUrl.replace('https://','').replace('http://','').replace('www.','').split('/')[0] : '';
      const apiInfo = (s.engine === 'api' && s.apiUrl) ? s.apiUrl.replace('https://','').replace('http://','').split('/')[0] : '';
      return `
        <div class="engine-source-row">
          <div class="engine-source-icon" style="background:${s.color||'#e8f0fc'}">${s.icon}</div>
          <div style="flex:1;min-width:0">
            <div class="engine-source-name">${s.name}</div>
            ${apiInfo ? `<div class="engine-source-url" title="${s.apiUrl}">⚡ ${apiInfo}</div>` : domain ? `<div class="engine-source-url" title="${s.baseUrl}">${domain}</div>` : ''}
          </div>
          <div class="engine-source-status ${s.enabled ? 'on' : 'off'}" title="${s.enabled ? 'Aktywne' : 'Nieaktywne'}"></div>
          <button class="engine-source-del" onclick="deleteEngineSource(${s.id})" title="Usuń źródło">✕</button>
        </div>`;
    }).join('');

    const isReddit = key === 'reddit';
    const isGoogle = key === 'google' || key === 'google_site';
    const apiConfigured = (isReddit && redditCfg.clientId) || (isGoogle && googleCfg.apiKey && googleCfg.cx);
    const cfgBtn = (isReddit || isGoogle)
      ? `<button class="engine-cfg-btn ${apiConfigured ? 'configured' : ''}" onclick="${isReddit ? 'openRedditModal' : 'openGoogleModal'}()" title="${apiConfigured ? 'Skonfigurowano — kliknij aby edytować' : 'Skonfiguruj API'}">🔑</button>`
      : '';

    return `
      <div class="engine-card">
        <div class="engine-card-header">
          <div class="engine-card-dot" style="background:${meta.color};box-shadow:0 0 6px ${meta.color}88"></div>
          <div class="engine-card-name">${meta.label}</div>
          <div class="engine-card-count">${sources.length} źródeł</div>
          ${cfgBtn}
        </div>
        <div class="engine-source-list">${rows}</div>
      </div>`;
  }).join('');

  container.innerHTML = cards
    ? `<div class="engines-grid">${cards}</div>`
    : `<div class="empty-state"><div class="icon">🔎</div><h3>Brak źródeł</h3></div>`;
}

// =====================
// LOGIN
// =====================
let currentUser = JSON.parse(localStorage.getItem('lh_user') || 'null');

function updateLoginUI() {
  const lamp = document.getElementById('login-lamp');
  const label = document.getElementById('login-btn-label');
  if (currentUser) {
    lamp.className = 'login-lamp lamp-logged-in';
    label.textContent = currentUser.name.split(' ')[0];
  } else {
    lamp.className = 'login-lamp lamp-logged-out';
    label.textContent = 'Zaloguj się';
  }
}

function openLoginModal() {
  const overlay = document.getElementById('login-modal-overlay');
  overlay.classList.add('open');
  if (currentUser) {
    document.getElementById('login-form-view').style.display = 'none';
    document.getElementById('login-logged-view').style.display = 'block';
    const initials = currentUser.name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
    document.getElementById('login-avatar').textContent = initials;
    document.getElementById('login-user-name').textContent = currentUser.name;
    document.getElementById('login-user-email').textContent = currentUser.email;
  } else {
    document.getElementById('login-form-view').style.display = 'block';
    document.getElementById('login-logged-view').style.display = 'none';
    setTimeout(() => document.getElementById('login-email').focus(), 100);
  }
}

function closeLoginModal() {
  document.getElementById('login-modal-overlay').classList.remove('open');
  document.getElementById('login-error').style.display = 'none';
}

function doLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass  = document.getElementById('login-password').value;
  const err   = document.getElementById('login-error');
  if (!email || !pass) { err.textContent = 'Uzupełnij email i hasło.'; err.style.display='block'; return; }
  if (pass.length < 4) { err.textContent = 'Hasło jest za krótkie.'; err.style.display='block'; return; }
  // Demo: accept any valid-looking credentials
  const name = email.split('@')[0].replace(/[._]/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
  currentUser = { name, email };
  localStorage.setItem('lh_user', JSON.stringify(currentUser));
  updateLoginUI();
  updateCredsBadge();
  closeLoginModal();
}

function doLogout() {
  currentUser = null;
  localStorage.removeItem('lh_user');
  updateLoginUI();
  updateCredsBadge();
  closeLoginModal();
}

// =====================
// SCHEDULE / AUTOMATION
// =====================
function loadSchedule() {
  return JSON.parse(localStorage.getItem('lh_schedule') || JSON.stringify({
    enabled: false, frequency: 'daily', time: '09:00', query: '', lastRun: null
  }));
}
function saveSchedule(cfg) { localStorage.setItem('lh_schedule', JSON.stringify(cfg)); }

function toggleSchedulePanel(e) {
  e.stopPropagation();
  const panel = document.getElementById('schedule-panel');
  if (!panel.classList.contains('open')) { updateScheduleUI(); }
  panel.classList.toggle('open');
}
function closeSchedulePanel() { document.getElementById('schedule-panel').classList.remove('open'); }

function onSchedToggle(enabled) {
  const cfg = loadSchedule();
  cfg.enabled = enabled;
  saveSchedule(cfg);
  document.getElementById('schedule-btn').classList.toggle('active', enabled);
  if (enabled) {
    requestNotificationPermission();
    startScheduleTimer();
  }
  updateScheduleStatus();
}

function onSchedChange() {
  const cfg = loadSchedule();
  cfg.frequency = document.getElementById('sched-frequency').value;
  cfg.time = document.getElementById('sched-time').value;
  cfg.query = document.getElementById('sched-query').value.trim();
  saveSchedule(cfg);
  document.getElementById('sched-time-row').style.display = cfg.frequency === 'daily' ? '' : 'none';
  updateScheduleStatus();
}

function updateScheduleUI() {
  const cfg = loadSchedule();
  document.getElementById('sched-enabled').checked = cfg.enabled;
  document.getElementById('sched-frequency').value = cfg.frequency;
  document.getElementById('sched-time').value = cfg.time || '09:00';
  document.getElementById('sched-query').value = cfg.query || '';
  document.getElementById('sched-time-row').style.display = cfg.frequency === 'daily' ? '' : 'none';
  document.getElementById('schedule-btn').classList.toggle('active', cfg.enabled);
  updateScheduleStatus();
}

function updateScheduleStatus() {
  const cfg = loadSchedule();
  const favCount = SOURCES.filter(s => s.enabled && s.favorite).length;
  document.getElementById('sched-fav-count').textContent = favCount;

  if (cfg.lastRun) {
    const d = new Date(cfg.lastRun);
    document.getElementById('sched-last-run').textContent = d.toLocaleDateString('pl-PL', { day:'2-digit', month:'2-digit' }) + ' ' + d.toLocaleTimeString('pl-PL', { hour:'2-digit', minute:'2-digit' });
  } else {
    document.getElementById('sched-last-run').textContent = '—';
  }

  if (!cfg.enabled) { document.getElementById('sched-next-run').textContent = 'wyłączone'; return; }
  const next = calcNextRun(cfg);
  if (next) {
    document.getElementById('sched-next-run').textContent = next.toLocaleDateString('pl-PL', { day:'2-digit', month:'2-digit' }) + ' ' + next.toLocaleTimeString('pl-PL', { hour:'2-digit', minute:'2-digit' });
  }
}

function calcNextRun(cfg) {
  const now = new Date();
  const intervals = { hourly: 3600000, every2h: 7200000, every4h: 14400000, every8h: 28800000 };
  if (cfg.frequency === 'daily') {
    const [h, m] = (cfg.time || '09:00').split(':').map(Number);
    const next = new Date(now); next.setHours(h, m, 0, 0);
    if (next <= now) next.setDate(next.getDate() + 1);
    return next;
  }
  const ms = intervals[cfg.frequency] || 3600000;
  const lastRun = cfg.lastRun ? new Date(cfg.lastRun) : now;
  return new Date(lastRun.getTime() + ms);
}

let scheduleTimer = null;
function startScheduleTimer() {
  if (scheduleTimer) clearInterval(scheduleTimer);
  scheduleTimer = setInterval(checkSchedule, 30000); // sprawdzaj co 30s
}

function checkSchedule() {
  const cfg = loadSchedule();
  if (!cfg.enabled) return;
  const now = new Date();
  const lastRun = cfg.lastRun ? new Date(cfg.lastRun) : null;
  const intervals = { hourly: 3600000, every2h: 7200000, every4h: 14400000, every8h: 28800000 };
  let shouldRun = false;

  if (cfg.frequency === 'daily') {
    const [h, m] = (cfg.time || '09:00').split(':').map(Number);
    const target = new Date(now); target.setHours(h, m, 0, 0);
    shouldRun = now >= target && (!lastRun || lastRun < target);
  } else {
    const ms = intervals[cfg.frequency] || 3600000;
    shouldRun = !lastRun || (now - lastRun) >= ms;
  }
  if (shouldRun) runAutoSearch(false);
}

async function runAutoSearch(manual = false) {
  const cfg = loadSchedule();
  const query = cfg.query || document.getElementById('main-query')?.value?.trim() || '';
  if (!query) return;

  // Zapisz czas uruchomienia
  cfg.lastRun = new Date().toISOString();
  saveSchedule(cfg);
  updateScheduleStatus();
  closeSchedulePanel();

  // Przejdź do strony wyszukiwania i uruchom prawdziwe wyszukiwanie
  setQuery(query);
  showPage('search');
  await doSearch();

  // Po zakończeniu — toast z prawdziwymi wynikami
  const total = currentResults.length;
  const hot = currentResults.filter(r => r.relevance >= 88).length;
  const srcCount = SOURCES.filter(s => s.enabled && s.favorite).length;

  if (Notification.permission === 'granted') {
    try {
      new Notification(`🔍 Lead Hunter — ${total} wyników`, {
        body: `Zapytanie: "${query}" · ${hot} gorących leadów`,
        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><text y="28" font-size="28">🎯</text></svg>'
      });
    } catch(e) {}
  }

  showAutoSearchToast(total, hot, query, srcCount, manual);
}

function showAutoSearchToast(total, hot, query, srcCount, manual) {
  const toast = document.getElementById('autosearch-toast');
  document.getElementById('toast-title').textContent = manual ? 'Wyszukiwanie ręczne' : 'Automatyczne wyszukiwanie';
  document.getElementById('toast-body').innerHTML =
    `Znaleziono <strong>${total} wyników</strong> dla frazy „${query}"<br>` +
    `Źródła: <strong>${srcCount} ulubionych</strong> · Gorące leady: <strong>${hot}</strong>`;
  toast.classList.add('visible');
  if (toast._hideTimer) clearTimeout(toast._hideTimer);
  toast._hideTimer = setTimeout(closeToast, 8000);
}

function closeToast() {
  document.getElementById('autosearch-toast').classList.remove('visible');
}

function goToSearchFromToast() {
  closeToast();
  showPage('search');
  document.getElementById('main-query').focus();
}

function requestNotificationPermission() {
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }
}

document.addEventListener('click', function(e) {
  const panel = document.getElementById('schedule-panel');
  const btn   = document.getElementById('schedule-btn');
  if (panel && panel.classList.contains('open') && !btn.contains(e.target) && !panel.contains(e.target)) {
    panel.classList.remove('open');
  }
});

// =====================
// API FIELDS TOGGLE
// =====================
function toggleApiFields(id, engine) {
  const el = document.getElementById('api-fields-' + id);
  if (el) el.style.display = engine === 'api' ? '' : 'none';
}

// =====================
// INFO PANEL
// =====================
function toggleInfoPanel(e) {
  e.stopPropagation();
  const panel = document.getElementById('info-panel');
  panel.classList.toggle('open');
}
function closeInfoPanel() {
  document.getElementById('info-panel').classList.remove('open');
}
function copyIban(el) {
  const iban = el.querySelector('span').textContent.replace(/\s/g, '');
  navigator.clipboard.writeText(iban).then(() => {
    const hint = el.querySelector('.copy-hint');
    hint.textContent = '✅ skopiowano';
    setTimeout(() => { hint.textContent = '📋 kopiuj'; }, 2000);
  });
}
function copyBlik(el) {
  const num = el.querySelector('.blik-number').textContent.replace(/\s/g, '');
  navigator.clipboard.writeText(num).then(() => {
    const hint = el.querySelector('.copy-hint');
    hint.textContent = '✅ skopiowano';
    setTimeout(() => { hint.textContent = '📋 kopiuj'; }, 2000);
  });
}
document.addEventListener('click', function(e) {
  const panel = document.getElementById('info-panel');
  if (panel && panel.classList.contains('open') && !document.getElementById('info-btn').contains(e.target) && !panel.contains(e.target)) {
    panel.classList.remove('open');
  }
});

// =====================
// THEME
// =====================
let currentTheme = localStorage.getItem('lh_theme') || 'light';

function applyTheme(t) {
  currentTheme = t;
  document.documentElement.setAttribute('data-theme', t);
  const icon = document.getElementById('theme-icon');
  if (icon) icon.textContent = t === 'dark' ? '☀️' : '🌙';
  localStorage.setItem('lh_theme', t);
}

function toggleTheme() {
  applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
}

// =====================
// INIT
// =====================
document.addEventListener('DOMContentLoaded', function() {
  applyTheme(currentTheme);
  document.getElementById('saved-count').textContent = savedLeads.length;
  updateLoginUI();
  updateCredsBadge();
  renderSources();
  renderQuickQueries();
  updateScheduleUI();
  const initCfg = loadSchedule();
  if (initCfg.enabled) startScheduleTimer();
});
</script>

<!-- AUTO-SEARCH TOAST -->
<div class="autosearch-toast" id="autosearch-toast">
  <div class="toast-header">
    <span class="toast-icon">🔍</span>
    <span class="toast-title" id="toast-title">Automatyczne wyszukiwanie</span>
    <button class="toast-close" onclick="closeToast()">✕</button>
  </div>
  <div class="toast-body" id="toast-body"></div>
  <div class="toast-actions">
    <button class="toast-btn primary" onclick="goToSearchFromToast()">Zobacz wyniki</button>
    <button class="toast-btn ghost" onclick="closeToast()">Zamknij</button>
  </div>
</div>
</body>
</html>
